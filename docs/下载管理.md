# Electron 文件下载管理器

[![NPM version](https://img.shields.io/npm/v/electron-dl-manager.svg?style=flat-square)](https://www.npmjs.com/package/electron-dl-manager) [![TypeScript](https://img.shields.io/badge/%3C%2F%3E-TypeScript-%230074c1.svg)](http://www.typescriptlang.org/)

一个简单易用的 Electron 应用程序文件下载管理器。
针对 `electron-dl` 的诸多问题而设计，为 Electron 中的文件下载提供了
更强大和可靠的解决方案。

使用场景：

- 从 URL 下载文件
- 获取与下载关联的 ID 以进行跟踪
- 可选择显示"另存为"对话框
- 获取下载进度更新
- 能够取消/暂停/恢复下载
- 支持同时进行多个下载
- 在应用关闭时持久化下载，允许稍后恢复/继续下载

需要 Electron 26.0.0 或更高版本。

```typescript
// 在主进程中
// 这不是一个可工作的示例，只是 API 的演示
import { ElectronDownloadManager } from 'electron-dl-manager';

const manager = new ElectronDownloadManager();

// 开始下载
const id = await manager.download({
  window: browserWindowInstance,
  url: 'https://example.com/file.zip',
  saveDialogOptions: {
    title: '保存文件',
  },
  callbacks: {
    onDownloadStarted: async ({ id, item, webContents }) => {
      // 对下载 ID 执行某些操作
    },
    onDownloadProgress: async (...) => {},
    onDownloadCompleted: async (...) => {},
    onDownloadCancelled: async (...) => {},
    onDownloadInterrupted: async (...) => {},
    onError: (err, data) => {},
  }
});

manager.cancelDownload(id);
manager.pauseDownload(id);
manager.resumeDownload(id);
```

# 目录

- [Electron 文件下载管理器](#electron-文件下载管理器)
- [安装](#安装)
- [快速开始](#快速开始)
- [下载恢复与持久化](#下载恢复与持久化)
  - [基本下载恢复](#基本下载恢复)
  - [下载持久化](#下载持久化)
- [API](#api)
  - [类: `ElectronDownloadManager`](#类-ElectronDownloadManager)
    - [`constructor()`](#constructor)
    - [`download()`](#download)
      - [接口: `DownloadParams`](#接口-downloadparams)
      - [接口: `DownloadManagerCallbacks`](#接口-downloadmanagercallbacks)
    - [`cancelDownload()`](#canceldownload)
    - [`pauseDownload()`](#pausedownload)
    - [`resumeDownload()`](#resumedownload)
    - [`restoreDownload()`](#restoredownload)
    - [`getActiveDownloadCount()`](#getactivedownloadcount)
    - [`getDownloadData()`](#getdownloaddata)
  - [类: `DownloadData`](#类-downloaddata)
    - [属性](#属性)
      - [格式化下载进度](#格式化下载进度)
    - [`isDownloadInProgress()`](#isdownloadinprogress)
    - [`isDownloadPaused()`](#isdownloadpaused)
    - [`isDownloadResumable()`](#isdownloadresumable)
    - [`isDownloadCancelled()`](#isdownloadcancelled)
    - [`isDownloadInterrupted()`](#isdownloadinterrupted)
    - [`isDownloadCompleted()`](#isdownloadcompleted)
    - [`getRestoreDownloadData()`](#getrestoredownloaddata)
- [模拟类](#模拟类)
- [常见问题](#常见问题)
- [致谢](#致谢)

# 安装

```bash
$ npm install electron-dl-manager
```

# 快速开始

您需要在 Electron 应用程序的主进程中使用 `electron-dl-manager`，
在那里您将处理文件下载。

在此示例中，我们使用 [IPC 处理器/调用器](https://www.electronjs.org/docs/latest/tutorial/ipc#pattern-2-renderer-to-main-two-way)
在主进程和渲染进程之间进行通信，但您可以使用任何您想要的 IPC 策略。

```typescript
// MainIpcHandlers.ts

import { ElectronDownloadManager } from "electron-dl-manager";
import { ipcMain } from "electron";

const manager = new ElectronDownloadManager();

// 渲染进程将调用此处理器来开始下载
ipcMain.handle("download-file", async (event, args) => {
  const { url } = args;

  let downloadId;
  const browserWindow = BrowserWindow.fromId(event.sender.id);

  // 您*必须*使用 await 调用 manager.download()，否则
  // 可能会遇到意外行为
  downloadId = await manager.download({
    window: browserWindow,
    url,
    // 如果您想在没有另存为对话框的情况下下载
    saveAsFilename: "file.zip",
    directory: "/directory/where/to/save",
    // 如果您想使用另存为对话框下载
    saveDialogOptions: {
      title: "保存文件",
    },
    callbacks: {
      // item 是 Electron.DownloadItem 的实例
      onDownloadStarted: async ({ id, item, resolvedFilename }) => {
        // 将下载 ID 连同其他一些数据发送回渲染进程
        browserWindow.webContents.invoke("download-started", {
          id,
          // 文件将保存为的文件名
          filename: resolvedFilename,
          // 获取要下载的文件大小（字节）
          totalBytes: item.getTotalBytes(),
        });
      },
      onDownloadProgress: async ({ id, item, percentCompleted }) => {
        // 将下载进度发送回渲染进程
        browserWindow.webContents.invoke("download-progress", {
          id,
          percentCompleted,
          // 获取到目前为止接收的字节数
          bytesReceived: item.getReceivedBytes(),
        });
      },
      onDownloadCompleted: async ({ id, item }) => {
        // 将下载完成信息发送回渲染进程
        browserWindow.webContents.invoke("download-completed", {
          id,
          // 获取已下载文件的路径
          filePath: item.getSavePath(),
        });
      },
      onError: (err, data) => {
        // ... 处理任何错误
      },
    },
  });

  // 暂停下载
  manager.pauseDownload(downloadId);
});
```

# 下载恢复与持久化

本节涵盖了超越简单暂停/恢复功能的高级下载管理功能。这些功能对于需要处理跨不同浏览器窗口、应用重启或下载被外部因素中断的应用程序至关重要。

## 何时使用这些功能

### 常规暂停/恢复与恢复

-
- **暂停/恢复**: 当您想在同一个浏览器窗口和会话中临时停止和重新启动下载时，使用 `pauseDownload()` 和 `resumeDownload()`。
- **恢复**: 当您需要在不同的浏览器窗口中恢复下载、原始窗口已关闭后，或下载管理器实例已被销毁时，使用 `restoreDownload()`。
- **持久化**: 当您希望下载在应用重启、崩溃或用户关闭应用程序时自动保存时，在 `download()` 中使用 `persistOnAppClose` 选项。

## 基本下载恢复

### 接口: `RestoreDownloadConfig`

```typescript
interface RestoreDownloadConfig {
  /**
   * Electron.App 实例
   */
  app: Electron.App;
  /**
   * 应恢复下载的 Electron.BrowserWindow 实例
   */
  window: BrowserWindow;
  /**
   * 恢复下载所需的数据，从 pauseDownload() 返回
   */
  restoreData: RestoreDownloadData;
  /**
   * 定义用于监听下载事件的回调函数
   */
  callbacks: DownloadManagerCallbacks;
  /**
   * 传递给 downloadURL 方法的 Electron.DownloadURLOptions
   *
   * @see https://www.electronjs.org/docs/latest/api/session#sesdownloadurlurl-options
   */
  downloadURLOptions?: Electron.DownloadURLOptions;
}
```

### 接口: `RestoreDownloadData`

```typescript
interface RestoreDownloadData {
  /**
   * 下载 ID
   */
  id: string;
  /**
   * 下载的 URL
   */
  url: string;
  /**
   * 下载将保存的路径和文件名
   */
  fileSaveAsPath: string;
  /**
   * 导致此下载的 URL 链
   */
  urlChain: string[];
  /**
   * 正在下载的文件的 MIME 类型
   */
  mimeType: string;
  /**
   * 下载的 ETag（如果可用）。用于恢复下载
   */
  eTag: string;
  /**
   * 已接收的字节数
   */
  receivedBytes: number;
  /**
   * 要下载的总字节数
   */
  totalBytes: number;
  /**
   * 下载开始的时间戳
   */
  startTime: number;
  /**
   * 下载已完成的百分比
   */
  percentCompleted: number;
  /**
   * 如果 persistOnAppClose 为 true，这是下载
   * 持久化的路径。用于稍后恢复下载。
   */
  persistedFilePath?: string;
}
```

### 示例: 基本下载恢复

```typescript
// 暂停下载并获取恢复数据
const restoreData = manager.pauseDownload(downloadId);

if (restoreData) {
  // 稍后，在不同的浏览器窗口中
  const newDownloadId = await manager.restoreDownload({
    app,
    window: newBrowserWindow,
    restoreData,
    callbacks: {
      onDownloadStarted: async ({ id, item, resolvedFilename }) => {
        console.log(`恢复的下载 ${id} 已开始`);
      },
      onDownloadProgress: async ({ id, percentCompleted }) => {
        console.log(`恢复的下载 ${id} 进度: ${percentCompleted}%`);
      },
      onDownloadCompleted: async ({ id, item }) => {
        console.log(`恢复的下载 ${id} 已完成`);
      },
      onError: (err, data) => {
        console.error("恢复的下载中出现错误:", err);
      },
    },
  });
}
```

## 下载持久化

版本 4.2.0 引入了在应用程序关闭时自动持久化下载的功能，允许稍后恢复它们。此功能与手动暂停/恢复根本不同，因为它：

- **自动触发** 当应用即将关闭时（监听 `will-quit` 事件）
- **保留下载状态** 包括进度、文件路径和元数据
- **在应用崩溃** 和意外关闭时存活
- **在应用重启时工作** 无需用户干预
- **处理文件管理** 通过创建临时 `.download` 文件，这些文件会自动恢复

### 启用下载持久化

要启用下载持久化，请设置 `persistOnAppClose: true` 并提供 `app` 实例：

```typescript
const id = await manager.download({
  app, // Electron.App 实例
  window: mainWindow,
  url: "https://example.com/large-file.zip",
  saveAsFilename: "large-file.zip",
  persistOnAppClose: true,
  callbacks: {
    onDownloadPersisted: async (data, restoreData) => {
      console.log("下载已持久化:", restoreData.persistedFilePath);
      // 将 restoreData 保存到文件或数据库以供稍后恢复
      writeFileSync("download-metadata.json", JSON.stringify(restoreData));
    },
    onDownloadCompleted: async (data) => {
      console.log("下载已完成");
    },
    onError: (err, data) => {
      console.error("下载错误:", err);
    },
  },
});
```

### 恢复持久化下载

当应用重启时，您可以使用保存的元数据恢复持久化下载：

```typescript
// 读取保存的元数据
const metadata = JSON.parse(readFileSync("download-metadata.json", "utf-8"));

// 恢复下载
await manager.restoreDownload({
  app,
  window: mainWindow,
  restoreData: metadata,
  callbacks: {
    onDownloadStarted: async (data) => {
      console.log("持久化下载已恢复并开始");
    },
    onDownloadProgress: async (data) => {
      console.log(`进度: ${data.percentCompleted}%`);
    },
    onDownloadCompleted: async (data) => {
      console.log("持久化下载已完成");
    },
    onError: (err, data) => {
      console.error("恢复的下载中出现错误:", err);
    },
  },
});
```

**注意:** 恢复数据中的 `persistedFilePath` 指向一个带有 `.download` 扩展名的临时文件。库在恢复时自动处理将此文件移动到正确位置。

# API

## 类: `ElectronDownloadManager`

在 Electron 应用程序中管理文件下载。

### `constructor()`

```typescript
constructor(params: DownloadManagerConstructorParams)
```

```typescript
interface DownloadManagerConstructorParams {
  /**
   * 如果定义，将记录内部调试消息。对于
   * 故障排除下载很有用。由于频率问题，
   * 不会记录进度。
   */
  debugLogger?: (message: string) => void;
}
```

### `download()`

开始文件下载。返回下载的 `id`。

```typescript
download(params: DownloadParams): Promise<string>
```

#### 接口: `DownloadParams`

```typescript
interface DownloadParams {
  /**
   * Electron.BrowserWindow 实例
   */
  window: BrowserWindow;
  /**
   * 要下载的 URL
   */
  url: string;
  /**
   * 定义用于监听下载事件的回调函数
   */
  callbacks: DownloadManagerCallbacks;
  /**
   * 传递给 downloadURL 方法的 Electron.DownloadURLOptions
   *
   * @see https://www.electronjs.org/docs/latest/api/session#sesdownloadurlurl-options
   */
  downloadURLOptions?: Electron.DownloadURLOptions;
  /**
   * 如果定义，当用户下载文件时将显示保存对话框。
   *
   * @see https://www.electronjs.org/docs/latest/api/dialog#dialogshowsavedialogbrowserwindow-options
   */
  saveDialogOptions?: SaveDialogOptions;
  /**
   * 保存文件的文件名。如果未定义，将使用服务器的文件名。
   *
   * 仅在 saveDialogOptions 未定义时适用。
   */
  saveAsFilename?: string;
  /**
   * 保存文件的目录。必须是绝对路径。
   * @default 用户的下载目录
   */
  directory?: string;
  /**
   * 如果为 true，文件已存在时将覆盖
   * @default false
   */
  overwrite?: boolean;
  /**
   * 如果为 true，应用关闭时将持久化下载，允许稍后恢复。
   * 需要提供 `app` 参数。
   * @default false
   */
  persistOnAppClose?: boolean;
  /**
   * Electron.App 实例。如果启用了 persistOnAppClose 则为必需。
   */
  app?: Electron.App;
}
```

#### 接口: `DownloadManagerCallbacks`

```typescript
interface DownloadManagerCallbacks {
  /**
   * 当下载已开始时。使用"另存为"对话框时，
   * 这将在用户选择位置后调用。
   *
   * 这总是在进度和完成事件之前首先调用。
   */
  onDownloadStarted: (data: DownloadData) => void;
  /**
   * 当下载有进度更新时。注意：在某些情况下，
   * 下载立即完成时，这可能会完全跳过。
   * 在这种情况下，将调用 onDownloadCompleted。
   */
  onDownloadProgress: (data: DownloadData) => void;
  /**
   * 当下载已完成时
   */
  onDownloadCompleted: (data: DownloadData) => void;
  /**
   * 当下载已被取消时。如果用户从另存为对话框取消，
   * 也会调用此函数。
   */
  onDownloadCancelled: (data: DownloadData) => void;
  /**
   * 当下载被中断时。这可能是由于连接不良、
   * 服务器宕机等原因。
   */
  onDownloadInterrupted: (data: DownloadData) => void;
  /**
   * 当下载已持久化以供稍后恢复时。
   * 当启用 persistOnAppClose 且应用即将关闭时调用此回调。
   */
  onDownloadPersisted?: (
    data: DownloadData,
    restoreDownloadData: RestoreDownloadData
  ) => void;
  /**
   * 当遇到错误时。
   * 注意：签名是 (error, <maybe some data>)。
   */
  onError: (error: Error, data?: DownloadData) => void;
}
```

### `cancelDownload()`

取消下载。

```typescript
cancelDownload(id: string): void
```

### `pauseDownload()`

暂停下载并返回通过 `restoreDownload()` 稍后恢复所需的数据。

```typescript
pauseDownload(id: string): RestoreDownloadData | undefined
```

**返回:** 如果下载存在且可以暂停，返回 `RestoreDownloadData`；如果未找到下载，返回 `undefined`。

**注意:** 使用返回的数据与 `restoreDownload()` 一起恢复下载。

### `resumeDownload()`

恢复下载。

```typescript
resumeDownload(id: string): void
```

### `restoreDownload()`

使用从 `pauseDownload()` 返回的数据恢复未在下载管理器中注册的下载。当您需要在不同的浏览器窗口中恢复下载或在原始窗口关闭后恢复时，这很有用。

如果下载已在当前下载管理器中注册，此方法将调用 `resumeDownload()`。

```typescript
restoreDownload(params: RestoreDownloadConfig): Promise<string>
```

**注意:** 有关恢复下载和使用持久化功能的详细信息，请参阅[下载恢复与持久化](#下载恢复与持久化)部分。

### `getActiveDownloadCount()`

返回活动下载的数量。

```typescript
getActiveDownloadCount(): number
```

### `getDownloadData()`

返回下载的下载数据。

```typescript
getDownloadData(id: string): DownloadData
```

## 类: `DownloadData`

在下载回调中返回的数据。

### 属性

```typescript
class DownloadData {
  /**
   * 下载的生成 ID
   */
  id: string;
  /**
   * Electron.DownloadItem。使用此获取文件名、路径等。
   * @see https://www.electronjs.org/docs/latest/api/download-item
   */
  item: DownloadItem;
  /**
   * Electron.WebContents
   * @see https://www.electronjs.org/docs/latest/api/web-contents
   */
  webContents: WebContents;
  /**
   * Electron.Event
   * @see https://www.electronjs.org/docs/latest/api/event
   */
  event: Event;
  /**
   * 正在保存到用户计算机的文件名。
   * 推荐使用此而不是 Item.getFilename()，因为在使用另存为对话框时可能不准确。
   */
  resolvedFilename: string;
  /**
   * 如果为 true，下载是从另存为对话框取消的。此标志
   * 在使用另存为对话框时，如果应用程序取消下载，也会为 true。
   */
  cancelledFromSaveAsDialog?: boolean;
  /**
   * 下载已完成的百分比
   */
  percentCompleted: number;
  /**
   * 每秒字节的下载速率。
   */
  downloadRateBytesPerSecond: number;
  /**
   * 估计的剩余时间（秒）。
   */
  estimatedTimeRemainingSeconds: number;
  /**
   * 如果下载被中断，中断时的状态
   */
  interruptedVia?: "in-progress" | "completed";
  /**
   * 如果定义，这是下载持久化的路径。
   * 当启用 persistOnAppClose 且下载被持久化时设置。
   */
  persistedFilePath?: string;
}
```

#### 格式化下载进度

您可以使用 [`bytes`](https://www.npmjs.com/package/bytes) 和 [`dayjs`](https://www.npmjs.com/package/dayjs) 库来格式化下载进度。

```bash
$ pnpm add bytes dayjs
$ pnpm add -D @types/bytes
```

```typescript
import bytes from "bytes";
import dayjs from "dayjs";
import relativeTime from "dayjs/plugin/relativeTime";
import duration from "dayjs/plugin/duration";

dayjs.extend(relativeTime);
dayjs.extend(duration);

const downloadData = manager.getDownloadData(id); // 或来自回调的 DataItem

// 将返回类似 1.2 MB/s 的内容
const formattedDownloadRate =
  bytes(downloadData.downloadRateBytesPerSecond, { unitSeparator: " " }) + "/s";

// 将返回类似 "in a few seconds" 的内容
const formattedEstimatedTimeRemaining = dayjs
  .duration(downloadData.estimatedTimeRemainingSeconds, "seconds")
  .humanize(true);
```

### `isDownloadInProgress()`

如果下载正在进行中，返回 true。

```typescript
isDownloadInProgress(): boolean
```

### `isDownloadPaused()`

如果下载已暂停，返回 true。

```typescript
isDownloadPaused(): boolean
```

### `isDownloadResumable()`

如果下载可恢复，返回 true。

```typescript
isDownloadResumable(): boolean
```

### `isDownloadCancelled()`

如果下载已取消，返回 true。

```typescript
isDownloadCancelled(): boolean
```

### `isDownloadInterrupted()`

如果下载被中断，返回 true。

```typescript
isDownloadInterrupted(): boolean
```

### `isDownloadCompleted()`

如果下载已完成，返回 true。

```typescript
isDownloadCompleted(): boolean
```

### `getRestoreDownloadData()`

返回通过 `restoreDownload()` 稍后恢复此下载所需的数据。此方法通常在暂停下载后调用，以获取恢复所需的数据。

```typescript
getRestoreDownloadData(): RestoreDownloadData
```

**返回:** 包含恢复下载所需的所有信息的 `RestoreDownloadData`，包括文件路径、URL、MIME 类型、ETag 和字节信息。

# 模拟类

如果您需要在测试中模拟 `ElectronDownloadManager`，可以使用 `ElectronDownloadManagerMock` 类。

`import { ElectronDownloadManagerMock } from 'electron-dl-manager'`

# 常见问题

## 如何捕获下载无效的情况？`onError()` 没有被调用。

Electron `DownloadItem` 没有提供明确的方式来捕获一般下载的错误：

https://www.electronjs.org/docs/latest/api/download-item#class-downloaditem

（它只有 `on('updated')` 和 `on('done')` 事件，此库使用这些事件来定义回调处理器。）

对于无效的 URL，它会触发 `onDownloadCancelled()` 回调。

```typescript
const id = await manager.download({
  window: mainWindow,
  url: 'https://alkjsdflksjdflk.com/file.zip',
  callbacks: {
    onDownloadCancelled: async (...) => {
      // 无效下载；将调用此回调
    },
  }
});
```

更好的处理方法是自己在下载前检查 URL 是否存在。
我找不到一个我认为可靠到可以包含在此包中的库，
所以最好您找到一个适合您的库：

- https://www.npmjs.com/search?q=url%20exists&ranking=maintenance

GPT 还建议以下代码（未测试）：

```typescript
async function urlExists(url: string): Promise<boolean> {
  try {
    const response = await fetch(url, { method: "HEAD" });
    return response.ok;
  } catch (error) {
    return false;
  }
}

const exists = await urlExists("https://example.com/file.jpg");
```

# 致谢

此代码使用了 [`electron-dl`](https://github.com/sindresorhus/electron-dl) 的一小部分，并在使用的地方进行了标注。

`electron-dl` 在 MIT 许可证下许可，由 Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com) 维护。
