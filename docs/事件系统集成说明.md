# äº‹ä»¶ç³»ç»Ÿé›†æˆè¯´æ˜

## æ¦‚è¿°

æœ¬æ¬¡é‡æ„å°† `eventSystem` é›†æˆåˆ° `app` å¯¹è±¡ä¸­ï¼Œå¹¶å°†å¿«æ·é”®äº‹ä»¶ç»Ÿä¸€åˆ°äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œå®ç°äº†æ›´åŠ ç»Ÿä¸€å’Œç±»å‹å®‰å…¨çš„äº‹ä»¶ç®¡ç†æ–¹å¼ã€‚

## ä¸»è¦å˜æ›´

### 1. æ–°å¢äº‹ä»¶ç®¡ç†å™¨ç±»

åˆ›å»ºäº† `src/renderer/src/core/modules/event.ts`ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼å®ç°äº‹ä»¶ç®¡ç†ï¼š

- **ä¸ä½¿ç”¨ Pinia**ï¼šäº‹ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªçº¯ç²¹çš„äº‹ä»¶å‘å¸ƒè®¢é˜…ç³»ç»Ÿï¼Œä¸éœ€è¦å“åº”å¼çŠ¶æ€ç®¡ç†
- **å•ä¾‹æ¨¡å¼**ï¼šå¯¼å‡º `appEventManager` å®ä¾‹ï¼Œå…¨å±€å”¯ä¸€
- **ç±»å®ç°**ï¼šä½¿ç”¨ `AppEventManager` ç±»å°è£… mitt äº‹ä»¶å‘å°„å™¨
- **å®Œæ•´åŠŸèƒ½**ï¼š
  - `on(type, handler)` - ç›‘å¬äº‹ä»¶
  - `off(type, handler)` - å–æ¶ˆç›‘å¬
  - `emit(type, event)` - è§¦å‘äº‹ä»¶
  - `once(type, handler)` - ä¸€æ¬¡æ€§ç›‘å¬
  - `clear()` - æ¸…é™¤æ‰€æœ‰ç›‘å¬å™¨

### 2. é›†æˆåˆ° App Store

åœ¨ `src/renderer/src/core/index.ts` ä¸­ç›´æ¥å¼•ç”¨ `appEventManager` å®ä¾‹ï¼š

```ts
import { appEventManager } from "./modules/event";

export const useApp = defineStore("app", () => {
  // ...
  const event = appEventManager; // ç›´æ¥å¼•ç”¨å•ä¾‹å®ä¾‹

  return {
    // ...
    event,
  };
});

// ä½¿ç”¨æ–¹å¼
const app = useApp();
app.event.on("hotkey:triggered", handler);
app.event.on("plugin:executed", handler);
```

### 3. å¿«æ·é”®äº‹ä»¶è¿ç§»

#### äº‹ä»¶ç±»å‹å®šä¹‰æ›´æ–°

åœ¨ `src/renderer/src/utils/eventSystem.ts` çš„ `AppEvents` æ¥å£ä¸­æ·»åŠ äº†å¿«æ·é”®äº‹ä»¶ï¼š

```ts
export interface AppEvents {
  // å¿«æ·é”®ç›¸å…³äº‹ä»¶
  "hotkey:triggered": {
    id: string;
    config: HotkeyConfig;
    type: HotkeyType;
  };
  // ... å…¶ä»–äº‹ä»¶
}
```

#### è§¦å‘æ–¹å¼æ›´æ–°

åœ¨ `src/renderer/src/core/utils/hotkey.ts` ä¸­ï¼Œ`triggerHotkeyEvent` å‡½æ•°ä»ä½¿ç”¨ DOM CustomEvent æ”¹ä¸ºä½¿ç”¨ appEventManagerï¼š

**æ—§æ–¹å¼ï¼ˆDOM CustomEventï¼‰ï¼š**

```ts
const customEvent = new CustomEvent("hotkey-triggered", {
  detail: eventDetail,
});
window.dispatchEvent(customEvent);
```

**æ–°æ–¹å¼ï¼ˆappEventManagerï¼‰ï¼š**

```ts
appEventManager.emit("hotkey:triggered", {
  id: config.id,
  config,
  type: config.type,
});
```

#### ç§»é™¤ Hotkey Store çš„äº‹ä»¶æ–¹æ³•

ä» `src/renderer/src/core/modules/hotkey/index.ts` ä¸­ç§»é™¤äº† `on` å’Œ `off` æ–¹æ³•ï¼Œæ·»åŠ äº†è¿ç§»è¯´æ˜ï¼š

````ts
/**
 * å¿«æ·é”®äº‹ä»¶ç›‘å¬å·²ç»Ÿä¸€åˆ° event ç³»ç»Ÿä¸­
 *
 * è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ç›‘å¬å¿«æ·é”®äº‹ä»¶ï¼š
 * ```ts
 * const app = useApp()
 * app.event.on('hotkey:triggered', (event) => {
 *   console.log('å¿«æ·é”®è§¦å‘:', event.id)
 *   console.log('ç±»å‹:', event.type) // HotkeyType.GLOBAL æˆ– HotkeyType.APPLICATION
 *   console.log('é…ç½®:', event.config)
 * })
 * ```
 */
````

### 4. App.vue æ›´æ–°

æ›´æ–°äº†äº‹ä»¶ç›‘å¬æ–¹å¼ï¼š

**æ—§æ–¹å¼ï¼š**

```ts
const eventSystem = useEventSystem();
app.hotkey.on("hotkey:triggered", onHotkeyTriggered);
eventSystem.on("plugin:executed", handlePluginExecuted);
```

**æ–°æ–¹å¼ï¼š**

```ts
app.event.on("hotkey:triggered", onHotkeyTriggered);
app.event.on("plugin:executed", handlePluginExecuted);
```

åŒæ—¶æ›´æ–°äº† `onHotkeyTriggered` çš„å‚æ•°ç±»å‹ï¼Œä» DOM CustomEvent æ”¹ä¸ºç›´æ¥çš„äº‹ä»¶æ•°æ®å¯¹è±¡ï¼š

```ts
const onHotkeyTriggered = async (event: {
  id: string;
  config: any;
  type: "global" | "application";
}) => {
  // å¤„ç†é€»è¾‘...
};
```

## ä½¿ç”¨æŒ‡å—

### æ–¹å¼ä¸€ï¼šé€šè¿‡ App Store è®¿é—®ï¼ˆæ¨èï¼‰

```ts
import { useApp } from "@/core";

const app = useApp();

// ç›‘å¬å¿«æ·é”®è§¦å‘
app.event.on("hotkey:triggered", (event) => {
  console.log("å¿«æ·é”®ID:", event.id);
  console.log("å¿«æ·é”®ç±»å‹:", event.type); // HotkeyType.GLOBAL | HotkeyType.APPLICATION
  console.log("å¿«æ·é”®é…ç½®:", event.config);
});

// ç›‘å¬æ’ä»¶æ‰§è¡Œ
app.event.on("plugin:executed", (event) => {
  console.log("æ’ä»¶ID:", event.pluginId);
  console.log("æ’ä»¶è·¯å¾„:", event.path);
});

// ä¸€æ¬¡æ€§ç›‘å¬
app.event.once("window:close-requested", () => {
  console.log("çª—å£å…³é—­è¯·æ±‚ï¼ˆåªè§¦å‘ä¸€æ¬¡ï¼‰");
});
```

### æ–¹å¼äºŒï¼šç›´æ¥ä½¿ç”¨äº‹ä»¶ç®¡ç†å™¨

```ts
import { appEventManager } from "@/core";
import type { AppEvents } from "@/core";

// ç›´æ¥ä½¿ç”¨äº‹ä»¶ç®¡ç†å™¨ï¼ˆä¸éœ€è¦é€šè¿‡ app storeï¼‰
appEventManager.on("hotkey:triggered", (event) => {
  console.log("å¿«æ·é”®è§¦å‘:", event.id);
});

// ä½¿ç”¨ç±»å‹è¿›è¡Œç±»å‹å®‰å…¨çš„å¼€å‘
type PluginEvent = AppEvents["plugin:executed"];
const handlePlugin = (event: PluginEvent) => {
  console.log(event.pluginId, event.path);
};
appEventManager.on("plugin:executed", handlePlugin);
```

### è§¦å‘äº‹ä»¶

```ts
// è§¦å‘æœç´¢æ¸…ç©ºäº‹ä»¶
app.event.emit("search:clear");

// è§¦å‘çª—å£è°ƒæ•´å¤§å°äº‹ä»¶
app.event.emit("window:resize", {
  height: 500,
});
```

### å–æ¶ˆç›‘å¬

```ts
const handler = (event) => {
  console.log("äº‹ä»¶è§¦å‘", event);
};

// ç›‘å¬
app.event.on("plugin:executed", handler);

// å–æ¶ˆç›‘å¬
app.event.off("plugin:executed", handler);
```

## ä¼˜åŠ¿

1. **ç»Ÿä¸€çš„API**ï¼šæ‰€æœ‰äº‹ä»¶ç›‘å¬éƒ½é€šè¿‡ `app.event` è®¿é—®ï¼Œæ¥å£ä¸€è‡´
2. **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡ TypeScript çš„ç±»å‹å®šä¹‰ï¼Œç¼–è¯‘æ—¶å³å¯æ£€æŸ¥äº‹ä»¶ç±»å‹å’Œå‚æ•°
3. **æ˜“äºç»´æŠ¤**ï¼šäº‹ä»¶å®šä¹‰é›†ä¸­åœ¨ `AppEvents` æ¥å£ä¸­ï¼Œä¸€ç›®äº†ç„¶
4. **æ›´å¥½çš„è§£è€¦**ï¼šäº‹ä»¶å‘å¸ƒå’Œè®¢é˜…è§£è€¦ï¼Œé™ä½ç»„ä»¶é—´çš„ç›´æ¥ä¾èµ–
5. **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰åº”ç”¨äº‹ä»¶ï¼ˆåŒ…æ‹¬å¿«æ·é”®äº‹ä»¶ï¼‰éƒ½åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ç®¡ç†

## æ¶æ„è®¾è®¡

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Piniaï¼Ÿ

äº‹ä»¶ç³»ç»Ÿä½¿ç”¨å•ä¾‹ç±»è€Œä¸æ˜¯ Pinia Storeï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **ä¸éœ€è¦å“åº”å¼**ï¼šäº‹ä»¶ç³»ç»Ÿåªæ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä¸éœ€è¦ Vue çš„å“åº”å¼ç³»ç»Ÿ
2. **æ›´è½»é‡**ï¼šé¿å… Pinia çš„é¢å¤–å¼€é”€ï¼Œæå‡æ€§èƒ½
3. **ç‹¬ç«‹æ€§å¼º**ï¼šäº‹ä»¶ç³»ç»Ÿæ˜¯ç‹¬ç«‹çš„åŸºç¡€è®¾æ–½ï¼Œä¸åº”è¯¥ä¾èµ–äºçŠ¶æ€ç®¡ç†åº“
4. **ç®€å•ç›´æ¥**ï¼šå•ä¾‹æ¨¡å¼æ›´ç¬¦åˆäº‹ä»¶ç³»ç»Ÿçš„ä½¿ç”¨åœºæ™¯

### æ–‡ä»¶ç»„ç»‡

- **åˆ é™¤äº†** `src/renderer/src/utils/eventSystem.ts`
- **ç±»å‹å®šä¹‰**ï¼š`src/renderer/src/core/typings/event.ts` - åŒ…å« `AppEvents`ã€`AppEventType`ã€`AppEventHandler`
- **å®ç°ä»£ç **ï¼š`src/renderer/src/core/modules/event.ts` - åŒ…å« `AppEventManager` ç±»å’Œ `appEventManager` å®ä¾‹
- **ç»Ÿä¸€å¯¼å‡º**ï¼š`src/renderer/src/core/index.ts` - å¯¼å‡º `appEventManager` å’Œæ‰€æœ‰äº‹ä»¶ç±»å‹
- **å…¨å±€ç»Ÿä¸€ä½¿ç”¨** `appEventManager` å®ä¾‹

## å‘åå…¼å®¹

- `useEventSystem` composable å·²æ›´æ–°ä¸ºä½¿ç”¨ `appEventManager`ï¼ŒAPI ä¿æŒä¸å˜
- æ‰€æœ‰ä¾èµ–æ—§ `eventSystem` çš„æ–‡ä»¶éƒ½å·²æ›´æ–°
- äº‹ä»¶åç§°å’Œæ•°æ®ç»“æ„ä¿æŒä¸å˜ï¼Œåªæ˜¯åº•å±‚å®ç°æ›´æ”¹

## è¿ç§»æ£€æŸ¥æ¸…å•

- [x] åˆ›å»º AppEventManager ç±»ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
- [x] å°†ç±»å‹å®šä¹‰ç§»åˆ° `core/typings/event.ts`
- [x] é›†æˆåˆ° App Storeï¼ˆç›´æ¥å¼•ç”¨å®ä¾‹ï¼Œä¸ä½¿ç”¨ Piniaï¼‰
- [x] æ›´æ–° AppEvents æ¥å£æ·»åŠ å¿«æ·é”®äº‹ä»¶
- [x] æ›´æ–° triggerHotkeyEvent ä½¿ç”¨ appEventManager
- [x] ç§»é™¤ Hotkey Store çš„ on/off æ–¹æ³•
- [x] æ›´æ–° App.vue çš„äº‹ä»¶ç›‘å¬æ–¹å¼
- [x] æ›´æ–° useAppActions.ts ä½¿ç”¨ appEventManager
- [x] åˆ é™¤æ—§çš„ utils/eventSystem.ts æ–‡ä»¶
- [x] åˆ é™¤ composables/useEventSystem.ts æ–‡ä»¶ï¼ˆä¸å†éœ€è¦ï¼‰
- [x] åˆ é™¤ core/typings/hotkey.ts ä¸­çš„ HotkeyEventType å’Œ HotkeyEventListenerï¼ˆå·²è¿ç§»åˆ°äº‹ä»¶ç³»ç»Ÿï¼‰
- [x] åˆ é™¤ core/typings/hotkey.ts ä¸­çš„ HotkeyEventDetailï¼ˆä¸å†ä½¿ç”¨ï¼‰
- [x] åœ¨ core/index.ts ä¸­ç»Ÿä¸€å¯¼å‡ºäº‹ä»¶ç±»å‹
- [x] æ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡
- [x] æ‰€æœ‰ linter é”™è¯¯å·²ä¿®å¤

## æ¸…ç†å·¥ä½œ

### å·²åˆ é™¤çš„æ–‡ä»¶å’Œç±»å‹

1. **åˆ é™¤çš„æ–‡ä»¶**ï¼š
   - `src/renderer/src/utils/eventSystem.ts` - å·²æ•´åˆåˆ° core/modules/event.ts
   - `src/renderer/src/composables/useEventSystem.ts` - ä¸å†éœ€è¦ï¼Œç›´æ¥ä½¿ç”¨ app.event

2. **åˆ é™¤çš„ç±»å‹å®šä¹‰**ï¼ˆä» core/typings/hotkey.tsï¼‰ï¼š
   - `HotkeyEventType` - å¿«æ·é”®äº‹ä»¶å·²è¿ç§»åˆ° AppEvents
   - `HotkeyEventListener` - äº‹ä»¶ç›‘å¬å™¨å·²ç»Ÿä¸€åˆ° AppEventHandler
   - `HotkeyEventDetail` - äº‹ä»¶è¯¦æƒ…å·²æ•´åˆåˆ° AppEvents['hotkey:triggered']

3. **ä¿ç•™çš„æ—§ç³»ç»Ÿ**ï¼š
   - `src/renderer/src/typings/hotkeyTypes.ts` ä¸­çš„ç›¸å…³ç±»å‹ä»ä¿ç•™ï¼Œä¾›æ—§çš„ HotkeyManager ä½¿ç”¨
   - åç»­å¯ä»¥é€æ­¥è¿ç§»æ—§ç³»ç»Ÿåˆ°æ–°çš„ core ç³»ç»Ÿ

## ä½¿ç”¨å»ºè®®

- âœ… **æ¨è**ï¼šä½¿ç”¨ `app.event.on()` æˆ–ç›´æ¥ä½¿ç”¨ `appEventManager`
- âŒ **ä¸æ¨è**ï¼šä¸è¦å†åˆ›å»ºæ–°çš„ useEventSystem æˆ–ç±»ä¼¼çš„åŒ…è£…
- ğŸ’¡ **æç¤º**ï¼šæ‰€æœ‰äº‹ä»¶ç›‘å¬éƒ½åº”è¯¥é€šè¿‡ç»Ÿä¸€çš„äº‹ä»¶ç³»ç»Ÿè¿›è¡Œ
- ğŸ“Œ **å‘½åçº¦å®š**ï¼šäº‹ä»¶åç§°ä½¿ç”¨å†’å· `:` åˆ†éš”ï¼Œå¦‚ `hotkey:triggered`ã€`plugin:executed`ã€`window:resize` ç­‰
