# 快捷键模块重构说明

## 重构目标

将快捷键模块从 hooks 风格改为类模块风格，参照 search modules 的写法，提高代码的可维护性和一致性。

## 文件结构变化

### 之前（hooks 风格）

```
src/renderer/src/temp_code/modules/hotkey/
├── index.ts
├── appHotkey.ts (使用 useAppHotkeyModule 函数)
└── globalHotkey.ts (使用 useGlobalHotkeyModule 函数)
```

### 现在（类模块风格）

```
src/renderer/src/temp_code/modules/hotkey/
├── index.ts (主 Store，统一管理)
└── modules/
    ├── appHotkey.ts (AppModule 类)
    └── globalHotkey.ts (GlobalModule 类)
```

## 主要改进

### 1. **使用类而非函数**

#### 之前（hooks 风格）

```typescript
export function useAppHotkeyModule() {
  const register = (config: HotkeyConfig): boolean => {
    // ...
  };

  return {
    register,
    unregister,
    // ...
  };
}
```

#### 现在（类风格）

```typescript
export class AppModule {
  register(config: HotkeyConfig): boolean {
    // ...
  }

  unregister(config: HotkeyConfig): boolean {
    // ...
  }
}
```

### 2. **统一的事件监听管理**

全局快捷键的事件监听从 `globalHotkey.ts` 移到了主 `index.ts` 中统一管理：

```typescript
// 在 index.ts 中
const _initializeGlobalHotkeyListener = (): void => {
  naimo.event.onGlobalHotkeyTrigger((_event, data) => {
    const { hotkeyId } = data;
    const config = globalHotkeyModule.getConfig(hotkeyId);

    if (config) {
      if (config.callback) {
        config.callback();
      }
      triggerHotkeyEvent(config);
    }
  });
};

// 在 initialize 中调用
const initialize = async () => {
  _initializeGlobalHotkeyListener();
  // ... 其他初始化逻辑
};
```

### 3. **模块实例化**

```typescript
// 在 index.ts 中
const appHotkeyModule = new AppModule();
const globalHotkeyModule = new GlobalModule();
```

## 类模块功能

### AppModule

**职责：**

- 与 hotkeys-js 库交互
- 注册/注销应用内快捷键
- 管理快捷键作用域

**主要方法：**

- `register(config)` - 注册应用内快捷键
- `unregister(config)` - 注销应用内快捷键
- `setScope(scope)` - 设置快捷键作用域
- `getScope()` - 获取当前作用域
- `batchRegister(configs)` - 批量注册
- `batchUnregister(configs)` - 批量注销

### GlobalModule

**职责：**

- 与 Electron 主进程通信
- 注册/注销全局快捷键
- 纯粹的 IPC 通信层，不维护状态

**主要方法：**

- `register(config)` - 注册全局快捷键
- `unregister(id)` - 注销全局快捷键
- `batchRegister(configs)` - 批量注册
- `batchUnregister(ids)` - 批量注销
- `unregisterAll()` - 注销所有快捷键

## 事件流程

### 应用内快捷键

```
用户按键 → hotkeys-js 检测 → 执行回调 → 触发 hotkey-triggered 事件 → app.hotkey.on() 监听器
```

### 全局快捷键

```
用户按键 → 主进程检测 → 发送 global-hotkey-trigger 事件
→ index.ts 监听器接收 → 查找配置 → 执行回调 → 触发 hotkey-triggered 事件
→ app.hotkey.on() 监听器
```

## 使用示例

### 在 Store 中使用

```typescript
import { useApp } from "@/temp_code";

const app = useApp();

// 初始化
await app.hotkey.initialize();

// 注册快捷键
await app.hotkey.register({
  id: "my_hotkey",
  keys: "Ctrl+K",
  type: HotkeyType.APPLICATION,
  enabled: true,
  name: "我的快捷键",
});

// 监听快捷键事件
app.hotkey.on("hotkey-triggered", (event) => {
  console.log("快捷键触发:", event.detail.id);
});
```

## 优势

1. **代码一致性**：与 search modules 保持相同的架构风格
2. **更好的封装**：类提供了更清晰的边界和状态管理
3. **易于测试**：类实例化更容易进行单元测试
4. **统一管理**：事件监听在 index.ts 中统一初始化，避免分散
5. **更清晰的职责**：每个模块类有明确的职责范围

## 注意事项

1. **初始化顺序**：必须先调用 `app.hotkey.initialize()` 才能使用快捷键功能
2. **事件监听**：全局快捷键事件监听在 initialize 时自动设置，无需手动初始化
3. **数据统一管理**：所有快捷键配置统一存储在 `index.ts` 的 `hotkeys` Map 中，模块类不维护状态
4. **类型安全**：所有模块都有完整的 TypeScript 类型定义

## 迁移指南

如果有其他地方直接使用了旧的模块，需要进行以下更新：

### 之前

```typescript
import { useAppHotkeyModule } from "@/temp_code/modules/hotkey/appHotkey";

const appHotkeyModule = useAppHotkeyModule();
appHotkeyModule.register(config);
```

### 现在

```typescript
import { useApp } from "@/temp_code";

const app = useApp();
await app.hotkey.initialize();
app.hotkey.appHotkeyModule.register(config);
```

或者直接使用 Store 的封装方法：

```typescript
await app.hotkey.register(config);
```

## 相关文件

- `src/renderer/src/temp_code/modules/hotkey/index.ts` - 主 Store
- `src/renderer/src/temp_code/modules/hotkey/modules/appHotkey.ts` - 应用内快捷键模块
- `src/renderer/src/temp_code/modules/hotkey/modules/globalHotkey.ts` - 全局快捷键模块
- `src/renderer/src/temp_code/typings/hotkey.ts` - 类型定义

## 日期

2025-10-05
