# 快捷键系统迁移说明

## 概述

本次重构将快捷键相关功能从旧的 `useHotkeyManager` 系统迁移到了新的 `useApp.hotkey` 统一状态管理系统。

## 主要变更

### 1. 核心变更

#### 旧系统（已废弃）

```typescript
// 导入
import { useHotkeyManager } from "@/modules/hotkeys/hooks/useHotkeyManager";

// 使用
const { addHotKeyListener, initializeHotkeys } = useHotkeyManager();
await initializeHotkeys();
addHotKeyListener("hotkey-triggered", onHotkeyTriggered);
```

#### 新系统（推荐使用）

```typescript
// 导入
import { useApp } from "@/temp_code";

// 使用
const app = useApp();
await app.hotkey.initialize();
app.hotkey.on("hotkey-triggered", onHotkeyTriggered);
```

### 2. 修改的文件

#### 核心文件

1. **src/renderer/src/temp_code/modules/hotkey/index.ts**
   - 新增 `addListener()` 和 `removeListener()` 方法
   - 新增 `_loadAndMergeConfig()` 方法，支持默认配置的加载和合并
   - 优化初始化逻辑，确保默认快捷键配置能够正确加载

2. **src/renderer/src/App.vue**
   - 移除 `useHotkeyManager` 导入
   - 使用 `app.hotkey.initialize()` 替代 `initializeHotkeys()`
   - 使用 `app.hotkey.addListener()` 替代 `addHotKeyListener()`

3. **src/renderer/src/pages/settings/main.ts**
   - 移除 `useHotkeyManager` 导入
   - 使用 `useApp` 统一管理
   - 使用 `app.hotkey.initialize()` 初始化快捷键系统

### 3. 新增功能

#### 默认配置合并机制

新系统在初始化时会自动合并默认配置和用户配置：

- 首次运行时，加载默认快捷键配置
- 已有用户配置时，保留用户的自定义设置
- 自动保存合并后的配置到本地存储

#### 事件监听器

新系统提供了便捷的事件监听方法（使用简洁的 `on`/`off` API）：

```typescript
// 添加监听器
app.hotkey.on("hotkey-triggered", handler);

// 移除监听器
app.hotkey.off("hotkey-triggered", handler);
```

**事件类型说明：**

```typescript
// 事件类型（带类型检查）
type HotkeyEventType = "hotkey-triggered" | "app-hotkey-triggered";

// 事件监听器类型
type HotkeyEventListener = (event: CustomEvent<HotkeyEventDetail>) => void;

// 使用示例（完整类型支持）
app.hotkey.on("hotkey-triggered", (event) => {
  console.log("快捷键触发:", event.detail.id);
  console.log("快捷键组合:", event.detail.keys);
  console.log("快捷键配置:", event.detail.config);
});
```

### 4. API 对照表

| 旧 API                                   | 新 API                           | 说明               |
| ---------------------------------------- | -------------------------------- | ------------------ |
| `useHotkeyManager().initializeHotkeys()` | `useApp().hotkey.initialize()`   | 初始化快捷键系统   |
| `useHotkeyManager().addHotKeyListener()` | `useApp().hotkey.on()`           | 添加事件监听器     |
| N/A                                      | `useApp().hotkey.off()`          | 移除事件监听器     |
| N/A                                      | `useApp().hotkey.register()`     | 注册快捷键         |
| N/A                                      | `useApp().hotkey.unregister()`   | 注销快捷键         |
| N/A                                      | `useApp().hotkey.toggle()`       | 切换快捷键启用状态 |
| N/A                                      | `useApp().hotkey.updateConfig()` | 更新快捷键配置     |
| N/A                                      | `useApp().hotkey.getConfig()`    | 获取快捷键配置     |

### 5. 优势

#### 统一的状态管理

- 所有快捷键数据集中在 `useApp().hotkey` 中管理
- 避免了多个实例和状态不一致的问题

#### 更好的类型支持

- 完整的 TypeScript 类型定义
- 更好的 IDE 智能提示

#### 响应式设计

- 基于 Pinia 的响应式状态管理
- 实时更新和自动保存

#### 扩展性更好

- 支持子模块（appHotkeyModule、globalHotkeyModule）
- 便于添加新功能

### 6. 向后兼容

旧的 `useHotkeyManager` 和 `HotkeyManager` 系统仍然保留，但不再推荐使用。建议所有新代码都使用 `useApp().hotkey` 系统。

### 7. 迁移步骤

如果你有其他地方使用了旧系统，请按照以下步骤迁移：

1. 移除 `useHotkeyManager` 导入：

```typescript
// 删除
import { useHotkeyManager } from "@/modules/hotkeys/hooks/useHotkeyManager";
```

2. 添加 `useApp` 导入：

```typescript
import { useApp } from "@/temp_code";
```

3. 替换初始化代码：

```typescript
// 旧代码
const { initializeHotkeys } = useHotkeyManager();
await initializeHotkeys();

// 新代码
const app = useApp();
await app.hotkey.initialize();
```

4. 替换事件监听代码：

```typescript
// 旧代码
const { addHotKeyListener } = useHotkeyManager();
addHotKeyListener("hotkey-triggered", handler);

// 新代码
const app = useApp();
app.hotkey.on("hotkey-triggered", handler);

// 移除监听（如需要）
app.hotkey.off("hotkey-triggered", handler);
```

## 注意事项

1. **初始化顺序**：确保在使用快捷键功能前调用 `app.hotkey.initialize()`
2. **事件监听**：
   - 事件类型为 `'hotkey-triggered'` 和 `'app-hotkey-triggered'`（带类型检查）
   - 使用简洁的 `on`/`off` API 替代 `addEventListener`/`removeEventListener`
   - 完整的 TypeScript 类型支持，包括事件详情的智能提示
3. **存储格式**：新系统使用 Map 结构存储快捷键配置，自动转换为数组保存到本地存储

## 测试建议

1. 测试默认快捷键是否正常工作
2. 测试自定义快捷键的添加、修改、删除
3. 测试快捷键配置的持久化保存
4. 测试快捷键事件的触发和监听
5. 测试多个视图间的快捷键同步

## 相关文件

- `src/renderer/src/temp_code/modules/hotkey/index.ts` - 快捷键主 Store
- `src/renderer/src/temp_code/modules/hotkey/appHotkey.ts` - 应用内快捷键模块
- `src/renderer/src/temp_code/modules/hotkey/globalHotkey.ts` - 全局快捷键模块
- `src/renderer/src/temp_code/typings/hotkey.ts` - 快捷键类型定义（新增事件类型）
- `src/renderer/src/modules/hotkeys/config/hotkey.ts` - 默认快捷键配置
- `src/renderer/src/temp_code/utils/hotkey.ts` - 快捷键工具函数

## 日期

2025-10-05
