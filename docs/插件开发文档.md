# Naimo Tools 插件开发文档

## 目录

1. [概述](#概述)
2. [插件结构](#插件结构)
3. [插件配置](#插件配置)
4. [插件API](#插件api)
5. [插件类型和接口](#插件类型和接口)
6. [开发示例](#开发示例)
7. [最佳实践](#最佳实践)
8. [调试指南](#调试指南)

## 概述

Naimo Tools 提供了强大的插件系统，允许开发者创建自定义功能扩展。插件可以添加新的搜索项目、执行自定义代码、打开网页窗口等。

### 插件特性

- 🚀 支持多种执行类型（打开应用、网页、自定义代码）
- 🔍 支持多种搜索模式（普通搜索、附件搜索、插件搜索）
- ⚙️ 完整的设置配置系统
- 🎨 丰富的UI组件支持
- 📦 简单的安装和管理

## 插件结构

一个标准的插件包含以下文件：

```
example-plugin/
├── config.js          # 插件配置文件（必需）
├── index.html         # 插件网页内容（可选）
├── preload.js         # 预加载脚本（可选）
└── other-assets/      # 其他资源文件（可选）
```

### 文件说明

- **config.js**: 插件的主配置文件，定义插件的基本信息、功能项目和设置
- **index.html**: 当插件需要显示网页内容时使用
- **preload.js**: 在插件网页窗口中预加载的脚本，可以扩展窗口功能
- **其他资源**: 图标、样式、脚本等资源文件

## 插件配置

### 基本配置结构

```javascript
// config.js
module.exports = {
  // 基本信息
  id: "plugin-id", // 插件唯一标识
  name: "插件名称", // 显示名称
  description: "插件描述", // 描述信息
  version: "1.0.0", // 版本号
  author: "作者名称", // 作者
  icon: "svg图标或emoji", // 插件图标
  category: "插件分类", // 分类
  enabled: true, // 是否启用

  // 功能项目列表
  items: [
    // 项目配置...
  ],

  // 插件选项
  options: {
    autoStart: false,
    showInMenu: true,
    maxItems: 10,
  },

  // 设置配置
  settings: [
    // 设置项配置...
  ],

  // 元数据
  metadata: {
    createdAt: Date.now(),
    updatedAt: Date.now(),
    installedAt: Date.now(),
  },
};
```

### 插件分类

支持的插件分类类型：

```javascript
export enum PluginCategoryType {
  EFFICIENT_OFFICE = 'efficient_office',        // 高效办公 🚀
  AI_ARTIFICIAL_INTELLIGENCE = 'ai_artificial_intelligence', // AI人工智能 🤖
  DEVELOPER_ESSENTIALS = 'developer_essentials', // 程序员必备 💻
  RECORD_IDEAS = 'record_ideas',                 // 记录想法 ✏️
  IMAGE_VIDEO = 'image_video',                   // 图像视频 🎬
  MEDIA_TOOLS = 'media_tools',                   // 媒体工具 🎬
  SYSTEM_TOOLS = 'system_tools',                 // 系统工具 📷
  STUDY_WELL = 'study_well',                     // 好好学习 🎓
  BRAINSTORMING = 'brainstorming',               // 脑洞大开 🧠
  OTHER = 'other'                                // 其他 🔌
}
```

### 插件项目配置

每个插件可以包含多个功能项目：

```javascript
{
  name: "项目名称",                    // 显示名称
  path: "应用路径或标识",              // 执行路径
  icon: "图标",                       // 项目图标
  description: "项目描述",            // 描述信息
  weight: 100,                        // 排序权重

  // 执行类型
  executeType: PluginExecuteType.CUSTOM_CODE,

  // 执行参数
  executeParams: {
    url: "网页地址",                  // SHOW_WEBPAGE 时使用
    code: "自定义代码",               // CUSTOM_CODE 时使用
  },

  // 行为配置
  autoStart: false,                   // 开机启动
  closeAction: 'hide',                // 关闭行为: 'hide' | 'close'

  // 搜索模式配置
  hideInModes: ['normal'],            // 在哪些模式下隐藏
  showInModes: ['plugin'],            // 在哪些模式下显示
  anonymousSearchFields: ['name'],    // 匿名搜索字段

  // 回调函数
  onEnter: (params, api) => {
    // 进入时执行的代码
  },
  onSearch: (text, files) => {
    // 附件搜索回调
    return true; // 返回是否匹配
  },
  onPluginSearch: (searchText, files) => {
    // 插件搜索回调
    return []; // 返回搜索结果数组
  }
}
```

### 执行类型

```javascript
export enum PluginExecuteType {
  OPEN_APP = 1,        // 打开软件
  OPEN_WEB_URL = 2,    // 打开网页链接
  SHOW_WEBPAGE = 3,    // 在内容区显示网页
  CUSTOM_CODE = 4      // 执行自定义代码
}
```

### 设置配置

插件支持丰富的设置选项：

```javascript
settings: [
  {
    name: "settingName", // 设置项名称
    title: "设置标题", // 显示标题
    description: "设置描述", // 描述信息
    type: "input", // 设置类型
    defaultValue: "默认值", // 默认值
    required: false, // 是否必需
    children: [], // 子设置项
  },
];
```

支持的设置类型：

- `input` - 文本输入框
- `select` - 下拉选择框
- `checkbox` - 复选框
- `radio` - 单选按钮
- `textarea` - 多行文本框
- `number` - 数字输入框
- `date` - 日期选择器
- `time` - 时间选择器
- `datetime` - 日期时间选择器
- `file` - 文件选择器
- `image` - 图片选择器
- `video` - 视频选择器
- `audio` - 音频选择器
- `url` - URL输入框
- `email` - 邮箱输入框
- `password` - 密码输入框
- `tel` - 电话号码输入框
- `search` - 搜索框
- `range` - 范围滑块
- `color` - 颜色选择器
- `hidden` - 隐藏字段

## 插件API

插件在执行时可以访问丰富的API接口。需要注意的是，插件的HTML文件中需要遵循基础preload.js提供的API规范。

### API使用规则

**重要提示**：

1. 在插件的HTML文件中，必须使用基础preload.js（basic.ts）提供的API方法来访问系统功能
2. **命名冲突规则**：插件preload.js中**严禁使用`electronAPI`**作为API命名空间，因为它已被基础preload占用
3. 插件必须使用自己的API命名空间，如`yourPluginAPI`、`translatePluginAPI`、`pluginNameAPI`等
4. 系统会将基础preload和插件preload进行融合，同时支持两者的方法
5. 违反命名规则会导致API覆盖和功能异常

### 命名冲突防范

为避免与基础preload的API冲突，插件开发时必须遵循以下规则：

- ❌ **禁止使用的命名空间**：`electronAPI`、`webUtils`
- ✅ **推荐的命名格式**：`{pluginId}API`、`{功能名}PluginAPI`
- ✅ **命名示例**：
  - `translatePluginAPI` - 翻译插件
  - `calculatorAPI` - 计算器插件
  - `fileManagerAPI` - 文件管理插件
  - `weatherPluginAPI` - 天气插件

### API命名规范

```javascript
// ❌ 错误 - 与基础preload冲突
contextBridge.exposeInMainWorld("electronAPI", {
  // 插件方法...
});

// ✅ 正确 - 使用插件特定的命名空间
contextBridge.exposeInMainWorld("yourPluginAPI", {
  // 插件方法...
});

// ✅ 示例 - 翻译插件的命名空间
contextBridge.exposeInMainWorld("translatePluginAPI", {
  translateText,
  getLanguageName,
  // 其他插件特定方法...
});
```

### 基础API（在HTML中可用）

```javascript
// 使用基础preload提供的IPC路由系统
naimo.router

// 日志API
naimo.log.info(message: string, ...args: any[])
naimo.log.error(message: string, ...args: any[])
naimo.log.warn(message: string, ...args: any[])
naimo.log.debug(message: string, ...args: any[])

// 插件配置加载
naimo.webUtils.loadPluginConfig(configPath: string)

// 文件路径获取
naimo.webUtils.getPathForFile(file: File): string
```

### 存储操作（通过IPC路由）

```javascript
// 获取插件设置 - 正确的调用方式
const settings = await naimo.router.storeGet("pluginSettings.your-plugin-id");

// 设置插件配置
await naimo.router.storeSet("pluginSettings.your-plugin-id", settingsData);

// 删除配置
await naimo.router.storeDeleteKey("pluginSettings.your-plugin-id");
```

### 插件Preload API（仅在preload.js中可用）

```javascript
// 获取插件资源路径
api.getResourcePath(path: string): string | null

// 钩子事件处理
api.onHook(event: string, handler: Function): void

// 获取/设置插件设置
api.getSettingValue(settingName?: string): Promise<any>
api.setSettingValue(settingName: string, value: any): Promise<boolean>

// 命令系统
api.onCommand(event: string, description: string, handler: Function): void
api.emitCommand(event: string, ...args: any[]): void

// UI控制
api.toggleInput(value?: boolean): void
api.openPluginWindow(): void
```

### 文件和窗口操作

```javascript
// 文件操作
api.addPathToFileList(name: string, path: string): Promise<void>

// 窗口操作
api.openWebPageWindow(url: string, options?: any): Promise<void>
```

### 插件管理

```javascript
// 插件管理
api.plugin.installZip(zipPath: string): Promise<boolean>
api.plugin.install(pluginData: any): Promise<boolean>
api.plugin.uninstall(pluginId: string): Promise<boolean>
api.plugin.toggle(pluginId: string, enabled: boolean): Promise<boolean>
```

### IPC路由API（通过基础preload可用）

通过 `naimo.router` 可以访问所有主进程功能：

```javascript
// 应用操作
naimo.router.appLaunchApp(path: string)
naimo.router.appGetInstalledApps()

// 文件系统操作
naimo.router.filesystemReadFile(path: string)
naimo.router.filesystemWriteFile(path: string, content: string)
naimo.router.pluginGetPluginsDirectory()

// 窗口操作
naimo.router.windowCreateWebPageWindow(parentId: number, url: string)
naimo.router.windowShow(id: number)
naimo.router.windowHide(id: number)
naimo.router.windowClose(id: number)
naimo.router.windowMinimize(id: number)
naimo.router.windowMaximize(id: number)

// 热键操作
naimo.router.hotkeyRegister(accelerator: string)
naimo.router.hotkeyUnregister(accelerator: string)

// 日志操作
naimo.router.logInfo(message: string)
naimo.router.logError(message: string)
naimo.router.logWarn(message: string)
naimo.router.logDebug(message: string)

// 存储操作
naimo.router.storeGet(key: string)
naimo.router.storeSet(key: string, value: any)
naimo.router.storeDeleteKey(key: string)
naimo.router.storeClear()
```

## 插件类型和接口

### PluginItem 接口

```typescript
interface PluginItem extends AppItem {
  pluginId?: string;
  description?: string;
  autoStart?: boolean;
  executeType?: PluginExecuteType;
  executeParams?: {
    url?: string;
    code?: string;
    [key: string]: any;
  };
  weight?: number;
  closeAction?: "hide" | "close";
  onSearch?: (text: string, files: AttachedFile[]) => boolean;
  onPluginSearch?: (searchText: string, files: AttachedFile[]) => AppItem[];
  onEnter?: (
    params: { files: AttachedFile[]; searchText: string },
    api: PluginApi
  ) => void;
  hideInModes?: SearchMode[];
  showInModes?: SearchMode[];
  anonymousSearchFields?: string[];
}
```

### PluginConfig 接口

```typescript
interface PluginConfig {
  id: string;
  name: string;
  description?: string;
  version: string;
  author?: string;
  icon?: string;
  category?: PluginCategoryType;
  enabled: boolean;
  items: PluginItem[];
  options?: Record<string, any>;
  settings?: SettingConfig[];
  metadata?: {
    createdAt: number;
    updatedAt: number;
    installedAt: number;
  };
}
```

### API使用示例

#### 在插件HTML中获取插件设置

```javascript
// ❌ 错误的方式 - 不要这样做
if (naimo && naimo.getPluginSettings) {
  pluginSettings = (await naimo.getPluginSettings()) || {};
}

// ✅ 正确的方式 - 使用基础preload提供的IPC路由
if (naimo && naimo.router) {
  pluginSettings =
    (await naimo.router.storeGet("pluginSettings.your-plugin-id")) || {};
}
```

#### 在插件HTML中调用插件preload方法

```javascript
// 插件preload.js中暴露的方法可以直接调用
// 注意：插件需要使用自己的API命名空间，避免与基础preload冲突
if (window.translatePluginAPI && window.translatePluginAPI.translateText) {
  const result = await window.translatePluginAPI.translateText({
    sourceText: text,
    source: "auto",
    target: "zh",
    settings: pluginSettings,
  });
}
```

#### 文件操作示例

```javascript
// 读取文件
const content = await naimo.router.filesystemReadFile("/path/to/file.txt");

// 写入文件
await naimo.router.filesystemWriteFile("/path/to/file.txt", "content");

// 获取插件目录
const pluginDir = await naimo.router.pluginGetPluginsDirectory();
```

#### 日志记录示例

```javascript
// 使用基础preload提供的日志API
naimo.log.info("插件信息日志");
naimo.log.error("插件错误日志");
naimo.log.warn("插件警告日志");
naimo.log.debug("插件调试日志");
```

## 开发示例

### 示例1：简单的应用启动器

```javascript
// config.js
module.exports = {
  id: "app-launcher",
  name: "应用启动器",
  description: "快速启动常用应用",
  version: "1.0.0",
  author: "Developer",
  icon: "🚀",
  category: "system_tools",
  enabled: true,

  items: [
    {
      name: "记事本",
      path: "notepad.exe",
      icon: "📝",
      description: "打开系统记事本",
      weight: 100,
      executeType: 1, // OPEN_APP
      onEnter: (params, api) => {
        naimo.router.appLaunchApp("C:\\Windows\\System32\\notepad.exe");
      },
    },
    {
      name: "计算器",
      path: "calc.exe",
      icon: "🧮",
      description: "打开系统计算器",
      weight: 90,
      onEnter: (params, api) => {
        naimo.router.appLaunchApp("calc.exe");
      },
    },
  ],
};
```

### 示例2：网页工具插件

```javascript
// config.js
module.exports = {
  id: "web-tools",
  name: "网页工具",
  description: "常用的网页工具集合",
  version: "1.0.0",
  author: "Developer",
  icon: "🌐",
  category: "efficient_office",
  enabled: true,

  items: [
    {
      name: "JSON格式化",
      path: "json-formatter",
      icon: "📋",
      description: "JSON数据格式化工具",
      weight: 100,
      executeType: 3, // SHOW_WEBPAGE
      executeParams: {
        url: "https://jsonformatter.org/",
      },
      onEnter: (params, api) => {
        api.openWebPageWindow("https://jsonformatter.org/");
      },
    },
    {
      name: "本地工具",
      path: "local-tool",
      icon: "🔧",
      description: "本地HTML工具",
      weight: 90,
      onEnter: (params, api) => {
        api.openWebPageWindow(api.getResourcePath("index.html"), {
          preload: api.getResourcePath("preload.js"),
        });
      },
    },
  ],

  settings: [
    {
      name: "defaultTool",
      title: "默认工具",
      description: "选择默认打开的工具",
      type: "select",
      defaultValue: "json-formatter",
    },
  ],
};
```

### 示例3：自定义搜索插件

```javascript
// config.js
module.exports = {
  id: "custom-search",
  name: "自定义搜索",
  description: "提供自定义搜索功能",
  version: "1.0.0",
  author: "Developer",
  icon: "🔍",
  category: "other",
  enabled: true,

  items: [
    {
      name: "动态搜索",
      path: "dynamic-search",
      icon: "⚡",
      description: "动态生成搜索结果",
      weight: 100,
      showInModes: ["plugin"], // 只在插件搜索模式下显示
      onPluginSearch: (searchText, files) => {
        // 根据搜索文本动态生成结果
        const results = [];

        if (searchText.includes("时间")) {
          results.push({
            name: "当前时间",
            path: "current-time",
            icon: "⏰",
            description: new Date().toLocaleString("zh-CN"),
            onEnter: (params, api) => {
              api.toggleInput(false);
              console.log("当前时间:", new Date().toLocaleString("zh-CN"));
            },
          });
        }

        if (searchText.includes("文件") && files.length > 0) {
          files.forEach((file) => {
            results.push({
              name: `处理: ${file.name}`,
              path: file.path,
              icon: "📁",
              description: `处理文件: ${file.name}`,
              onEnter: (params, api) => {
                console.log("处理文件:", file);
                // 处理文件逻辑
              },
            });
          });
        }

        return results;
      },
    },
  ],
};
```

### 示例4：文件处理插件

```javascript
// config.js
module.exports = {
  id: "file-processor",
  name: "文件处理器",
  description: "处理拖拽的文件",
  version: "1.0.0",
  author: "Developer",
  icon: "📁",
  category: "system_tools",
  enabled: true,

  items: [
    {
      name: "图片压缩",
      path: "image-compress",
      icon: "🖼️",
      description: "压缩图片文件",
      weight: 100,
      showInModes: ["attachment"], // 只在附件模式下显示
      onSearch: (text, files) => {
        // 检查是否有图片文件
        return files.some((file) =>
          /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(file.name)
        );
      },
      onEnter: (params, api) => {
        const imageFiles = params.files.filter((file) =>
          /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(file.name)
        );

        console.log("压缩图片文件:", imageFiles);
        // 实现图片压缩逻辑
      },
    },
    {
      name: "文本分析",
      path: "text-analyze",
      icon: "📄",
      description: "分析文本文件",
      weight: 90,
      onSearch: (text, files) => {
        return files.some((file) => /\.(txt|md|log|csv)$/i.test(file.name));
      },
      onEnter: (params, api) => {
        const textFiles = params.files.filter((file) =>
          /\.(txt|md|log|csv)$/i.test(file.name)
        );

        console.log("分析文本文件:", textFiles);
        // 实现文本分析逻辑
      },
    },
  ],
};
```

## 最佳实践

### 1. 插件设计原则

- **单一职责**: 每个插件应该专注于一个特定的功能领域
- **用户友好**: 提供清晰的名称、描述和图标
- **性能优化**: 避免在初始化时执行耗时操作
- **错误处理**: 妥善处理异常情况，提供用户友好的错误信息
- **命名规范**: 严格遵循API命名规则，避免与系统API冲突

### 2. 代码规范

```javascript
// ✅ 正确的API命名 - 插件preload.js
contextBridge.exposeInMainWorld("myPluginAPI", {
  doSomething: () => {
    /* 插件功能 */
  },
  getPluginData: () => {
    /* 获取数据 */
  },
});

// ❌ 错误的API命名 - 会与基础preload冲突
contextBridge.exposeInMainWorld("electronAPI", {
  // 这会覆盖基础preload的API！
});

// ✅ 在HTML中正确使用API
// 基础功能使用 electronAPI
const settings = await naimo.router.storeGet("pluginSettings.my-plugin");

// 插件功能使用插件API
const result = await window.myPluginAPI.doSomething();

// 良好的错误处理
onEnter: async (params, api) => {
  try {
    const result = await naimo.router.filesystemReadFile(filePath);
    // 处理结果
  } catch (error) {
    console.error("文件读取失败:", error);
    naimo.router.logError(`插件执行失败: ${error.message}`);
  }
};

// 设置默认值
const settings = (await api.getSettingValue()) || {};
const maxItems = settings.maxItems || 10;

// 资源路径处理
const iconPath = api.getResourcePath("icons/app.png");
if (iconPath) {
  // 使用图标
}
```

### 3. 性能优化

- 使用 `weight` 属性合理排序项目
- 在 `onPluginSearch` 中实现高效的搜索算法
- 避免在回调函数中执行同步的耗时操作
- 合理使用 `hideInModes` 和 `showInModes` 控制显示

### 4. 用户体验

- 提供有意义的图标和描述
- 使用适当的 `closeAction` 设置
- 在设置中提供合理的默认值
- 支持多种搜索模式以适应不同场景

## 调试指南

### 1. 日志调试

```javascript
// 使用控制台日志
console.log("插件调试信息:", data);

// 使用系统日志
naimo.router.logInfo("插件信息日志");
naimo.router.logError("插件错误日志");
```

### 2. 开发者工具

在插件网页窗口中可以使用浏览器开发者工具进行调试：

```javascript
// 在preload.js中添加调试功能
window.addEventListener("keydown", (e) => {
  if (e.key === "F12") {
    // 打开开发者工具
    if (naimo && naimo.openDevTools) {
      naimo.openDevTools();
    }
  }
});
```

### 3. 插件状态检查

```javascript
// 检查API可用性
onEnter: (params, api) => {
  if (!api.ipcRouter) {
    console.error("IPC路由不可用");
    return;
  }

  // 检查设置
  api
    .getSettingValue()
    .then((settings) => {
      console.log("当前设置:", settings);
    })
    .catch((error) => {
      console.error("获取设置失败:", error);
    });
};
```

### 4. 常见问题解决

**问题1: 插件无法加载**

- 检查 `config.js` 语法是否正确
- 确认插件ID唯一性
- 检查必需字段是否完整

**问题2: API命名冲突**

- ❌ 检查是否使用了 `electronAPI` 作为插件API命名空间
- ✅ 改用插件特定的命名空间，如 `yourPluginAPI`
- 检查控制台是否有API覆盖警告
- 验证基础功能（如存储、文件操作）是否正常工作

**问题3: 资源文件无法访问**

- 使用 `api.getResourcePath()` 获取正确路径
- 确认文件存在于插件目录中
- 检查文件权限

**问题4: IPC调用失败**

- 确认API方法名称正确
- 检查参数类型和格式
- 查看主进程日志获取详细错误信息
- 验证是否使用了正确的API命名空间

**问题5: 搜索功能异常**

- 检查 `onSearch` 和 `onPluginSearch` 返回值格式
- 确认搜索模式配置正确
- 验证匿名搜索字段设置

**问题6: 插件功能无响应**

- 检查插件preload.js是否正确暴露了API
- 确认HTML中使用了正确的API命名空间
- 验证插件API方法是否被正确调用

## 总结

Naimo Tools 插件系统提供了强大而灵活的扩展能力。通过合理使用插件API和遵循最佳实践，开发者可以创建功能丰富、用户体验良好的插件。

在开发过程中，建议：

1. 先从简单的示例开始
2. 逐步添加复杂功能
3. 充分测试各种场景
4. 关注用户反馈和性能表现

希望这份文档能帮助您快速上手 Naimo Tools 插件开发！
