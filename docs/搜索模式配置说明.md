# 搜索模式配置说明

## 概述

新的搜索系统支持多种搜索模式，允许插件项目在不同的搜索场景下有不同的行为。每种搜索模式都有其特定的用途和配置方式。

## 搜索模式类型

### 1. 普通搜索 (NORMAL)

- **用途**: 默认的搜索模式，搜索 AppItem 的 name 字段
- **触发条件**: 默认模式，无特殊前缀
- **配置示例**:

```typescript
searchConfig: {
  mode: SearchMode.NORMAL,
  displayCondition: {
    showInModes: [SearchMode.NORMAL],
    hideInModes: [SearchMode.ATTACHMENT]
  }
}
```

### 2. 附件搜索 (ATTACHMENT)

- **用途**: 当有附件文件时，根据自定义的 onSearch 方法进行搜索
- **触发条件**: 搜索文本以 `#` 开头
- **配置示例**:

```typescript
searchConfig: {
  mode: SearchMode.ATTACHMENT,
  displayCondition: {
    showInModes: [SearchMode.ATTACHMENT],
    hideInModes: [SearchMode.NORMAL, SearchMode.COMMAND]
  }
}
```

### 3. 插件搜索 (PLUGIN)

- **用途**: 将搜索内容提供给插件，由插件返回搜索结果
- **触发条件**: 搜索文本以 `@` 开头
- **配置示例**:

```typescript
searchConfig: {
  mode: SearchMode.PLUGIN,
  displayCondition: {
    showInModes: [SearchMode.PLUGIN],
    customCondition: (searchText: string, mode: SearchMode) => {
      return searchText.includes('plugin') || searchText.includes('工具')
    }
  },
  onPluginSearch: (searchText: string, files: AttachedFile[]) => {
    // 插件搜索回调，返回搜索结果
    return [
      {
        name: `插件搜索结果: ${searchText}`,
        path: `plugin-result-${searchText}`,
        icon: null,
        executeType: PluginExecuteType.OPEN_APP
      }
    ]
  }
}
```

## 显示条件配置

### PluginItem 搜索字段

```typescript
interface PluginItem extends AppItem {
  // ... 其他字段

  /** 在哪些搜索模式下显示 */
  showInModes?: SearchMode[];
  /** 在哪些搜索模式下隐藏 */
  hideInModes?: SearchMode[];
  /** 匿名搜索字段列表（用于匿名搜索匹配） */
  anonymousSearchFields?: string[];
}
```

### 使用示例

#### 1. 只在特定模式下显示

```typescript
const item: PluginItem = {
  name: "示例项目",
  path: "example",
  icon: null,
  executeType: PluginExecuteType.OPEN_APP,
  showInModes: [SearchMode.ATTACHMENT],
  hideInModes: [SearchMode.NORMAL],
};
```

#### 2. 在多种模式下显示

```typescript
const item: PluginItem = {
  name: "多模式项目",
  path: "multi-mode",
  icon: null,
  executeType: PluginExecuteType.OPEN_APP,
  showInModes: [SearchMode.NORMAL, SearchMode.ATTACHMENT],
  onSearch: (text: string, files: AttachedFile[]) => {
    // 在附件搜索模式下的自定义条件
    return text.includes("file") && text.includes("multi");
  },
};
```

#### 3. 匿名搜索示例

```typescript
const item: PluginItem = {
  name: "匿名搜索项目",
  path: "anonymous",
  icon: null,
  executeType: PluginExecuteType.OPEN_APP,
  showInModes: [SearchMode.NORMAL],
  anonymousSearchFields: ["工具", "utility", "helper", "助手"],
};
```

## 搜索触发方式

### 1. 普通搜索

- 直接输入搜索文本
- 例如: `notepad`, `chrome`, `文件`

### 2. 附件搜索

- 搜索文本以 `#` 开头
- 或者传入了 `attachedFiles` 参数
- 例如: `#file`, `#image`, `#document`

### 3. 插件搜索

- 搜索文本以 `@` 开头
- 或者传入了 `attachedPluginItems` 参数
- 例如: `@plugin`, `@工具`, `@search`

## 搜索模式检测逻辑

搜索模式按以下优先级检测：

1. **插件搜索模式**：
   - 搜索文本以 `@` 开头
   - 或者传入了 `attachedPluginItems` 参数且不为空

2. **附件搜索模式**：
   - 搜索文本以 `#` 开头
   - 或者传入了 `attachedFiles` 参数且不为空

3. **普通搜索模式**：
   - 默认模式，包括匿名搜索

## 使用示例

```typescript
// 普通搜索
const normalResults = await searchEngine.performSearch("notepad");

// 附件搜索（通过前缀）
const attachmentResults1 = await searchEngine.performSearch("#file");

// 附件搜索（通过参数）
const attachmentResults2 = await searchEngine.performSearch(
  "file",
  attachedFiles
);

// 插件搜索（通过前缀）
const pluginResults1 = await searchEngine.performSearch("@plugin");

// 插件搜索（通过参数）
const pluginResults2 = await searchEngine.performSearch(
  "plugin",
  undefined,
  attachedPluginItems
);
```

## 完整配置示例

```typescript
const examplePluginItem: PluginItem = {
  name: "示例插件项目",
  path: "example-plugin-item",
  icon: null,
  executeType: PluginExecuteType.OPEN_APP,

  // 附件搜索回调（附件搜索模式使用）
  onSearch: (text: string, files: AttachedFile[]) => {
    return files.length > 0 && text.includes("file");
  },

  // 显示条件配置
  showInModes: [SearchMode.ATTACHMENT],
  hideInModes: [SearchMode.NORMAL],

  // 匿名搜索字段
  anonymousSearchFields: ["示例", "example", "demo"],
};
```

## 注意事项

1. **搜索模式优先级**: 插件搜索 > 附件搜索 > 普通搜索
2. **显示条件**: 如果配置了 `hideInModes`，会优先检查隐藏条件
3. **匿名搜索**: 在普通搜索模式下，会同时匹配 `name` 和 `anonymousSearchFields` 中的字段
4. **插件搜索**: 只有在 `SearchMode.PLUGIN` 模式下才会使用 `onPluginSearch`

## 迁移指南

### 从旧版本迁移

1. 为现有的 `PluginItem` 添加 `showInModes`、`hideInModes` 和 `anonymousSearchFields` 字段
2. 根据需求配置显示条件，确保项目在正确的搜索模式下显示
3. 测试各种搜索场景，确保行为符合预期

### 最佳实践

1. **明确搜索用途**: 根据项目的实际用途选择合适的搜索模式
2. **合理配置显示条件**: 避免项目在不合适的搜索模式下显示
3. **测试各种场景**: 确保在不同搜索模式下都能正常工作
