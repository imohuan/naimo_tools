# 设置系统扩展说明

## 概述

将原有的插件设置系统扩展为通用的设置系统，支持应用程序设置和插件设置的统一管理。

**设计原则**：

- 应用设置直接映射到 `AppConfig` 接口的字段，无需额外的存储层
- 插件设置使用独立的 `pluginSettings` 存储
- 不包括运行时数据（如 recentApps, pinnedApps, fileList, installedPlugins）
- 不包括有专门管理页面的配置（如 hotkeys, customHotkeys）
- 不包括 UI 常量等不应由用户修改的配置

## 主要变更

### 1. 创建类型定义

**文件**: `src/renderer/src/typings/settingTypes.ts`

新增设置相关类型定义文件，定义了通用的设置配置和设置项接口：

```typescript
/** 设置配置接口 - JSON配置驱动生成设置组件 */
export type SettingConfig = {
  name: string;
  title: string;
  description: string;
  type:
    | "input"
    | "select"
    | "checkbox"
    | "radio"
    | "textarea"
    | "number"
    | "date"
    | "time"
    | "datetime"
    | "file"
    | "image"
    | "video"
    | "audio"
    | "url"
    | "email"
    | "password"
    | "tel"
    | "search"
    | "range"
    | "color"
    | "hidden";
  defaultValue?: (() => any) | any;
  required?: boolean;
  option?: any;
  children?: SettingConfig[];
};

/** 通用设置项接口 */
export interface SettingItem {
  id: string;
  name: string;
  icon?: string;
  description?: string;
  settings: SettingConfig[];
  type: "app" | "plugin";
}
```

**主要变更**：

- 将 `SettingConfig` 从 `pluginTypes.ts` 移至 `settingTypes.ts`
- `pluginTypes.ts` 中重新导出 `SettingConfig` 以保持向后兼容
- 该类型统一用于应用设置和插件设置，并在 `src/renderer/src/typings/index.ts` 中导出

### 2. 创建应用设置配置文件

**文件**: `src/renderer/src/config/appSettings.ts`

新增了应用程序设置配置文件，包含以下设置项：

- **系统设置** (`app`): autoStart, alwaysOnTop, language, theme, logLevel

**重要说明**：

- 配置中的 `name` 字段必须与 `AppConfig` 接口中的字段名一致
- 设置项会直接读写 `AppConfig` 对应的字段，无需额外的存储层
- 配置类型使用 `Omit<SettingItem, 'type'>[]`，省略 `type` 字段（在加载时动态添加）

### 3. 重命名和重构设置组件

**变更内容**:

- 文件夹从 `views/PluginSettings` 重命名为 `views/Settings`
- 组件接口从局部定义改为使用统一的 `SettingItem` 类型（定义在 `@/typings/settingTypes.ts`）
- 添加 `type` 字段区分应用设置 (`app`) 和插件设置 (`plugin`)
- 组件名从 `SettingItem` 改为 `SettingItemComponent` 以避免与类型名冲突

### 4. 更新设置页面逻辑

**文件**: `src/renderer/src/views/Settings/index.vue`

**主要变更**:

- 加载应用设置和插件设置的统一入口 `getAllSettings()`
- **应用设置直接读写 `AppConfig` 对应字段**，无需 `appSettings` 中间层
- 插件设置存储在 `pluginSettings`
- 保存功能：应用设置逐字段保存到 `AppConfig`，插件设置批量保存
- 重置功能：应用设置删除 `AppConfig` 对应字段以恢复默认值

**核心方法**:

```typescript
// 获取所有设置（应用设置 + 插件设置）
const getAllSettings = async () => {
  // 1. 加载应用设置 - 从 AppConfig 读取对应字段
  for (const appSetting of appSettingsConfig) {
    for (const setting of appSetting.settings) {
      const savedValue = await storeUtils.get(setting.name as any);
      settingValues[appSetting.id][setting.name] =
        savedValue ?? getDefaultValue(setting);
    }
  }

  // 2. 加载插件设置
  const savedPluginSettings = (await storeUtils.get("pluginSettings")) || {};
  // ... 初始化插件设置
};

// 保存所有设置
const saveAllSettings = async () => {
  // 1. 保存应用设置 - 直接设置到 AppConfig 对应字段
  for (const settingGroup of settingsList) {
    if (settingGroup.type === "app") {
      for (const setting of settingGroup.settings) {
        await storeUtils.set(setting.name as any, value);
      }
    }
  }

  // 2. 保存插件设置
  await storeUtils.set("pluginSettings", pluginSettings);
};

// 重置所有设置
const resetAllSettings = async () => {
  // 应用设置：删除 AppConfig 对应字段
  if (settingGroup.type === "app") {
    await storeUtils.delete(setting.name as any);
  }

  // 插件设置：清空存储
  await storeUtils.set("pluginSettings", {});
};
```

### 5. 更新设置项组件

**文件**: `src/renderer/src/views/Settings/SettingItem.vue`

**变更内容**:

- Props 从 `pluginId` 改为更通用的 `settingId`
- 完善 `range` 类型设置项的选项读取：
  - `min`: 最小值（默认 0）
  - `max`: 最大值（默认 100）
  - `step`: 步长（默认 1）

### 6. 类型系统更新

**文件**: `src/shared/typings/appTypes.ts`

删除了 `appSettings` 字段，应用设置直接使用 `AppConfig` 的现有字段：

```typescript
export interface AppConfig {
  theme: "light" | "dark"; // 主题设置
  language: string; // 语言设置
  logLevel: "error" | "warn" | "info" | "debug"; // 日志级别
  autoStart?: boolean; // 开机自启
  alwaysOnTop?: boolean; // 窗口置顶
  // ... 其他字段
  /** 插件设置存储 */
  pluginSettings?: Record<string, Record<string, any>>;
}
```

**文件**: `src/renderer/src/typings/settingTypes.ts` 和 `src/renderer/src/typings/pluginTypes.ts`

- 将 `SettingConfig` 类型从 `pluginTypes.ts` 移至 `settingTypes.ts`
- 在 `pluginTypes.ts` 中导入使用（不再重新导出）：
  ```typescript
  import type { SettingConfig } from './settingTypes'
  // 在 PluginConfig 接口中使用
  settings?: SettingConfig[]
  ```

### 7. 路由更新

**文件**: `src/renderer/src/pages/settings/router.ts`

更新设置页面路由：

```typescript
{
  path: "/settings",              // 从 /plugin-settings 改为 /settings
  name: "settings",               // 从 plugin-settings 改为 settings
  component: () => import("@/views/Settings/index.vue"),  // 更新路径
  meta: {
    title: "设置",
    description: "配置应用程序和插件的个性化设置",  // 更新描述
    icon: "mdi:settings",
    keepAlive: true,
  },
}
```

## 使用方式

### 添加新的应用设置

在 `src/renderer/src/config/appSettings.ts` 中添加新的设置组或设置项：

```typescript
import type { SettingItem } from "@/typings";

export const appSettingsConfig: Omit<SettingItem, "type">[] = [
  // ... 现有设置组
  {
    id: "new-group",
    name: "新设置组",
    icon: "🎯",
    description: "这是一个新的设置组",
    settings: [
      {
        name: "newSetting",
        title: "新设置",
        description: "这是一个新设置的描述",
        type: "checkbox",
        defaultValue: false,
      },
      // ... 更多设置项
    ],
  },
];
```

注意：配置中不需要显式指定 `type` 字段，它会在加载时自动添加为 `'app'`。

### 支持的设置类型

- `input`: 文本输入框
- `password`: 密码输入框
- `textarea`: 文本域
- `number`: 数字输入
- `checkbox`: 复选框
- `select`: 下拉选择（需配置 `option.options`）
- `color`: 颜色选择器
- `range`: 范围滑块（需配置 `option.min/max/step`）
- `file`: 文件选择

### 读取设置值

```typescript
import { storeUtils } from "@/core/utils/store";

// 读取应用设置 - 直接读取 AppConfig 字段
const autoStart = await storeUtils.get("autoStart");
const theme = await storeUtils.get("theme");
const language = await storeUtils.get("language");

// 读取插件设置
const pluginSettings = await storeUtils.get("pluginSettings");
const specificPluginSettings = pluginSettings?.["plugin-id"];
```

## 存储结构

设置数据存储在本地存储中，结构如下：

```typescript
{
  // 应用设置 - 直接存储在 AppConfig 顶层
  autoStart: false,
  language: "zh-CN",
  theme: "light",
  logLevel: "info",
  alwaysOnTop: false,

  // 插件设置 - 使用专门的存储键
  pluginSettings: {
    "plugin-id-1": {
      setting1: "value1",
      setting2: "value2"
    },
    "plugin-id-2": {
      // ... 插件设置
    }
  },

  // 运行时数据（不在设置页面中配置）
  recentApps: [...],
  pinnedApps: [...],
  fileList: [...],
  installedPlugins: [...],
  hotkeys: {...},
  customHotkeys: [...]
}
```

## 注意事项

1. **默认值处理**: 设置项的 `defaultValue` 可以是值或函数，函数会在初始化时执行
2. **类型安全**: 使用 TypeScript 确保类型安全，避免运行时错误
3. **存储结构**:
   - 应用设置直接映射到 `AppConfig` 字段，无中间层
   - 插件设置使用独立的 `pluginSettings` 存储
4. **字段命名**: 应用设置的 `name` 必须与 `AppConfig` 接口字段名一致
5. **缓存策略**: `storeUtils` 内部实现了缓存机制，提高读取性能
6. **配置范围**: 只配置适合在设置页面修改的字段，排除运行时数据和有专门管理页面的配置

## 未来扩展

- [ ] 添加设置项验证功能
- [ ] 支持设置项的条件显示/隐藏
- [ ] 添加设置导入/导出功能
- [ ] 支持设置搜索功能
- [ ] 添加设置变更历史记录
