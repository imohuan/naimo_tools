# 调试指南

## 概述

本项目提供了完整的调试环境，支持对主进程、渲染进程和预加载脚本进行断点调试。通过 VS Code 的调试配置，可以方便地进行代码调试和问题排查。

## 调试配置

### VS Code 调试配置

项目已配置好 `.vscode/launch.json` 文件，包含以下调试配置：

```json
{
  "version": "0.2.0",
  "configurations": [...]
  "compounds": [
    {
      "name": "🚀 开始调试",
      "configurations": [
        "🔧 启动开发服务器",
        "🔧 Electron: 主进程",
        "🔧 Electron: 渲染进程",
        "🔧 Electron: Preload"
      ],
      "stopAll": true
    }
  ]
}

```

### 启动调试

1. 在 VS Code 中按 `F5` 或点击调试面板中的 "🚀 开始调试"
2. 应用将启动并自动连接调试器
3. 可以在代码中设置断点进行调试

## 调试不同进程

### 主进程调试

主进程是 Electron 应用的核心，负责创建和管理应用窗口。

**调试步骤**：

1. 在 `src/main/` 目录下的 TypeScript 文件中设置断点
2. 启动调试会话
3. 触发相应的功能，断点会被命中

**示例**：

```typescript
// src/main/main.ts
import { app, BrowserWindow } from "electron";
import log from "electron-log";

app.whenReady().then(() => {
  log.info("应用启动"); // 在这里设置断点
  createWindow();
});
```

### 渲染进程调试

渲染进程运行在浏览器环境中，可以使用 Chrome DevTools 进行调试。

**调试步骤**：

1. 在 `src/renderer/` 目录下的 Vue 组件或 TypeScript 文件中设置断点
2. 启动调试会话
3. 在应用窗口中触发相应功能

**示例**：

```typescript
// src/renderer/src/App.vue
<script setup lang="ts">
import { onMounted } from 'vue';

onMounted(() => {
  console.log('组件挂载'); // 在这里设置断点
  // 或者使用 debugger 语句
  debugger;
});
</script>
```

### 预加载脚本调试

预加载脚本在主进程和渲染进程之间运行，调试相对复杂。

**调试步骤**：

1. 在 `src/main/preloads/` 目录下的文件中设置断点
2. 如果断点不生效，先使用 `debugger` 语句
3. 启动调试会话，断点会被命中

**示例**：

```typescript
// src/main/preloads/basic.ts
import { contextBridge } from "electron";

// 使用 debugger 语句强制断点
debugger;

contextBridge.exposeInMainWorld("electronAPI", {
  // 在这里设置断点
  log: {
    info: (message: string) => {
      console.log(message); // 断点位置
    },
  },
});
```

## 调试技巧

### 1. 使用 debugger 语句

当 VS Code 断点不生效时，可以使用 `debugger` 语句：

```typescript
function someFunction() {
  debugger; // 强制断点
  // 代码执行会在这里暂停
  console.log("调试信息");
}
```

### 2. 控制台调试

在调试过程中，可以使用 VS Code 的调试控制台：

```typescript
// 在断点处，可以在控制台中执行以下命令：
// 查看变量值
console.log(variableName);

// 执行表达式
someFunction();

// 查看对象属性
Object.keys(someObject);
```

### 3. 条件断点

设置条件断点，只在特定条件下触发：

1. 右键点击断点
2. 选择 "编辑断点"
3. 输入条件表达式

```typescript
// 示例：只在 userId 大于 100 时触发断点
function processUser(userId: number) {
  // 条件断点：userId > 100
  console.log("处理用户", userId);
}
```

### 4. 日志断点

使用日志断点记录信息而不暂停执行：

1. 右键点击断点
2. 选择 "编辑断点"
3. 输入日志消息

```typescript
// 示例：记录函数调用而不暂停
function apiCall(data: any) {
  // 日志断点：`API调用: ${JSON.stringify(data)}`
  return fetch("/api", { method: "POST", body: JSON.stringify(data) });
}
```

## 常见调试场景

### 1. IPC 通信调试

调试主进程和渲染进程之间的通信：

```typescript
// 主进程 - src/main/ipc-router/modules/app.ts
export function getVersion(): string {
  debugger; // 断点：查看调用参数
  const version = app.getVersion();
  log.info("获取版本", version); // 断点：查看返回值
  return version;
}

// 渲染进程
const version = await api.ipcRouter.appGetVersion(); // 断点：查看调用结果
console.log("应用版本:", version);
```

### 2. 错误调试

调试应用中的错误：

```typescript
// 使用 try-catch 包装可能出错的代码
try {
  const result = await someAsyncOperation();
  debugger; // 断点：查看成功结果
} catch (error) {
  debugger; // 断点：查看错误信息
  log.error("操作失败", error);
}
```

### 3. 性能调试

调试性能问题：

```typescript
// 使用 performance API 测量执行时间
const startTime = performance.now();

// 执行一些操作
await someOperation();

const endTime = performance.now();
debugger; // 断点：查看执行时间
console.log(`操作耗时: ${endTime - startTime}ms`);
```

## 调试工具

### 1. Chrome DevTools

渲染进程可以使用 Chrome DevTools：

1. 在应用窗口中按 `F12` 或 `Ctrl+Shift+I`
2. 使用 Sources 面板设置断点
3. 使用 Console 面板执行命令
4. 使用 Network 面板查看网络请求

### 2. VS Code 调试面板

VS Code 调试面板提供以下功能：

- **变量面板**: 查看当前作用域中的变量
- **监视面板**: 监视特定表达式的值
- **调用堆栈**: 查看函数调用链
- **断点面板**: 管理所有断点

### 3. 日志调试

使用项目集成的日志系统进行调试：

```typescript
// 主进程
import log from "electron-log";
log.debug("调试信息", { data: someData });

// 渲染进程
api.log.debug("渲染进程调试", { component: "App" });
```

## 常见问题解决

### Q: 断点不生效怎么办？

A:

1. 确保代码已编译（运行 `pnpm build`）
2. 使用 `debugger` 语句替代断点
3. 检查 VS Code 调试配置是否正确
4. 重启调试会话

### Q: 预加载脚本断点无效？

A:

1. 先在代码中添加 `debugger` 语句
2. 确保预加载脚本已正确加载
3. 检查 `contextBridge.exposeInMainWorld` 是否正确配置

### Q: 渲染进程断点无效？

A:

1. 确保 Vue 组件已正确挂载
2. 使用 Chrome DevTools 作为备选方案
3. 检查热重载是否影响断点

### Q: 如何调试异步代码？

A:

1. 在 async/await 函数中设置断点
2. 使用 Promise 的 then/catch 回调设置断点
3. 使用 `console.log` 跟踪异步执行流程

## 调试最佳实践

1. **使用有意义的断点**: 在关键逻辑处设置断点
2. **记录调试信息**: 使用日志记录重要的调试信息
3. **逐步调试**: 使用步进功能逐步执行代码
4. **清理断点**: 调试完成后及时清理断点
5. **使用条件断点**: 在特定条件下触发断点
6. **组合使用工具**: 结合 VS Code 和 Chrome DevTools 进行调试

## 性能调试

### 1. 内存泄漏检测

```typescript
// 使用 Chrome DevTools 的 Memory 面板
// 或使用 Node.js 的 --inspect 标志
process.memoryUsage(); // 查看内存使用情况
```

### 2. CPU 性能分析

```typescript
// 使用 Chrome DevTools 的 Performance 面板
// 或使用 console.time/timeEnd
console.time("operation");
await someOperation();
console.timeEnd("operation");
```

### 3. 网络请求调试

```typescript
// 使用 Chrome DevTools 的 Network 面板
// 或在代码中添加请求日志
fetch("/api/data")
  .then((response) => {
    debugger; // 断点：查看响应
    return response.json();
  })
  .then((data) => {
    debugger; // 断点：查看数据
    console.log(data);
  });
```
