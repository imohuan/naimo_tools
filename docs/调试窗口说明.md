# 调试窗口说明

## 概述

调试窗口是一个显示在屏幕右下角的可展开调试面板，用于实时监控应用的性能、窗口状态、视图生命周期等信息。

## 功能特性

### 1. 可视化状态

- **折叠状态**：显示一个紫色渐变圆球，展示关键指标（内存使用、活跃视图数）
- **展开状态**：完整的调试面板，包含详细的系统信息

### 2. 监控内容

#### 性能指标

- 内存使用量（MB）
- CPU 使用率（%）
- 活跃视图数
- 视图切换时间（ms）

#### 窗口信息

- 所有窗口列表
- 窗口类型（主窗口/分离窗口）
- 窗口可见性和焦点状态
- 窗口位置和尺寸

#### 视图信息

- 所有视图列表
- 视图类型和类别
- 生命周期状态（活跃/暂停）
- 视图内存使用量
- 最后访问时间

#### 生命周期统计

- 总视图数
- 活跃视图数
- 暂停视图数
- 平均内存使用

#### 系统信息

- 操作系统平台
- Electron 版本
- Node.js 版本
- Chrome 版本
- 应用版本
- 运行时间

## 使用方式

### 启用调试窗口

在 `src/main/main.ts` 中配置：

```typescript
const appBootstrap = new AppBootstrap({
  // ... 其他配置
  debug: {
    enabled: true, // 启用调试窗口
    updateInterval: 1000, // 更新间隔（毫秒）
    position: {
      offsetX: 20, // 距离右边缘的偏移
      offsetY: 20, // 距离底部的偏移
    },
  },
});
```

### 默认配置

- **开发环境**：自动启用调试窗口
- **生产环境**：默认禁用调试窗口（建议保持禁用）

### 交互操作

1. **点击圆球**：展开调试面板
2. **点击关闭按钮**：折叠调试面板
3. **自动更新**：每秒自动刷新数据（可配置）

## 技术实现

### 架构组成

```
调试系统
├── DebugService (主进程)
│   ├── 创建调试窗口
│   ├── 收集调试信息
│   ├── 定时推送数据
│   └── 管理窗口状态
│
├── debug.ts (IPC 路由)
│   ├── toggleDebugWindow
│   ├── showDebugWindow
│   └── hideDebugWindow
│
└── debug-window (渲染进程)
    ├── index.html
    ├── main.ts
    └── App.vue
```

### 窗口特性

- **无边框透明窗口**：提供现代化的 UI 体验
- **始终置顶**：确保调试信息始终可见
- **不在任务栏显示**：避免干扰正常工作流
- **点击穿透**（可选）：不影响其他窗口操作
- **自动定位**：固定在屏幕右下角

### 数据流

```
WindowManager → LifecycleManager → DebugService → IPC → DebugWindow
     ↓              ↓                    ↓
  窗口信息      生命周期统计         性能指标
```

## IPC API

### 切换展开状态

```typescript
// 从渲染进程调用
await window.electron.ipcRenderer.invoke("debug:toggleDebugWindow");
```

### 显示调试窗口

```typescript
await window.electron.ipcRenderer.invoke("debug:showDebugWindow");
```

### 隐藏调试窗口

```typescript
await window.electron.ipcRenderer.invoke("debug:hideDebugWindow");
```

### 监听数据更新

```typescript
window.electron.ipcRenderer.on("debug:update", (event, debugInfo) => {
  console.log("调试信息更新", debugInfo);
});
```

## 性能优化

### 数据收集优化

- 只在窗口可见时进行详细数据收集
- 使用缓存减少重复计算
- 异步收集，避免阻塞主进程

### UI 渲染优化

- 虚拟滚动处理大量数据
- 防抖更新，避免频繁重绘
- CSS 动画使用 GPU 加速

### 内存管理

- 定期清理过期数据
- 限制历史数据缓存
- 及时释放不需要的资源

## 开发建议

### 生产环境

- 建议**禁用**调试窗口，避免性能开销
- 如需调试，可通过配置临时启用

### 开发环境

- 建议**启用**调试窗口，方便开发调试
- 可调整更新频率平衡性能和实时性

### 自定义扩展

如需添加自定义调试信息：

1. 在 `DebugService.collectDebugInfo()` 中添加数据收集逻辑
2. 在 `DebugInfo` 类型中添加新字段
3. 在 `App.vue` 中添加对应的 UI 展示

## 故障排查

### 调试窗口不显示

1. 检查 `debug.enabled` 配置是否为 `true`
2. 查看日志确认服务是否正常初始化
3. 确认窗口管理器已正确初始化

### 数据不更新

1. 检查 `updateInterval` 配置
2. 确认 IPC 通信正常
3. 查看浏览器控制台是否有错误

### 性能问题

1. 增加 `updateInterval` 值，降低更新频率
2. 检查是否有大量视图导致计算开销
3. 考虑禁用调试窗口

## 相关文件

- `src/main/services/DebugService.ts` - 调试服务主逻辑
- `src/main/ipc-router/modules/debug.ts` - IPC 路由处理
- `src/renderer/src/pages/debug-window/` - 调试窗口 UI
- `src/main/core/AppBootstrap.ts` - 服务注册和初始化
- `docs/调试窗口说明.md` - 本文档

## 更新日志

### v1.0.0 (2025-10-07)

- ✨ 初始版本
- ✅ 基础性能监控
- ✅ 窗口和视图信息展示
- ✅ 生命周期统计
- ✅ 系统信息展示
- ✅ 折叠/展开切换
