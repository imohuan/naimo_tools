<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½ç¿»è¯‘</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    .input-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #e0e0e0;
    }

    .middle-section {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
    }

    .translate-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .language-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .language-select {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #333;
      cursor: pointer;
      min-width: 80px;
    }

    .language-select:focus {
      outline: none;
      border-color: #4285f4;
    }

    .swap-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .swap-btn:hover {
      background: #f0f0f0;
    }

    .output-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .text-input {
      flex: 1;
      position: relative;
      padding: 20px;
    }

    .text-area {
      width: 100%;
      height: 100%;
      border: none;
      resize: none;
      font-size: 16px;
      line-height: 1.5;
      outline: none;
      font-family: inherit;
    }

    .text-area::placeholder {
      color: #999;
    }

    .translate-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 60px;
      justify-content: center;
    }

    .translate-btn:hover {
      background: #3367d6;
    }

    .translate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .translate-btn .btn-spinner {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: btnSpin 1s linear infinite;
    }

    .translate-btn.loading .btn-spinner {
      display: block;
    }

    @keyframes btnSpin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .output-area {
      flex: 1;
      padding: 20px;
      background: #fafafa;
      color: #333;
      font-size: 16px;
      line-height: 1.5;
      overflow-y: auto;
    }

    .output-placeholder {
      color: #999;
    }

    .char-count {
      position: absolute;
      bottom: 20px;
      left: 20px;
      font-size: 12px;
      color: #999;
    }


    .error-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px 20px;
      border-radius: 6px;
      display: none;
      z-index: 1000;
    }

    .error-message.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #efe;
      border: 1px solid #cfc;
      color: #363;
      padding: 12px 20px;
      border-radius: 6px;
      display: none;
      z-index: 1000;
    }

    .success-message.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s;
      z-index: 100;
    }

    .settings-btn:hover {
      background: #f0f0f0;
    }

    .settings-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 1000;
      min-width: 250px;
    }

    .settings-panel.show {
      display: block;
    }

    .setting-item {
      margin-bottom: 15px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #333;
    }

    .setting-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .setting-checkbox {
      margin-right: 8px;
    }

    .save-settings-btn {
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .save-settings-btn:hover {
      background: #3367d6;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ä¸Šæ–¹è¾“å…¥åŒºåŸŸ -->
    <div class="input-section">
      <div class="text-input">
        <textarea id="sourceText" class="text-area" placeholder="è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬..." maxlength="5000"></textarea>
        <button id="translateBtn" class="translate-btn">
          <div class="btn-spinner"></div>
          <span>ç¿»è¯‘</span>
        </button>
        <div class="char-count" id="sourceCharCount">0 / 5000</div>
      </div>
    </div>

    <!-- ä¸­é—´åŒºåŸŸ -->
    <div class="middle-section">
      <div class="translate-logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M12.87 15.07L10.33 12.56L10.36 12.53C12.1 10.59 13.34 8.36 14.07 6H17V4H10V2H8V4H1V6H12.17C11.5 7.92 10.44 9.75 9 11.35C8.07 10.32 7.3 9.19 6.69 8H4.69C5.42 9.63 6.42 11.17 7.67 12.56L2.58 17.58L4 19L9 14L12.11 17.11L12.87 15.07ZM18.5 10H16.5L12 22H14L15.12 19H19.87L21 22H23L18.5 10ZM15.88 17L17.5 12.67L19.12 17H15.88Z"
            fill="#4285f4" />
        </svg>
        <span>ç¿»è¯‘</span>
      </div>

      <div class="language-controls">
        <select id="sourceLanguage" class="language-select">
          <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">è‹±è¯­</option>
          <option value="ja">æ—¥è¯­</option>
          <option value="ko">éŸ©è¯­</option>
          <option value="fr">æ³•è¯­</option>
          <option value="de">å¾·è¯­</option>
          <option value="es">è¥¿ç­ç‰™è¯­</option>
          <option value="ru">ä¿„è¯­</option>
          <option value="pt">è‘¡è„ç‰™è¯­</option>
          <option value="it">æ„å¤§åˆ©è¯­</option>
          <option value="ar">é˜¿æ‹‰ä¼¯è¯­</option>
          <option value="th">æ³°è¯­</option>
          <option value="vi">è¶Šå—è¯­</option>
        </select>

        <button id="swapLanguages" class="swap-btn" title="äº¤æ¢è¯­è¨€">â‡„</button>

        <select id="targetLanguage" class="language-select">
          <option value="zh">ä¸­æ–‡</option>
          <option value="en">è‹±è¯­</option>
          <option value="ja">æ—¥è¯­</option>
          <option value="ko">éŸ©è¯­</option>
          <option value="fr">æ³•è¯­</option>
          <option value="de">å¾·è¯­</option>
          <option value="es">è¥¿ç­ç‰™è¯­</option>
          <option value="ru">ä¿„è¯­</option>
          <option value="pt">è‘¡è„ç‰™è¯­</option>
          <option value="it">æ„å¤§åˆ©è¯­</option>
          <option value="ar">é˜¿æ‹‰ä¼¯è¯­</option>
          <option value="th">æ³°è¯­</option>
          <option value="vi">è¶Šå—è¯­</option>
        </select>
      </div>
    </div>

    <!-- ä¸‹æ–¹è¾“å‡ºåŒºåŸŸ -->
    <div class="output-section">
      <div id="targetText" class="output-area">
        <div class="output-placeholder">ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®æŒ‰é’® -->
  <button id="settingsBtn" class="settings-btn" title="è®¾ç½®">âš™ï¸</button>

  <!-- è®¾ç½®é¢æ¿ -->
  <div id="settingsPanel" class="settings-panel">
    <div class="setting-item">
      <label class="setting-label">
        <input type="checkbox" id="autoTranslateCheck" class="setting-checkbox">
        è‡ªåŠ¨ç¿»è¯‘ï¼ˆè¾“å…¥å1ç§’è‡ªåŠ¨ç¿»è¯‘ï¼‰
      </label>
    </div>

    <div class="setting-item">
      <label class="setting-label">
        <input type="checkbox" id="saveHistoryCheck" class="setting-checkbox">
        ä¿å­˜ç¿»è¯‘å†å²è®°å½•
      </label>
    </div>

    <div class="setting-item">
      <label class="setting-label">å†å²è®°å½•ä¿å­˜æ•°é‡</label>
      <input type="number" id="maxHistoryInput" class="setting-input" min="10" max="200" placeholder="50">
    </div>

    <button id="saveSettingsBtn" class="save-settings-btn">ä¿å­˜è®¾ç½®</button>
  </div>

  <!-- æ¶ˆæ¯æç¤º -->
  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>

  <script>
    // å…¨å±€å˜é‡
    let translationHistory = [];
    let autoTranslateTimer = null;
    let pluginSettings = {};
    let translationTimeout = null;

    // DOMå…ƒç´ 
    const sourceText = document.getElementById('sourceText');
    const targetText = document.getElementById('targetText');
    const sourceLanguage = document.getElementById('sourceLanguage');
    const targetLanguage = document.getElementById('targetLanguage');
    const translateBtn = document.getElementById('translateBtn');
    const swapLanguagesBtn = document.getElementById('swapLanguages');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const sourceCharCount = document.getElementById('sourceCharCount');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const autoTranslateCheck = document.getElementById('autoTranslateCheck');
    const saveHistoryCheck = document.getElementById('saveHistoryCheck');
    const maxHistoryInput = document.getElementById('maxHistoryInput');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSettings();
      loadHistory();
      setupEventListeners();

      // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ å…¥çš„æ–‡æœ¬éœ€è¦ç¿»è¯‘
      const urlParams = new URLSearchParams(window.location.search);
      const textToTranslate = urlParams.get('text');
      if (textToTranslate) {
        sourceText.value = decodeURIComponent(textToTranslate);
        updateCharCount();
        if (pluginSettings.autoTranslate) {
          setTimeout(() => translate(), 500);
        }
      } else {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥æ–‡æœ¬ï¼Œå°è¯•ä»å‰ªåˆ‡æ¿è·å–ä¸­æ–‡æ–‡æœ¬
        await tryLoadClipboardText();
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯çƒ­é”®è§¦å‘çš„è‡ªåŠ¨ç¿»è¯‘
      await checkHotkeyAutoTranslate();
    });

    // åŠ è½½è®¾ç½®
    async function loadSettings() {
      try {
        // ä½¿ç”¨åŸºç¡€preloadæä¾›çš„IPCè·¯ç”±è·å–æ’ä»¶è®¾ç½®
        if (naimo && naimo.router) {
          pluginSettings = await naimo.router.storeGet('pluginSettings.translate-plugin') || {};
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½UIè®¾ç½®
        const uiSettings = JSON.parse(localStorage.getItem('translate-ui-settings') || '{}');

        // è®¾ç½®é»˜è®¤è¯­è¨€
        sourceLanguage.value = uiSettings.defaultSource || 'auto';
        targetLanguage.value = uiSettings.defaultTarget || 'zh';

        // è®¾ç½®è‡ªåŠ¨ç¿»è¯‘
        if (uiSettings.autoTranslate !== undefined) {
          pluginSettings.autoTranslate = uiSettings.autoTranslate;
        } else {
          pluginSettings.autoTranslate = true; // é»˜è®¤å¼€å¯
        }

        // è®¾ç½®å†å²è®°å½•
        if (uiSettings.saveHistory !== undefined) {
          pluginSettings.saveHistory = uiSettings.saveHistory;
        } else {
          pluginSettings.saveHistory = true; // é»˜è®¤å¼€å¯
        }

        pluginSettings.maxHistoryCount = uiSettings.maxHistoryCount || 50;

        // æ›´æ–°UIå…ƒç´ 
        autoTranslateCheck.checked = pluginSettings.autoTranslate;
        saveHistoryCheck.checked = pluginSettings.saveHistory;
        maxHistoryInput.value = pluginSettings.maxHistoryCount;
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
      }
    }

    // åŠ è½½å†å²è®°å½•
    function loadHistory() {
      try {
        const saved = localStorage.getItem('translate-history');
        if (saved) {
          translationHistory = JSON.parse(saved);
        }
      } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
      }
    }

    // ä¿å­˜å†å²è®°å½•
    function saveHistory() {
      try {
        if (pluginSettings.saveHistory !== false) {
          const maxCount = pluginSettings.maxHistoryCount || 50;
          if (translationHistory.length > maxCount) {
            translationHistory = translationHistory.slice(-maxCount);
          }
          localStorage.setItem('translate-history', JSON.stringify(translationHistory));
        }
      } catch (error) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
      }
    }

    // ä¿å­˜UIè®¾ç½®
    function saveUISettings() {
      try {
        const uiSettings = {
          defaultSource: sourceLanguage.value,
          defaultTarget: targetLanguage.value,
          autoTranslate: pluginSettings.autoTranslate,
          saveHistory: pluginSettings.saveHistory,
          maxHistoryCount: pluginSettings.maxHistoryCount
        };
        localStorage.setItem('translate-ui-settings', JSON.stringify(uiSettings));
      } catch (error) {
        console.error('ä¿å­˜UIè®¾ç½®å¤±è´¥:', error);
      }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      sourceText.addEventListener('input', () => {
        updateCharCount();

        // è‡ªåŠ¨ç¿»è¯‘
        if (pluginSettings.autoTranslate && sourceText.value.trim()) {
          clearTimeout(autoTranslateTimer);
          autoTranslateTimer = setTimeout(() => {
            translate();
          }, 1000);
        }
      });

      translateBtn.addEventListener('click', translate);
      swapLanguagesBtn.addEventListener('click', swapLanguages);
      settingsBtn.addEventListener('click', toggleSettings);
      saveSettingsBtn.addEventListener('click', saveSettings);

      // è¯­è¨€é€‰æ‹©å˜åŒ–æ—¶ä¿å­˜è®¾ç½®
      sourceLanguage.addEventListener('change', saveUISettings);
      targetLanguage.addEventListener('change', saveUISettings);

      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è®¾ç½®é¢æ¿
      document.addEventListener('click', (e) => {
        if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
          settingsPanel.classList.remove('show');
        }
      });

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case 'Enter':
              e.preventDefault();
              translate();
              break;
            case 'k':
              e.preventDefault();
              clearAll();
              break;
          }
        }
      });
    }

    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updateCharCount() {
      const count = sourceText.value.length;
      sourceCharCount.textContent = `${count} / 5000`;

      if (count > 4500) {
        sourceCharCount.style.color = '#ff6b6b';
      } else if (count > 4000) {
        sourceCharCount.style.color = '#ffa726';
      } else {
        sourceCharCount.style.color = '#999';
      }
    }

    // ç¿»è¯‘å‡½æ•°
    async function translate() {
      const text = sourceText.value.trim();
      if (!text) {
        showError('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬');
        return;
      }

      if (!pluginSettings.secretId || !pluginSettings.secretKey) {
        showError('è¯·å…ˆåœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½®è…¾è®¯äº‘APIå¯†é’¥');
        return;
      }

      showLoading(true);
      clearMessages();

      // è®¾ç½®5ç§’è¶…æ—¶
      translationTimeout = setTimeout(() => {
        showLoading(false);
        showError('ç¿»è¯‘è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
      }, 5000);

      try {
        // è°ƒç”¨æ’ä»¶preloadæä¾›çš„ç¿»è¯‘æ–¹æ³•
        if (window.translatePluginAPI && window.translatePluginAPI.translateText) {
          const result = await window.translatePluginAPI.translateText({
            sourceText: text,
            source: sourceLanguage.value,
            target: targetLanguage.value,
            settings: pluginSettings
          });

          // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
          if (translationTimeout) {
            clearTimeout(translationTimeout);
            translationTimeout = null;
          }

          if (result.success) {
            displayResult(result.translatedText);

            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(text, result.translatedText, sourceLanguage.value, targetLanguage.value);

            // ç§»é™¤æˆåŠŸæç¤ºï¼Œç¿»è¯‘å®Œæˆåä¸å†æ˜¾ç¤ºå¼¹å‡ºæ¡†
          } else {
            showError(result.error || 'ç¿»è¯‘å¤±è´¥');
          }
        } else {
          showError('ç¿»è¯‘åŠŸèƒ½æœªæ­£ç¡®åŠ è½½ï¼Œè¯·æ£€æŸ¥æ’ä»¶é…ç½®');
        }
      } catch (error) {
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        if (translationTimeout) {
          clearTimeout(translationTimeout);
          translationTimeout = null;
        }

        console.error('ç¿»è¯‘é”™è¯¯:', error);
        showError('ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        // åªæœ‰åœ¨æ²¡æœ‰è¶…æ—¶çš„æƒ…å†µä¸‹æ‰å…³é—­åŠ è½½çŠ¶æ€
        if (translationTimeout === null) {
          showLoading(false);
        }
      }
    }

    // æ˜¾ç¤ºç¿»è¯‘ç»“æœ
    function displayResult(text) {
      targetText.innerHTML = text;
      targetText.classList.remove('output-placeholder');
    }

    // æ·»åŠ åˆ°å†å²è®°å½•
    function addToHistory(source, target, sourceLang, targetLang) {
      if (!pluginSettings.saveHistory) return;

      const historyItem = {
        id: Date.now(),
        source,
        target,
        sourceLang,
        targetLang,
        timestamp: new Date().toLocaleString('zh-CN')
      };

      translationHistory.unshift(historyItem);
      saveHistory();
    }

    // äº¤æ¢è¯­è¨€
    function swapLanguages() {
      if (sourceLanguage.value === 'auto') {
        showError('è‡ªåŠ¨æ£€æµ‹è¯­è¨€æ— æ³•äº¤æ¢');
        return;
      }

      const temp = sourceLanguage.value;
      sourceLanguage.value = targetLanguage.value;
      targetLanguage.value = temp;

      // å¦‚æœæœ‰ç¿»è¯‘ç»“æœï¼Œäº¤æ¢æ–‡æœ¬
      const sourceValue = sourceText.value.trim();
      const targetValue = targetText.textContent.trim();

      if (sourceValue && targetValue && !targetText.classList.contains('output-placeholder')) {
        sourceText.value = targetValue;
        displayResult(sourceValue);
        updateCharCount();
      }

      saveUISettings();
    }

    // æ¸…ç©ºæ‰€æœ‰å†…å®¹
    function clearAll() {
      sourceText.value = '';
      targetText.innerHTML = '<div class="output-placeholder">ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
      targetText.classList.add('output-placeholder');
      updateCharCount();
      clearMessages();
    }

    // åˆ‡æ¢è®¾ç½®é¢æ¿
    function toggleSettings() {
      settingsPanel.classList.toggle('show');
    }

    // ä¿å­˜è®¾ç½®
    function saveSettings() {
      try {
        pluginSettings.autoTranslate = autoTranslateCheck.checked;
        pluginSettings.saveHistory = saveHistoryCheck.checked;
        pluginSettings.maxHistoryCount = parseInt(maxHistoryInput.value) || 50;

        // éªŒè¯æ•°å€¼èŒƒå›´
        if (pluginSettings.maxHistoryCount < 10) {
          pluginSettings.maxHistoryCount = 10;
          maxHistoryInput.value = 10;
        } else if (pluginSettings.maxHistoryCount > 200) {
          pluginSettings.maxHistoryCount = 200;
          maxHistoryInput.value = 200;
        }

        saveUISettings();
        showSuccess('è®¾ç½®å·²ä¿å­˜');
        settingsPanel.classList.remove('show');

        // å¦‚æœå…³é—­äº†å†å²è®°å½•ï¼Œæ¸…ç©ºç°æœ‰å†å²
        if (!pluginSettings.saveHistory) {
          translationHistory = [];
          localStorage.removeItem('translate-history');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜è®¾ç½®å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(show) {
      if (show) {
        translateBtn.disabled = true;
        translateBtn.classList.add('loading');
        translateBtn.querySelector('span').textContent = 'ç¿»è¯‘ä¸­...';
      } else {
        translateBtn.disabled = false;
        translateBtn.classList.remove('loading');
        translateBtn.querySelector('span').textContent = 'ç¿»è¯‘';

        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        if (translationTimeout) {
          clearTimeout(translationTimeout);
          translationTimeout = null;
        }
      }
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      setTimeout(() => {
        successMessage.classList.remove('show');
      }, 3000);
    }

    // æ¸…é™¤æ¶ˆæ¯
    function clearMessages() {
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');
    }

    // å°è¯•ä»å‰ªåˆ‡æ¿åŠ è½½ä¸­æ–‡æ–‡æœ¬
    async function tryLoadClipboardText() {
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰å‰ªåˆ‡æ¿APIå¯ç”¨
        if (naimo && naimo.router) {
          // è·å–å‰ªåˆ‡æ¿ä¸­çš„ä¸­æ–‡æ–‡æœ¬
          const clipboardText = await naimo.router.clipboardReadText();

          if (clipboardText && clipboardText.trim()) {
            sourceText.value = clipboardText.trim();
            updateCharCount();
            console.log('ğŸ“‹ ä»å‰ªåˆ‡æ¿åŠ è½½ä¸­æ–‡æ–‡æœ¬æˆåŠŸ');

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showSuccess('å·²ä»å‰ªåˆ‡æ¿åŠ è½½ä¸­æ–‡æ–‡æœ¬');
          } else {
            console.log('ğŸ“‹ å‰ªåˆ‡æ¿ä¸­æ— ä¸­æ–‡æ–‡æœ¬');
          }
        }
      } catch (error) {
        console.error('âŒ ä»å‰ªåˆ‡æ¿åŠ è½½æ–‡æœ¬å¤±è´¥:', error);
        // ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå› ä¸ºè¿™æ˜¯å¯é€‰åŠŸèƒ½
      }
    }

    // æ£€æŸ¥çƒ­é”®è§¦å‘çš„è‡ªåŠ¨ç¿»è¯‘
    async function checkHotkeyAutoTranslate() {
      try {
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ __metadata å…¨å±€å˜é‡
        if (typeof window.__metadata !== 'undefined' && window.__metadata.hotkeyEmit === true) {
          console.log('ğŸ”¥ æ£€æµ‹åˆ°çƒ­é”®è§¦å‘ï¼Œå¯ç”¨è‡ªåŠ¨ç¿»è¯‘');

          // å¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œç«‹å³è¿›è¡Œç¿»è¯‘
          if (sourceText.value.trim()) {
            setTimeout(() => {
              translate();
            }, 300); // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿ç•Œé¢å®Œå…¨åŠ è½½
          }
        }
      } catch (error) {
        console.error('âŒ æ£€æŸ¥çƒ­é”®è‡ªåŠ¨ç¿»è¯‘å¤±è´¥:', error);
      }
    }
    naimo.event.onPluginSearch((event, data) => {
      console.log("æ”¶åˆ°æ’ä»¶æœç´¢äº‹ä»¶:", data)
    })
  </script>
</body>

</html>