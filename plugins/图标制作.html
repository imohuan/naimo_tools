<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICO 图标制作工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <style>
    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-15px) rotate(5deg);
      }
    }

    .float-animation {
      animation: float 4s ease-in-out infinite;
    }

    @keyframes pulse-shadow {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }

      50% {
        box-shadow: 0 0 0 20px rgba(59, 130, 246, 0);
      }
    }

    .pulse-shadow {
      animation: pulse-shadow 2s infinite;
    }
  </style>
</head>

<body class="overflow-hidden">
  <div id="app" class="h-screen">
    <!-- 隐藏的文件输入框（全局） -->
    <input ref="fileInput" type="file" @change="handleFileSelect" accept="image/*" class="hidden">

    <!-- 上传页面 - 亮色风格 -->
    <div v-if="currentStep === 'upload'"
      class="h-full bg-gradient-to-br from-blue-50 via-white to-cyan-50 flex items-center justify-center p-8">
      <div class="max-w-3xl w-full">
        <!-- 上传卡片 -->
        <div class="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
          <div @click="triggerFileInput" @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop"
            :class="isDragging ? 'border-blue-500 bg-blue-50 scale-[1.02]' : 'border-gray-300'"
            class="border-3 border-dashed rounded-2xl p-16 cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-all duration-300 group">

            <div class="text-center">
              <!-- 上传图标 -->
              <div class="inline-block mb-6 transform group-hover:scale-110 transition-transform duration-300">
                <div class="bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl p-6 shadow-lg pulse-shadow">
                  <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                  </svg>
                </div>
              </div>

              <h3 class="text-3xl font-bold text-gray-800 mb-3">选择或拖拽图片</h3>
              <p class="text-gray-500 mb-8 text-lg">支持 PNG、JPG、WEBP 等常见图片格式</p>

              <!-- 特性列表 -->
              <div class="grid grid-cols-3 gap-6 max-w-2xl mx-auto">
                <div class="flex flex-col items-center gap-2">
                  <div class="bg-green-100 rounded-full p-3">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-700">智能裁剪</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                  <div class="bg-blue-100 rounded-full p-3">
                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-700">圆角调节</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                  <div class="bg-cyan-100 rounded-full p-3">
                    <svg class="w-6 h-6 text-cyan-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-700">批量导出</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 底部提示 -->
        <div class="text-center mt-8 flex items-center justify-center gap-2 text-gray-600">
          <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"></path>
          </svg>
          <p class="text-sm">提示：上传图片后可以自由裁剪并生成多种尺寸的图标</p>
        </div>
      </div>
    </div>

    <!-- 工作页面 -->
    <div v-if="currentStep === 'work'" class="h-full bg-gradient-to-br from-blue-50 to-indigo-100">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full p-4">
        <!-- 左侧：裁剪区域 -->
        <div class="bg-white rounded-xl shadow-xl p-5 flex flex-col overflow-hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-gray-800">裁剪调整</h2>
            <button @click="triggerFileInput"
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-xs font-medium shadow-md flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
              </svg>
              重新上传图片
            </button>
          </div>

          <!-- 提示信息 -->
          <div class="mb-3 bg-blue-50 border border-blue-200 rounded-lg p-2">
            <p class="text-xs text-blue-800">
              💡 <strong>操作提示：</strong>裁剪框固定在中心，请拖拽移动图片或滚轮缩放图片来调整裁剪区域
            </p>
          </div>

          <!-- 裁剪画布 -->
          <div class="flex-1 mb-3 overflow-hidden">
            <img ref="cropperImage" :src="originalImage" class="max-w-full max-h-full">
          </div>

          <!-- 圆角控制 -->
          <div class="mb-3 bg-gray-50 rounded-lg p-3">
            <label class="block text-xs font-medium text-gray-700 mb-2">
              圆角半径: {{ borderRadius }}%
            </label>
            <input v-model="borderRadius" type="range" min="0" max="50"
              class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>直角</span>
              <span>圆形</span>
            </div>
          </div>

          <!-- 预览 -->
          <div class="text-center mb-3">
            <p class="text-xs font-medium text-gray-700 mb-2">实时预览</p>
            <canvas ref="previewCanvas" width="120" height="120"
              class="mx-auto border-2 border-gray-300 rounded-lg shadow-sm"></canvas>
          </div>
        </div>

        <!-- 右侧：生成区域 -->
        <div class="bg-white rounded-xl shadow-xl p-5 flex flex-col overflow-hidden">
          <h2 class="text-lg font-bold text-gray-800 mb-3">生成图标</h2>

          <!-- 尺寸选择 -->
          <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">选择需要的尺寸</h3>
            <div class="grid grid-cols-3 gap-2">
              <label v-for="size in availableSizes" :key="size"
                class="flex items-center space-x-2 p-2 border-2 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors"
                :class="selectedSizes.includes(size) ? 'border-blue-500 bg-blue-50' : 'border-gray-300'">
                <input type="checkbox" :value="size" v-model="selectedSizes"
                  class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500">
                <span class="text-xs font-medium text-gray-700">{{ size }}x{{ size }}</span>
              </label>
            </div>
            <button @click="toggleAllSizes" class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium">
              {{ selectedSizes.length === availableSizes.length ? '取消全选' : '全选' }}
            </button>
          </div>

          <!-- 生成的图标预览 -->
          <div class="flex-1 overflow-hidden mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">图标预览</h3>
            <div class="grid grid-cols-3 gap-3 max-h-full overflow-y-auto pr-2">
              <div v-for="size in selectedSizes" :key="size" class="text-center">
                <div class="bg-gray-100 p-2 rounded-lg mb-1 flex items-center justify-center" style="min-height: 80px;">
                  <canvas :ref="el => { if (el) canvasRefs[size] = el }" :width="size" :height="size"
                    :style="{maxWidth: '60px', maxHeight: '60px', imageRendering: size <= 32 ? 'pixelated' : 'auto'}"
                    class="mx-auto"></canvas>
                </div>
                <p class="text-xs text-gray-600 font-medium mb-1">{{ size }}x{{ size }}</p>
                <button @click="downloadSingle(size)" class="text-xs text-blue-600 hover:text-blue-800">
                  下载
                </button>
              </div>
            </div>
          </div>

          <!-- 底部按钮 -->
          <div class="flex gap-2">
            <button @click="downloadAll"
              class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium shadow-md flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              <span class="text-sm">下载全部</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted, onUnmounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        // 状态管理
        const currentStep = ref('upload'); // 'upload', 'work'
        const isDragging = ref(false);
        const originalImage = ref(null);
        const borderRadius = ref(0);
        const fileInput = ref(null);
        const cropperImage = ref(null);
        const previewCanvas = ref(null);
        const canvasRefs = ref({});

        let cropper = null;
        let resizeObserver = null;
        let isDraggingImage = false;

        // 可用尺寸
        const availableSizes = ref([16, 24, 32, 48, 64, 96, 128, 256, 512, 1024]);
        const selectedSizes = ref([16, 32, 64, 128, 256]);

        // Debounce 函数
        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        // 触发文件选择
        const triggerFileInput = () => {
          fileInput.value.click();
        };

        // 处理文件选择
        const handleFileSelect = (event) => {
          const file = event.target.files[0];
          if (file && file.type.startsWith('image/')) {
            loadImage(file);
          }
        };

        // 处理拖放
        const handleDrop = (event) => {
          isDragging.value = false;
          const file = event.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            loadImage(file);
          }
        };

        // 加载图片
        const loadImage = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            originalImage.value = e.target.result;
            currentStep.value = 'work';
            nextTick(() => {
              initCropper();
            });
          };
          reader.readAsDataURL(file);
        };

        // 初始化裁剪器
        const initCropper = () => {
          if (cropper) {
            cropper.destroy();
          }

          cropper = new Cropper(cropperImage.value, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            responsive: true,
            center: true,
            highlight: false,
            cropBoxMovable: false,
            cropBoxResizable: false,
            toggleDragModeOnDblclick: false,
            cropstart: () => {
              isDraggingImage = true;
            },
            cropend: () => {
              isDraggingImage = false;
              // 只在拖拽结束时更新
              updatePreview();
            },
            zoom: debounceUpdatePreview // 缩放时使用debounce
          });

          // 监听容器尺寸变化
          setupResizeObserver();
        };

        // 设置 ResizeObserver 监听容器尺寸变化
        const setupResizeObserver = () => {
          if (resizeObserver) {
            resizeObserver.disconnect();
          }

          const container = cropperImage.value?.parentElement;
          if (!container) return;

          resizeObserver = new ResizeObserver(debounce(() => {
            if (cropper) {
              // 重新居中裁剪框
              cropper.reset();
              updatePreview();
            }
          }, 1000));

          resizeObserver.observe(container);
        };

        // 带 debounce 的更新预览（用于缩放）
        const debounceUpdatePreview = debounce(() => {
          if (!isDraggingImage) {
            updatePreview();
          }
        }, 1000);

        // 更新预览
        const updatePreview = () => {
          if (!cropper || !previewCanvas.value) return;

          const canvas = cropper.getCroppedCanvas({
            width: 120,
            height: 120
          });

          if (!canvas) return;

          const ctx = previewCanvas.value.getContext('2d');
          ctx.clearRect(0, 0, 120, 120);

          // 保存状态
          ctx.save();

          // 应用圆角
          if (borderRadius.value > 0) {
            const radius = (borderRadius.value / 100) * 60;
            ctx.beginPath();
            ctx.moveTo(radius, 0);
            ctx.lineTo(120 - radius, 0);
            ctx.quadraticCurveTo(120, 0, 120, radius);
            ctx.lineTo(120, 120 - radius);
            ctx.quadraticCurveTo(120, 120, 120 - radius, 120);
            ctx.lineTo(radius, 120);
            ctx.quadraticCurveTo(0, 120, 0, 120 - radius);
            ctx.lineTo(0, radius);
            ctx.quadraticCurveTo(0, 0, radius, 0);
            ctx.closePath();
            ctx.clip();
          }

          ctx.drawImage(canvas, 0, 0, 120, 120);
          ctx.restore();

          // 同时生成图标
          generateIcons();
        };

        // 监听圆角变化（立即更新）
        watch(borderRadius, () => {
          if (cropper) {
            updatePreview();
          }
        });

        // 生成图标
        const generateIcons = () => {
          if (!cropper) return;

          const canvas = cropper.getCroppedCanvas({
            width: 1024,
            height: 1024
          });

          if (!canvas) return;

          canvas.toBlob((blob) => {
            if (!blob) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                selectedSizes.value.forEach(size => {
                  const iconCanvas = canvasRefs.value[size];
                  if (!iconCanvas) return;

                  const ctx = iconCanvas.getContext('2d');
                  ctx.clearRect(0, 0, size, size);

                  // 保存当前状态
                  ctx.save();

                  // 应用圆角
                  if (borderRadius.value > 0) {
                    const radius = (borderRadius.value / 100) * (size / 2);
                    ctx.beginPath();
                    ctx.moveTo(radius, 0);
                    ctx.lineTo(size - radius, 0);
                    ctx.quadraticCurveTo(size, 0, size, radius);
                    ctx.lineTo(size, size - radius);
                    ctx.quadraticCurveTo(size, size, size - radius, size);
                    ctx.lineTo(radius, size);
                    ctx.quadraticCurveTo(0, size, 0, size - radius);
                    ctx.lineTo(0, radius);
                    ctx.quadraticCurveTo(0, 0, radius, 0);
                    ctx.closePath();
                    ctx.clip();
                  }

                  ctx.drawImage(img, 0, 0, size, size);

                  // 恢复状态
                  ctx.restore();
                });
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(blob);
          });
        };

        // 监听选择的尺寸变化
        watch(selectedSizes, () => {
          if (cropper) {
            nextTick(() => {
              generateIcons();
            });
          }
        }, { deep: true });

        // 全选/取消全选
        const toggleAllSizes = () => {
          if (selectedSizes.value.length === availableSizes.value.length) {
            selectedSizes.value = [];
          } else {
            selectedSizes.value = [...availableSizes.value];
          }
        };

        // 下载单个图标
        const downloadSingle = (size) => {
          const canvas = canvasRefs.value[size];
          if (!canvas) return;

          const link = document.createElement('a');
          link.download = `icon-${size}x${size}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        };

        // 下载全部
        const downloadAll = () => {
          selectedSizes.value.forEach(size => {
            setTimeout(() => {
              downloadSingle(size);
            }, 100 * selectedSizes.value.indexOf(size));
          });
        };

        // 返回上传页面
        const backToUpload = () => {
          if (cropper) {
            cropper.destroy();
            cropper = null;
          }
          if (resizeObserver) {
            resizeObserver.disconnect();
            resizeObserver = null;
          }
          currentStep.value = 'upload';
          originalImage.value = null;
          borderRadius.value = 0;
          if (fileInput.value) {
            fileInput.value.value = '';
          }
        };

        // 组件卸载时清理
        onUnmounted(() => {
          if (cropper) {
            cropper.destroy();
          }
          if (resizeObserver) {
            resizeObserver.disconnect();
          }
        });

        return {
          currentStep,
          isDragging,
          originalImage,
          borderRadius,
          fileInput,
          cropperImage,
          previewCanvas,
          canvasRefs,
          availableSizes,
          selectedSizes,
          triggerFileInput,
          handleFileSelect,
          handleDrop,
          toggleAllSizes,
          downloadSingle,
          downloadAll,
          backToUpload
        };
      }
    }).mount('#app');
  </script>
</body>

</html>