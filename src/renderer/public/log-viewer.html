<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—¥å¿—é˜…è¯»å™¨</title>

  <!-- Editor CDN -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Consolas", "Monaco", "Courier New", monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: #2d2d30;
      padding: 12px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      -webkit-app-region: drag;
      user-select: none;
    }

    .header h1 {
      color: #569cd6;
      font-size: 18px;
      margin: 0;
    }

    .upload-section {
      display: flex;
      align-items: center;
      gap: 15px;
      -webkit-app-region: no-drag;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .file-input-label {
      display: inline-block;
      padding: 8px 16px;
      background: #007acc;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .file-input-label:hover {
      background: #005a9e;
    }

    .file-info {
      color: #cccccc;
      font-size: 14px;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .window-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    .window-btn.close:hover {
      background: #e81123;
      box-shadow: 0 4px 8px rgba(232, 17, 35, 0.4);
    }

    .window-btn svg {
      width: 18px;
      height: 18px;
      fill: #ffffff;
      opacity: 1;
      filter: brightness(1.2) contrast(1.2);
    }

    .window-btn:hover svg {
      filter: brightness(1.4) contrast(1.4);
    }

    .window-btn.close:hover svg {
      fill: white;
      filter: brightness(1.4) contrast(1.4);
    }

    .controls {
      background: #252526;
      padding: 10px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .controls-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      flex: 1;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      width: 250px;
    }

    .search-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .search-input:disabled {
      background: #2d2d30;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .date-range-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      color: #cccccc;
      font-size: 12px;
      white-space: nowrap;
    }

    .date-range-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .date-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      width: 140px;
    }

    .date-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .date-input:disabled {
      background: #2d2d30;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .date-separator {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
    }

    .log-level-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-level-filters {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .search-stats {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
      margin-left: auto;
    }

    .view-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }


    .level-filter-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      background: #3c3c3c;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .level-filter-tag:hover {
      background: #4a4a4a;
    }

    .level-filter-tag.active {
      background: #007acc;
      border-color: #007acc;
      color: white;
    }

    .level-filter-tag.active.error {
      background: #f44747;
      border-color: #f44747;
      color: white;
    }

    .level-filter-tag.active.warn {
      background: #ffcc02;
      border-color: #ffcc02;
      color: #1e1e1e;
    }

    .level-filter-tag.active.info {
      background: #75beff;
      border-color: #75beff;
      color: white;
    }

    .level-filter-tag.active.debug {
      background: #4ec9b0;
      border-color: #4ec9b0;
      color: white;
    }

    .level-filter-tag.active.trace {
      background: #9cdcfe;
      border-color: #9cdcfe;
      color: #1e1e1e;
    }

    .level-filter-tag.error {
      border-color: #f44747;
    }

    .level-filter-tag.warn {
      border-color: #ffcc02;
    }

    .level-filter-tag.info {
      border-color: #75beff;
    }

    .level-filter-tag.debug {
      border-color: #4ec9b0;
    }

    .level-filter-tag.trace {
      border-color: #9cdcfe;
    }

    .level-filter-tag.all {
      border-color: #9cdcfe;
      font-weight: bold;
    }

    .level-filter-tag.active.all {
      background: #9cdcfe;
      border-color: #9cdcfe;
      color: #1e1e1e;
    }

    .search-stats {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
    }

    .view-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .btn {
      padding: 6px 12px;
      border: 1px solid #555;
      background: #3c3c3c;
      color: #d4d4d4;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #4a4a4a;
    }

    .btn.active {
      background: #007acc;
      border-color: #007acc;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.primary {
      background: #007acc;
      border-color: #007acc;
      color: white;
    }

    .btn.primary:hover {
      background: #005a9e;
    }

    .btn.active {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }

    .btn.active:hover {
      background: #45a049;
    }

    .filter-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .editor-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .loading-spinner {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #3c3c3c;
      border-top: 3px solid #007acc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #808080;
      font-size: 16px;
    }

    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: #007acc;
      transition: width 0.3s ease;
      z-index: 1000;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      .controls-left {
        gap: 15px;
      }

      .search-input {
        width: 200px;
      }

      .date-input {
        width: 120px;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .upload-section {
        justify-content: center;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .controls-left {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .search-box,
      .date-range-box,
      .log-level-box {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .search-input {
        width: 100%;
      }

      .date-range-container {
        justify-content: center;
      }

      .date-input {
        width: 100%;
      }

      .log-level-filters {
        justify-content: center;
      }

      .search-stats {
        margin-left: 0;
        text-align: center;
      }

      .view-controls {
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸ“„ æ—¥å¿—é˜…è¯»å™¨</h1>
    <div class="h-upload-section" style="display: none;">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" class="file-input" accept=".log,.txt,.json,.csv">
        <label for="fileInput" class="file-input-label">é€‰æ‹©æ—¥å¿—æ–‡ä»¶</label>
      </div>
      <div class="file-info" id="fileInfo">æœªé€‰æ‹©æ–‡ä»¶</div>
    </div>
    <div class="window-controls">
      <button class="window-btn minimize" id="minimizeBtn" title="æœ€å°åŒ–">
        <svg viewBox="0 0 12 12">
          <rect x="2" y="5.5" width="8" height="1" fill="currentColor" />
        </svg>
      </button>
      <button class="window-btn maximize" id="maximizeBtn" title="æœ€å¤§åŒ–">
        <svg viewBox="0 0 12 12">
          <rect x="2" y="2" width="8" height="8" fill="none" stroke="currentColor" stroke-width="1" />
        </svg>
      </button>
      <button class="window-btn close" id="closeBtn" title="å…³é—­">
        <svg viewBox="0 0 12 12">
          <path d="M3 3l6 6M9 3l-6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
      </button>
    </div>
  </div>

  <div class="controls">
    <div class="controls-left">
      <div class="search-box">
        <label class="control-label">æœç´¢:</label>
        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." disabled>
        <button class="btn" id="regexToggleBtn" disabled title="åˆ‡æ¢æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼">.*</button>
      </div>

      <div class="date-range-box">
        <label class="control-label">æ—¶é—´èŒƒå›´:</label>
        <div class="date-range-container">
          <input type="datetime-local" id="startTime" class="date-input" disabled>
          <span class="date-separator">è‡³</span>
          <input type="datetime-local" id="endTime" class="date-input" disabled>
        </div>
      </div>

      <div class="log-level-box">
        <label class="control-label">æ—¥å¿—çº§åˆ«:</label>
        <div class="log-level-filters">
          <div class="level-filter-tag error" data-level="error">ERROR</div>
          <div class="level-filter-tag warn" data-level="warn">WARN</div>
          <div class="level-filter-tag info" data-level="info">INFO</div>
          <div class="level-filter-tag debug" data-level="debug">DEBUG</div>
          <div class="level-filter-tag trace" data-level="trace">TRACE</div>
          <div class="level-filter-tag all" data-level="all" title="æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—">*</div>
        </div>
      </div>

      <div class="search-stats" id="searchStats"></div>
    </div>
    <div class="view-controls">
      <button class="btn" id="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      <button class="btn" id="exportLogs">å¯¼å‡ºæ—¥å¿—</button>
      <button class="btn primary" id="refreshLogs">åˆ·æ–°</button>
      <button class="btn" id="autoRefreshBtn">è‡ªåŠ¨åˆ·æ–°</button>
      <select id="refreshInterval" class="filter-input">
        <option value="1" selected>1ç§’</option>
        <option value="2">2ç§’</option>
        <option value="3">3ç§’</option>
        <option value="4">4ç§’</option>
        <option value="5">5ç§’</option>
        <option value="10">10ç§’</option>
        <option value="30">30ç§’</option>
      </select>
    </div>
  </div>

  <div class="editor-container">
    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
    <div id="monaco-editor" style="width: 100%; height: 100%;"></div>
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
      <div class="spinner"></div>
    </div>
    <div class="empty-state" id="emptyState">
      <p>æ­£åœ¨åŠ è½½Electronåº”ç”¨æ—¥å¿—...</p>
      <p style="font-size: 12px; margin-top: 10px; color: #666;">
        å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œè¯·æ£€æŸ¥Electron APIæ˜¯å¦å¯ç”¨
      </p>
      <p style="font-size: 11px; margin-top: 8px; color: #555;">
        æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©æœ¬åœ°æ—¥å¿—æ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹
      </p>
    </div>
  </div>

  <script>
    class MonacoLogViewer {
      constructor() {
        this.editor = null;
        this.file = null;
        this.fileContent = '';
        this.searchResults = [];
        this.currentSearchIndex = -1;
        this.isLoading = false;
        this.useRegex = false;
        this.selectedLevels = new Set();
        this.originalContent = '';
        this.filteredContent = '';
        this.previousOriginalContent = ''; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„åŸå§‹å†…å®¹ç”¨äºå¯¹æ¯”

        // æ—¥å¿—è¡Œæ•°ç»„
        this.logLines = [];
        this.currentSearchQuery = '';

        // æ—¥æœŸè¿‡æ»¤
        this.startDate = null;
        this.endDate = null;

        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³
        this.autoRefreshEnabled = false;
        this.autoRefreshInterval = null;
        this.refreshIntervalSeconds = 1;

        // æ»šåŠ¨å¸é™„ç›¸å…³
        this.scrollSnapEnabled = true; // é»˜è®¤å¯ç”¨æ»šåŠ¨å¸é™„
        this.scrollSnapThreshold = 120; // è·ç¦»åº•éƒ¨80pxå†…è®¤ä¸ºæ˜¯"åº•éƒ¨é™„è¿‘"

        this.init();
      }

      async init() {
        await this.initializeMonaco();
        this.bindEvents();
        // åˆå§‹åŒ–æ—¶è‡ªåŠ¨åŠ è½½Electronæ—¥å¿—ï¼ˆä½¿ç”¨åˆå§‹åŠ è½½æ–¹æ³•ï¼‰
        await this.loadElectronLogsInitial();
      }

      async initializeMonaco() {
        return new Promise((resolve) => {
          require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
          require(['vs/editor/editor.main'], () => {
            this.registerLogLanguage();
            this.setupMonacoEditor();
            resolve();
          });
        });
      }

      setupMonacoEditor() {
        this.editor = monaco.editor.create(document.getElementById('monaco-editor'), {
          value: '',
          language: 'log',
          theme: 'log-theme',
          readOnly: true,
          wordWrap: 'on',
          lineNumbers: 'on',
          minimap: { enabled: true },
          scrollBeyondLastLine: false,
          automaticLayout: true,
          fontSize: 13,
          fontFamily: 'Consolas, Monaco, "Courier New", monospace',
          lineHeight: 20,
          cursorBlinking: 'blink',
          cursorStyle: 'line',
          selectOnLineNumbers: true,
          roundedSelection: false,
          contextmenu: true,
          mouseWheelZoom: true,
          smoothScrolling: true,
          renderWhitespace: 'selection',
          renderControlCharacters: true,
          renderIndentGuides: true,
          highlightActiveIndentGuide: true,
          bracketPairColorization: { enabled: true },
          guides: {
            bracketPairs: true,
            indentation: true
          }
        });

        // éšè—ç©ºçŠ¶æ€
        document.getElementById('emptyState').style.display = 'none';
      }

      registerLogLanguage() {
        // æ³¨å†Œæ—¥å¿—è¯­è¨€
        monaco.languages.register({ id: 'log' });

        // å®šä¹‰æ—¥å¿—è¯­æ³•é«˜äº®è§„åˆ™ - ä¿®å¤ç‰ˆæœ¬
        monaco.languages.setMonarchTokensProvider('log', {
          tokenizer: {
            root: [
              // æ—¶é—´æˆ³æ ¼å¼ [YYYY-MM-DD HH:mm:ss.sss]
              [/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:\.\d{3})?/, 'timestamp-token'],

              // æ—¥å¿—çº§åˆ« - [info], [debug], [error] ç­‰æ ¼å¼
              [/(\[)(info)(\])/i, ['bracket', 'info-token', 'bracket']],
              [/(\[)(debug)(\])/i, ['bracket', 'debug-token', 'bracket']],
              [/(\[)(warn)(\])/i, ['bracket', 'warn-token', 'bracket']],
              [/(\[)(warning)(\])/i, ['bracket', 'warn-token', 'bracket']],
              [/(\[)(error)(\])/i, ['bracket', 'error-token', 'bracket']],
              [/(\[)(fatal)(\])/i, ['bracket', 'fatal-token', 'bracket']],
              [/(\[)(trace)(\])/i, ['bracket', 'trace-token', 'bracket']],

              // æ—¥å¿—çº§åˆ« - <info>, <debug>, <error> ç­‰æ ¼å¼
              [/(<)(info)(>)/i, ['delimiter', 'info-token', 'delimiter']],
              [/(<)(debug)(>)/i, ['delimiter', 'debug-token', 'delimiter']],
              [/(<)(warn)(>)/i, ['delimiter', 'warn-token', 'delimiter']],
              [/(<)(warning)(>)/i, ['delimiter', 'warn-token', 'delimiter']],
              [/(<)(error)(>)/i, ['delimiter', 'error-token', 'delimiter']],
              [/(<)(fatal)(>)/i, ['delimiter', 'fatal-token', 'delimiter']],
              [/(<)(trace)(>)/i, ['delimiter', 'trace-token', 'delimiter']],

              // æ—¥å¿—çº§åˆ« - çº¯æ–‡æœ¬æ ¼å¼
              [/\b(info|debug|warn|warning|error|fatal|trace)\b/i, {
                cases: {
                  "info": "info-token",
                  "debug": "debug-token",
                  "warn": "warn-token",
                  "warning": "warn-token",
                  "error": "error-token",
                  "fatal": "fatal-token",
                  "trace": "trace-token"
                }
              }],

              // IPåœ°å€
              [/\b(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\b/, 'ip-address'],

              // URL
              [/(https?:\/\/[^\s]+)/, 'url'],

              // æ–‡ä»¶è·¯å¾„ (Windowså’ŒUnixæ ¼å¼)
              [/([A-Za-z]:\\[^\s]+|[\/][^\s]+)/, 'file-path'],

              // ç‰ˆæœ¬å· v1.2.3 æ ¼å¼
              [/\bv\d+\.\d+\.\d+\b/, 'version'],

              // JSONæ ¼å¼çš„å­—ç¬¦ä¸²
              [/"[^"]*"/, 'string'],
              [/'[^']*'/, 'string'],

              // æ•°å­—
              [/\b\d+(\.\d+)?\b/, 'number'],

              // HTTPçŠ¶æ€ç 
              [/\b(1\d{2}|2\d{2}|3\d{2}|4\d{2}|5\d{2})\b/, 'http-status'],

              // HTTPæ–¹æ³•
              [/\b(GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)\b/i, 'http-method'],

              // å¸ƒå°”å€¼å’Œnull
              [/\b(true|false|null|undefined)\b/i, 'keyword'],

              // å¼‚å¸¸å †æ ˆæ ‡è¯†
              [/^\s*at\s/, 'stack-trace'],
              [/^\s*Caused by:/, 'stack-trace'],

              // å…¶ä»–æ–‡æœ¬
              [/./, 'text']
            ]
          }
        });

        // å®šä¹‰ä¸»é¢˜é¢œè‰² - ä¿®å¤ç‰ˆæœ¬
        monaco.editor.defineTheme('log-theme', {
          base: 'vs-dark',
          inherit: true,
          rules: [
            // æ—¶é—´æˆ³æ ·å¼
            { token: 'timestamp-token', foreground: '808080' },

            // æ—¥å¿—çº§åˆ«æ ·å¼ - ä¸åŒé¢œè‰²
            { token: 'error-token', foreground: 'f44747', fontStyle: 'bold' },
            { token: 'fatal-token', foreground: 'f44747', fontStyle: 'bold' },
            { token: 'warn-token', foreground: 'ffcc02', fontStyle: 'bold' },
            { token: 'warning-token', foreground: 'ffcc02', fontStyle: 'bold' },
            { token: 'info-token', foreground: '75beff', fontStyle: 'bold' },
            { token: 'debug-token', foreground: '4ec9b0', fontStyle: 'bold' },
            { token: 'trace-token', foreground: '9cdcfe', fontStyle: 'bold' },

            // ç½‘ç»œç›¸å…³
            { token: 'ip-address', foreground: 'ce9178' },
            { token: 'url', foreground: '9cdcfe', fontStyle: 'underline' },
            { token: 'http-method', foreground: '569cd6', fontStyle: 'bold' },
            { token: 'http-status', foreground: 'b5cea8', fontStyle: 'bold' },

            // æ–‡ä»¶è·¯å¾„
            { token: 'file-path', foreground: 'ce9178' },

            // ç‰ˆæœ¬å·
            { token: 'version', foreground: 'b5cea8', fontStyle: 'bold' },

            // æ•°æ®ç±»å‹
            { token: 'string', foreground: 'ce9178' },
            { token: 'number', foreground: 'b5cea8' },
            { token: 'keyword', foreground: '569cd6', fontStyle: 'bold' },

            // å¼‚å¸¸å †æ ˆ
            { token: 'stack-trace', foreground: 'ff6b6b', fontStyle: 'italic' },

            // æ‹¬å·å’Œåˆ†éš”ç¬¦ - ä¿æŒé»˜è®¤é¢œè‰²
            { token: 'bracket', foreground: 'd4d4d4' },
            { token: 'delimiter', foreground: 'd4d4d4' },

            // é»˜è®¤æ–‡æœ¬
            { token: 'text', foreground: 'd4d4d4' }
          ],
          colors: {
            'editor.background': '#1e1e1e',
            'editor.foreground': '#d4d4d4',
            'editorLineNumber.foreground': '#858585',
            'editorLineNumber.activeForeground': '#c6c6c6',
            'editor.selectionBackground': '#264f78',
            'editor.selectionHighlightBackground': '#add6ff26',
            'editor.findMatchBackground': '#515c6a',
            'editor.findMatchHighlightBackground': '#ea5c0055',
            'editor.hoverHighlightBackground': '#264f7840',
            'editor.lineHighlightBackground': '#2d2d30',
            'editorCursor.foreground': '#aeafad',
            'editorWhitespace.foreground': '#3e4042'
          }
        });

        // åº”ç”¨ä¸»é¢˜
        monaco.editor.setTheme('log-theme');
      }

      bindEvents() {
        // æ–‡ä»¶é€‰æ‹© - ä½œä¸ºå¤‡ç”¨é€‰é¡¹
        document.getElementById('fileInput').addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            this.stopAutoRefresh();
            this.autoRefreshEnabled = false;
            const autoRefreshBtn = document.getElementById('autoRefreshBtn');
            if (autoRefreshBtn) {
              autoRefreshBtn.textContent = "è‡ªåŠ¨åˆ·æ–°";
              autoRefreshBtn.classList.remove("active");
            }

            // åŠ è½½é€‰æ‹©çš„æ–‡ä»¶
            this.loadFile(e.target.files[0]);
          }
        });

        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', (e) => {
          this.search(e.target.value);
        });

        // æ§åˆ¶æŒ‰é’®
        document.getElementById('clearLogs').addEventListener('click', () => {
          this.clearLogs();
        });

        document.getElementById('exportLogs').addEventListener('click', () => {
          this.exportLogs();
        });

        document.getElementById('refreshLogs').addEventListener('click', () => {
          this.refreshLogs();
        });

        document.getElementById('autoRefreshBtn').addEventListener('click', () => {
          this.toggleAutoRefresh();
        });

        document.getElementById('refreshInterval').addEventListener('change', (e) => {
          this.refreshIntervalSeconds = parseInt(e.target.value);
          if (this.autoRefreshEnabled) {
            this.stopAutoRefresh();
            this.startAutoRefresh();
          }
        });

        // çª—å£æ§åˆ¶æŒ‰é’®
        document.getElementById('minimizeBtn').addEventListener('click', () => {
          this.minimizeWindow();
        });

        document.getElementById('maximizeBtn').addEventListener('click', () => {
          this.maximizeWindow();
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
          this.closeWindow();
        });

        // æ­£åˆ™è¡¨è¾¾å¼åˆ‡æ¢æŒ‰é’®
        document.getElementById('regexToggleBtn').addEventListener('click', () => {
          this.toggleRegex();
        });

        // æ—¥å¿—ç­‰çº§è¿‡æ»¤æ ‡ç­¾
        document.querySelectorAll('.level-filter-tag').forEach(tag => {
          tag.addEventListener('click', () => {
            this.toggleLevelFilter(tag.dataset.level);
          });
        });

        // æ—¥æœŸè¿‡æ»¤
        document.getElementById('startTime').addEventListener('change', (e) => {
          this.startDate = e.target.value ? new Date(e.target.value) : null;
          this.applyAllFilters(true); // ç”¨æˆ·ä¸»åŠ¨æ”¹å˜æ—¥æœŸæ—¶å¼ºåˆ¶æ›´æ–°
        });

        document.getElementById('endTime').addEventListener('change', (e) => {
          this.endDate = e.target.value ? new Date(e.target.value) : null;
          this.applyAllFilters(true); // ç”¨æˆ·ä¸»åŠ¨æ”¹å˜æ—¥æœŸæ—¶å¼ºåˆ¶æ›´æ–°
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
              case 'f':
                e.preventDefault();
                document.getElementById('searchInput').focus();
                break;
              case 'Home':
                e.preventDefault();
                this.gotoTop();
                break;
              case 'End':
                e.preventDefault();
                this.gotoBottom();
                break;
              case 'r':
                e.preventDefault();
                this.refreshLogs();
                break;
            }
          } else if (e.key === 'Escape') {
            document.getElementById('searchInput').blur();
            this.clearSearch();
          }
        });
      }

      // åˆå§‹åŠ è½½Electronæ—¥å¿—ï¼ˆä¸ä½¿ç”¨ç´¯åŠ é€»è¾‘ï¼‰
      async loadElectronLogsInitial() {
        this.isLoading = true;
        this.updateFileInfo('Electronåº”ç”¨æ—¥å¿—');
        this.showLoading();

        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰electronAPIå¯ç”¨
          if (!naimo || !naimo.router) {
            throw new Error('Electron API ä¸å¯ç”¨');
          }

          // è·å–åŸå§‹æ—¥å¿—å†…å®¹
          const logContent = await naimo.router.logGetRawLogContent();

          this.originalContent = logContent;
          this.previousOriginalContent = logContent;

          // å°†å†…å®¹æŒ‰è¡Œåˆ†å‰²
          this.logLines = logContent.split('\n').filter(line => line.trim() !== '');
          console.log(`åˆå§‹åŠ è½½ ${this.logLines.length} ä¸ªæ—¥å¿—æ¡ç›®`);

          // åº”ç”¨å½“å‰è¿‡æ»¤å™¨æ˜¾ç¤ºå†…å®¹
          this.updateEditorContent(true, true);
          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('åˆå§‹åŠ è½½Electronæ—¥å¿—å¤±è´¥:', error);
          this.showError('åˆå§‹åŠ è½½Electronæ—¥å¿—å¤±è´¥: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      // åˆ·æ–°åŠ è½½Electronæ—¥å¿—ï¼ˆä½¿ç”¨ç´¯åŠ é€»è¾‘ï¼‰
      async loadElectronLogs() {
        this.isLoading = true;
        this.updateFileInfo('Electronåº”ç”¨æ—¥å¿—');
        this.showLoading();

        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰electronAPIå¯ç”¨
          if (!naimo || !naimo.router) {
            throw new Error('Electron API ä¸å¯ç”¨');
          }

          // ä¿å­˜ç”¨æˆ·å½“å‰çš„é€‰ä¸­çŠ¶æ€å’Œæ»šåŠ¨ä½ç½®
          const currentSelection = this.editor.getSelection();
          const currentScrollTop = this.editor.getScrollTop();
          const currentScrollLeft = this.editor.getScrollLeft();

          // è·å–åŸå§‹æ—¥å¿—å†…å®¹
          const logContent = await naimo.router.logGetRawLogContent();

          // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
          const hasNewContent = this.previousOriginalContent !== logContent;
          console.log(`æœ‰æ–°å†…å®¹: ${hasNewContent}`);

          if (hasNewContent) {
            // è®¡ç®—æ–°å¢çš„æ—¥å¿—è¡Œ
            const newLogLines = logContent.split('\n').filter(line => line.trim() !== '');
            const previousLogLines = this.previousOriginalContent ?
              this.previousOriginalContent.split('\n').filter(line => line.trim() !== '') : [];

            // æ‰¾å‡ºæ–°å¢çš„è¡Œ
            const newLines = newLogLines.slice(previousLogLines.length);
            console.log(`æ–°å¢ ${newLines.length} è¡Œæ—¥å¿—`);

            if (newLines.length > 0) {
              // ç´¯åŠ æ–°æ—¥å¿—è¡Œ
              this.logLines = this.logLines.concat(newLines);
              this.originalContent = logContent;
              this.previousOriginalContent = logContent;

              // åº”ç”¨è¿‡æ»¤å™¨å¹¶è¿½åŠ æ–°å†…å®¹
              this.appendNewContent(newLines);

              // æ¢å¤ç”¨æˆ·çš„é€‰ä¸­çŠ¶æ€å’Œæ»šåŠ¨ä½ç½®
              if (currentSelection) {
                this.editor.setSelection(currentSelection);
              }
              this.editor.setScrollTop(currentScrollTop);
              this.editor.setScrollLeft(currentScrollLeft);
            }
          }

          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('åŠ è½½Electronæ—¥å¿—å¤±è´¥:', error);
          this.showError('åŠ è½½Electronæ—¥å¿—å¤±è´¥: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      async loadFile(file) {
        this.file = file;
        this.isLoading = true;
        this.updateFileInfo();
        this.showLoading();

        try {
          const fileContent = await this.readFileAsText(file);

          // æ–‡ä»¶æ¨¡å¼ç›´æ¥æ›¿æ¢æ‰€æœ‰å†…å®¹ï¼Œä¸è¿›è¡Œç´¯åŠ 
          this.originalContent = fileContent;
          this.previousOriginalContent = fileContent;

          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²æ—¥å¿—æ¡ç›®ï¼Œæ­£ç¡®å¤„ç†å¤šè¡Œé”™è¯¯å †æ ˆ
          // åŒ¹é…ä»¥æ—¶é—´æˆ³å¼€å¤´çš„è¡Œä½œä¸ºæ–°æ—¥å¿—æ¡ç›®çš„å¼€å§‹
          const logEntryRegex = /(?=^\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}\])/gm;
          const logEntries = fileContent.split(logEntryRegex).filter(entry => entry.trim() !== '');

          // æ¸…ç†æ¯ä¸ªæ—¥å¿—æ¡ç›®ï¼Œç§»é™¤å¼€å¤´çš„æ¢è¡Œç¬¦
          this.logLines = logEntries.map(entry => entry.trim());
          console.log(`è§£æåˆ° ${this.logLines.length} ä¸ªæ—¥å¿—æ¡ç›®`);
          console.log(this.logLines);

          // åº”ç”¨å½“å‰è¿‡æ»¤å™¨æ˜¾ç¤ºå†…å®¹
          this.updateEditorContent(true, true); // æ–‡ä»¶åŠ è½½æ—¶æ€»æ˜¯å¼ºåˆ¶æ›´æ–°
          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
          this.showError('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
          reader.readAsText(file, 'utf-8');
        });
      }

      // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹çš„æ–¹æ³•
      updateEditorContent(applyFilters = false, forceUpdate = false) {
        if (applyFilters) {
          // å¦‚æœæŒ‡å®šåº”ç”¨è¿‡æ»¤å™¨ï¼Œåˆ™ä½¿ç”¨applyAllFiltersæ–¹æ³•
          this.applyAllFilters(forceUpdate);
        } else {
          // å¦åˆ™ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
          const content = this.logLines.join('\n');

          // æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–ä¸”ä¸å¼ºåˆ¶æ›´æ–°ï¼Œåˆ™è·³è¿‡
          if (!forceUpdate && this.filteredContent === content) {
            console.log('å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡ç¼–è¾‘å™¨æ›´æ–°');
            return;
          }

          this.editor.setValue(content);
          this.filteredContent = content;
        }
      }

      // æ£€æµ‹ç”¨æˆ·æ˜¯å¦åœ¨ç¼–è¾‘å™¨åº•éƒ¨é™„è¿‘
      isNearBottom() {
        if (!this.scrollSnapEnabled) {
          return false;
        }

        const scrollTop = this.editor.getScrollTop();
        const scrollHeight = this.editor.getScrollHeight();
        const clientHeight = this.editor.getLayoutInfo().height;

        // è®¡ç®—è·ç¦»åº•éƒ¨çš„è·ç¦»
        const distanceFromBottom = scrollHeight - scrollTop - clientHeight;

        return distanceFromBottom <= this.scrollSnapThreshold;
      }

      // æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom() {
        // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨DOMæ›´æ–°åæ‰§è¡Œæ»šåŠ¨
        setTimeout(() => {
          const scrollHeight = this.editor.getScrollHeight();
          const clientHeight = this.editor.getLayoutInfo().height;
          const maxScrollTop = scrollHeight - clientHeight;

          console.log(`æ»šåŠ¨åˆ°åº•éƒ¨ - scrollHeight: ${scrollHeight}, clientHeight: ${clientHeight}, maxScrollTop: ${maxScrollTop}`);

          this.editor.setScrollTop(maxScrollTop);

          // éªŒè¯æ»šåŠ¨æ˜¯å¦æˆåŠŸï¼Œå¦‚æœä¸æˆåŠŸåˆ™å°è¯•å¤‡ç”¨æ–¹æ³•
          setTimeout(() => {
            const actualScrollTop = this.editor.getScrollTop();
            console.log(`æ»šåŠ¨åå®é™…ä½ç½®: ${actualScrollTop}, ç›®æ ‡ä½ç½®: ${maxScrollTop}`);

            // å¦‚æœæ»šåŠ¨æ²¡æœ‰æˆåŠŸï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•
            if (Math.abs(actualScrollTop - maxScrollTop) > 10) {
              console.log('ä¸»è¦æ»šåŠ¨æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•');
              this.scrollToBottomAlternative();
            }
          }, 50);
        }, 10);
      }

      // å¤‡ç”¨æ»šåŠ¨åˆ°åº•éƒ¨æ–¹æ³•
      scrollToBottomAlternative() {
        try {
          // æ–¹æ³•1ï¼šä½¿ç”¨revealLineInCenteræ»šåŠ¨åˆ°æœ€åä¸€è¡Œ
          const lineCount = this.editor.getModel().getLineCount();
          this.editor.revealLineInCenter(lineCount);
          console.log(`å¤‡ç”¨æ–¹æ³•1ï¼šæ»šåŠ¨åˆ°ç¬¬${lineCount}è¡Œ`);

          // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1ä¸å·¥ä½œï¼Œä½¿ç”¨setScrollTopçš„æå¤§å€¼
          setTimeout(() => {
            this.editor.setScrollTop(Number.MAX_SAFE_INTEGER);
            console.log('å¤‡ç”¨æ–¹æ³•2ï¼šä½¿ç”¨æå¤§å€¼æ»šåŠ¨');
          }, 100);
        } catch (error) {
          console.error('å¤‡ç”¨æ»šåŠ¨æ–¹æ³•å¤±è´¥:', error);
        }
      }

      // è¿½åŠ æ–°å†…å®¹åˆ°ç¼–è¾‘å™¨
      appendNewContent(newLines) {
        // å¯¹æ–°è¡Œåº”ç”¨å½“å‰è¿‡æ»¤å™¨
        let filteredNewLines = newLines;

        // åº”ç”¨æœç´¢è¿‡æ»¤
        if (this.currentSearchQuery && this.currentSearchQuery.trim()) {
          try {
            let searchPattern;
            if (this.useRegex) {
              searchPattern = new RegExp(this.currentSearchQuery, 'gi');
            } else {
              searchPattern = new RegExp(this.currentSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            }

            filteredNewLines = filteredNewLines.filter(line => {
              return searchPattern.test(line);
            });
          } catch (error) {
            console.error('æœç´¢æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯:', error);
            const searchTerm = this.currentSearchQuery.toLowerCase();
            filteredNewLines = filteredNewLines.filter(line => {
              return line.toLowerCase().includes(searchTerm);
            });
          }
        }

        // åº”ç”¨æ—¥æœŸè¿‡æ»¤
        if (this.startDate || this.endDate) {
          filteredNewLines = filteredNewLines.filter(line => {
            const timestamp = this.extractTimestamp(line);
            if (!timestamp) return true;

            const logTime = new Date(timestamp);

            if (this.startDate && logTime < this.startDate) {
              return false;
            }

            if (this.endDate && logTime > this.endDate) {
              return false;
            }

            return true;
          });
        }

        // åº”ç”¨çº§åˆ«è¿‡æ»¤
        if (this.selectedLevels.size > 0) {
          filteredNewLines = filteredNewLines.filter(line => {
            for (const level of this.selectedLevels) {
              const levelUpper = level.toUpperCase();
              const levelLower = level.toLowerCase();

              const bracketPattern = new RegExp(`\\[${levelUpper}\\]`, 'i');
              const anglePattern = new RegExp(`<${levelUpper}>`, 'i');
              const textPattern = new RegExp(`\\b${levelUpper}\\b`, 'i');
              const lowerPattern = new RegExp(`\\b${levelLower}\\b`, 'i');

              if (bracketPattern.test(line) ||
                anglePattern.test(line) ||
                textPattern.test(line) ||
                lowerPattern.test(line)) {
                return true;
              }
            }
            return false;
          });
        }

        // å¦‚æœæœ‰è¿‡æ»¤åçš„æ–°å†…å®¹ï¼Œè¿½åŠ åˆ°ç¼–è¾‘å™¨
        if (filteredNewLines.length > 0) {
          const newContent = filteredNewLines.join('\n');
          console.log(`å‡†å¤‡è¿½åŠ å†…å®¹: ${newContent.substring(0, 100)}...`);

          // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨é™„è¿‘ï¼ˆåœ¨æ›´æ–°å†…å®¹å‰æ£€æŸ¥ï¼‰
          const wasNearBottom = this.isNearBottom();
          console.log(`ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨é™„è¿‘: ${wasNearBottom}`);

          // è·å–å½“å‰å…‰æ ‡ä½ç½®å’Œé€‰ä¸­çŠ¶æ€
          const currentSelection = this.editor.getSelection();
          const currentScrollTop = this.editor.getScrollTop();
          const currentScrollLeft = this.editor.getScrollLeft();

          // è·å–å½“å‰å†…å®¹å¹¶è¿½åŠ æ–°å†…å®¹
          const currentContent = this.editor.getValue();
          const separator = currentContent ? '\n' : '';
          const updatedContent = currentContent + separator + newContent;

          console.log(`å½“å‰å†…å®¹é•¿åº¦: ${currentContent.length}, æ–°å†…å®¹é•¿åº¦: ${newContent.length}`);

          // è®¾ç½®æ›´æ–°åçš„å†…å®¹
          this.editor.setValue(updatedContent);

          // æ›´æ–°è¿‡æ»¤åçš„å†…å®¹
          this.filteredContent = updatedContent;

          // åº”ç”¨æ»šåŠ¨å¸é™„é€»è¾‘
          if (wasNearBottom) {
            // å¦‚æœç”¨æˆ·ä¹‹å‰åœ¨åº•éƒ¨é™„è¿‘ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæ–°å†…å®¹
            console.log('åº”ç”¨æ»šåŠ¨å¸é™„ï¼šæ»šåŠ¨åˆ°åº•éƒ¨');
            this.scrollToBottom();
          } else {
            // å¦‚æœç”¨æˆ·ä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œä¿æŒåŸæ¥çš„æ»šåŠ¨ä½ç½®
            console.log('ä¿æŒç”¨æˆ·æ»šåŠ¨ä½ç½®');
            // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨DOMæ›´æ–°åæ¢å¤æ»šåŠ¨ä½ç½®
            setTimeout(() => {
              this.editor.setScrollTop(currentScrollTop);
              this.editor.setScrollLeft(currentScrollLeft);
            }, 10);
          }

          // æ¢å¤ç”¨æˆ·çš„é€‰ä¸­çŠ¶æ€ï¼ˆä½†ä¸æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œå› ä¸ºå·²ç»å¤„ç†äº†æ»šåŠ¨å¸é™„ï¼‰
          if (currentSelection) {
            this.editor.setSelection(currentSelection);
          }

          console.log(`è¿½åŠ äº† ${filteredNewLines.length} è¡Œè¿‡æ»¤åçš„å†…å®¹`);
        } else {
          console.log('æ²¡æœ‰è¿‡æ»¤åçš„æ–°å†…å®¹éœ€è¦è¿½åŠ ');
        }
      }

      search(query) {
        this.currentSearchQuery = query;
        this.applyAllFilters(true); // ç”¨æˆ·ä¸»åŠ¨æœç´¢æ—¶å¼ºåˆ¶æ›´æ–°
      }

      // åº”ç”¨æ‰€æœ‰è¿‡æ»¤å™¨
      applyAllFilters(forceUpdate = false) {
        let filteredLines = this.logLines;

        // æœç´¢è¿‡æ»¤
        if (this.currentSearchQuery && this.currentSearchQuery.trim()) {
          try {
            let searchPattern;
            if (this.useRegex) {
              searchPattern = new RegExp(this.currentSearchQuery, 'gi');
            } else {
              searchPattern = new RegExp(this.currentSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            }

            filteredLines = filteredLines.filter(line => {
              return searchPattern.test(line);
            });

          } catch (error) {
            console.error('æœç´¢æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯:', error);
            // æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯ï¼Œå›é€€åˆ°æ™®é€šæœç´¢
            const searchTerm = this.currentSearchQuery.toLowerCase();
            filteredLines = filteredLines.filter(line => {
              return line.toLowerCase().includes(searchTerm);
            });
          }
        }

        // æ—¥æœŸè¿‡æ»¤
        if (this.startDate || this.endDate) {
          filteredLines = filteredLines.filter(line => {
            const timestamp = this.extractTimestamp(line);
            if (!timestamp) return true; // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œä¿ç•™è¯¥è¡Œ

            const logTime = new Date(timestamp);

            if (this.startDate && logTime < this.startDate) {
              return false;
            }

            if (this.endDate && logTime > this.endDate) {
              return false;
            }

            return true;
          });
        }

        // çº§åˆ«è¿‡æ»¤
        if (this.selectedLevels.size > 0) {
          filteredLines = filteredLines.filter(line => {
            for (const level of this.selectedLevels) {
              const levelUpper = level.toUpperCase();
              const levelLower = level.toLowerCase();

              // æ”¯æŒå¤šç§æ—¥å¿—æ ¼å¼
              const bracketPattern = new RegExp(`\\[${levelUpper}\\]`, 'i');
              const anglePattern = new RegExp(`<${levelUpper}>`, 'i');
              const textPattern = new RegExp(`\\b${levelUpper}\\b`, 'i');
              const lowerPattern = new RegExp(`\\b${levelLower}\\b`, 'i');

              if (bracketPattern.test(line) ||
                anglePattern.test(line) ||
                textPattern.test(line) ||
                lowerPattern.test(line)) {
                return true;
              }
            }
            return false;
          });
        } else {
          // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•çº§åˆ«ï¼Œç¡®ä¿"all"æŒ‰é’®è¢«é€‰ä¸­
          const allTag = document.querySelector(`[data-level="all"]`);
          if (allTag && !allTag.classList.contains('active')) {
            allTag.classList.add('active');
          }
        }

        // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
        const content = filteredLines.join('\n');

        // æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–ä¸”ä¸å¼ºåˆ¶æ›´æ–°ï¼Œåˆ™è·³è¿‡
        if (!forceUpdate && this.filteredContent === content) {
          console.log('è¿‡æ»¤åå†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡ç¼–è¾‘å™¨æ›´æ–°');
          return;
        }

        this.editor.setValue(content);
        this.filteredContent = content;

        // ä½¿ç”¨Monaco Editorçš„æœç´¢åŠŸèƒ½è¿›è¡Œé«˜äº®
        if (this.currentSearchQuery) {
          this.highlightSearchInEditor(this.currentSearchQuery);
        }

        // æ›´æ–°æœç´¢ç»Ÿè®¡
        this.updateSearchStats(filteredLines.length);
      }

      // æå–æ—¶é—´æˆ³
      extractTimestamp(line) {
        // åŒ¹é… [YYYY-MM-DD HH:mm:ss.sss] æ ¼å¼
        const timestampMatch = line.match(/\[(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:\.\d{3})?)\]/);
        if (timestampMatch) {
          return timestampMatch[1];
        }

        // åŒ¹é…å…¶ä»–å¸¸è§çš„æ—¶é—´æˆ³æ ¼å¼
        const otherFormats = [
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?Z?)/, // ISOæ ¼å¼
          /(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}:\d{2})/, // YYYY/MM/DD HH:mm:ss
          /(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2})/, // MM/DD/YYYY HH:mm:ss
        ];

        for (const format of otherFormats) {
          const match = line.match(format);
          if (match) {
            return match[1];
          }
        }

        return null;
      }

      // åœ¨ç¼–è¾‘å™¨ä¸­é«˜äº®æœç´¢å†…å®¹
      highlightSearchInEditor(query) {
        try {
          // æ¸…é™¤ä¹‹å‰çš„æœç´¢é«˜äº®
          this.editor.getModel().findMatches('', false, true, true, null, true);

          // æ‰§è¡Œæœç´¢å¹¶é«˜äº®æ˜¾ç¤º
          const matches = this.editor.getModel().findMatches(
            query,
            this.useRegex, // isRegex
            false,         // matchCase
            false,         // wholeWord
            null,          // wordSeparators
            true           // captureMatches
          );

          // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
          if (matches.length > 0) {
            this.editor.setPosition(matches[0].range.getStartPosition());
            this.editor.revealLineInCenter(matches[0].range.startLineNumber);
            this.editor.setSelection(matches[0].range);
          }

        } catch (error) {
          console.error('ç¼–è¾‘å™¨æœç´¢é«˜äº®é”™è¯¯:', error);
        }
      }

      clearSearch() {
        this.currentSearchQuery = '';
        this.editor.getModel().findMatches('', false, true, true, null, true);
        this.applyAllFilters(true); // ç”¨æˆ·ä¸»åŠ¨æ¸…é™¤æœç´¢æ—¶å¼ºåˆ¶æ›´æ–°
      }


      updateSearchStats(count) {
        const stats = document.getElementById('searchStats');
        if (count > 0) {
          stats.textContent = `æ‰¾åˆ° ${count} ä¸ªåŒ¹é…é¡¹`;
        } else {
          stats.textContent = '';
        }
      }


      toggleRegex() {
        this.useRegex = !this.useRegex;
        const btn = document.getElementById('regexToggleBtn');
        if (this.useRegex) {
          btn.classList.add('active');
          btn.textContent = '.*';
          btn.title = 'æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ (å·²å¯ç”¨)';
        } else {
          btn.classList.remove('active');
          btn.textContent = '.*';
          btn.title = 'åˆ‡æ¢æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼';
        }

        // é‡æ–°æœç´¢å½“å‰æŸ¥è¯¢
        const currentQuery = document.getElementById('searchInput').value;
        if (currentQuery) {
          this.search(currentQuery);
        } else {
          // å¦‚æœæ²¡æœ‰æœç´¢æŸ¥è¯¢ï¼Œä¹Ÿè¦é‡æ–°åº”ç”¨è¿‡æ»¤å™¨
          this.applyAllFilters(true);
        }
      }


      gotoTop() {
        this.editor.setPosition({ lineNumber: 1, column: 1 });
        this.editor.revealLineInCenter(1);
      }

      gotoBottom() {
        const lineCount = this.editor.getModel().getLineCount();
        this.editor.setPosition({ lineNumber: lineCount, column: 1 });
        this.editor.revealLineInCenter(lineCount);
      }

      toggleLevelFilter(level) {
        const tag = document.querySelector(`[data-level="${level}"]`);

        if (level === 'all') {
          // é€šé…ç¬¦æŒ‰é’®ï¼šæ¸…é™¤æ‰€æœ‰å…¶ä»–é€‰æ‹©ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
          this.selectedLevels.clear();
          document.querySelectorAll('.level-filter-tag').forEach(t => t.classList.remove('active'));
          tag.classList.add('active');
        } else {
          // æ™®é€šçº§åˆ«æŒ‰é’®
          if (this.selectedLevels.has(level)) {
            this.selectedLevels.delete(level);
            tag.classList.remove('active');
          } else {
            this.selectedLevels.add(level);
            tag.classList.add('active');
          }

          // å¦‚æœé€‰æ‹©äº†ä»»ä½•çº§åˆ«ï¼Œå–æ¶ˆé€šé…ç¬¦çš„é€‰ä¸­çŠ¶æ€
          if (this.selectedLevels.size > 0) {
            const allTag = document.querySelector(`[data-level="all"]`);
            allTag.classList.remove('active');
          }
        }

        this.applyLevelFilter();
      }

      applyLevelFilter() {
        this.applyAllFilters(true); // ç”¨æˆ·ä¸»åŠ¨æ”¹å˜çº§åˆ«è¿‡æ»¤æ—¶å¼ºåˆ¶æ›´æ–°
      }


      updateFileInfo(customText = null) {
        const fileInfo = document.getElementById('fileInfo');
        if (customText) {
          fileInfo.textContent = customText;
        } else if (this.file) {
          const size = (this.file.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `${this.file.name} (${size} MB)`;
        } else {
          fileInfo.textContent = 'Electronåº”ç”¨æ—¥å¿—';
        }
      }

      showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
      }

      hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
      }

      showError(message) {
        this.editor.setValue(`é”™è¯¯: ${message}`);
        this.hideLoading();
      }

      enableControls() {
        const searchInput = document.getElementById('searchInput');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const regexToggleBtn = document.getElementById('regexToggleBtn');

        if (searchInput) searchInput.disabled = false;
        if (startTime) startTime.disabled = false;
        if (endTime) endTime.disabled = false;
        if (regexToggleBtn) regexToggleBtn.disabled = false;
      }

      clear() {
        this.file = null;
        this.originalContent = '';
        this.filteredContent = '';
        this.previousOriginalContent = ''; // é‡ç½®ä¸Šä¸€æ¬¡çš„å†…å®¹
        this.searchResults = [];
        this.currentSearchIndex = -1;
        this.selectedLevels.clear();

        // é‡ç½®æ—¥å¿—è¡Œæ•°ç»„
        this.logLines = [];
        this.currentSearchQuery = '';

        // é‡ç½®æ—¥æœŸè¿‡æ»¤
        this.startDate = null;
        this.endDate = null;

        this.editor.setValue('');

        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('searchInput');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const regexToggleBtn = document.getElementById('regexToggleBtn');

        if (fileInput) fileInput.value = '';
        if (searchInput) {
          searchInput.value = '';
          searchInput.disabled = true;
        }
        if (startTime) {
          startTime.value = '';
          startTime.disabled = true;
        }
        if (endTime) {
          endTime.value = '';
          endTime.disabled = true;
        }
        if (regexToggleBtn) regexToggleBtn.disabled = true;

        // é‡ç½®æ‰€æœ‰ç­‰çº§è¿‡æ»¤æ ‡ç­¾ï¼Œé»˜è®¤é€‰ä¸­é€šé…ç¬¦
        document.querySelectorAll('.level-filter-tag').forEach(tag => {
          tag.classList.remove('active');
        });
        const allTag = document.querySelector(`[data-level="all"]`);
        if (allTag) allTag.classList.add('active');

        this.updateFileInfo('Electronåº”ç”¨æ—¥å¿—');
        this.updateSearchStats(0);
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
          emptyState.innerHTML = `
            <p>Electronåº”ç”¨æ—¥å¿—å·²æ¸…ç©º</p>
            <p style="font-size: 12px; margin-top: 10px; color: #666;">
              ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½æ—¥å¿—
            </p>
          `;
          emptyState.style.display = 'block';
        }
      }

      // æ–°å¢çš„æ–¹æ³•
      async clearLogs() {
        // å¦‚æœå½“å‰æ˜¯æ–‡ä»¶æ¨¡å¼ï¼Œæç¤ºç”¨æˆ·
        if (this.file) {
          alert('å½“å‰æ­£åœ¨æŸ¥çœ‹æœ¬åœ°æ–‡ä»¶ï¼Œæ— æ³•æ¸…ç©ºElectronæ—¥å¿—ã€‚è¯·åˆ‡æ¢åˆ°Electronæ—¥å¿—æ¨¡å¼ã€‚');
          return;
        }

        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰Electronåº”ç”¨æ—¥å¿—å—ï¼Ÿ")) {
          try {
            // æ£€æŸ¥æ˜¯å¦æœ‰electronAPIå¯ç”¨
            if (!naimo || !naimo.router) {
              throw new Error('Electron API ä¸å¯ç”¨');
            }

            // è°ƒç”¨IPCæ¸…ç©ºæ—¥å¿—
            await naimo.router.logClearLogs();

            // æ¸…ç©ºæœ¬åœ°æ•°æ®
            this.clear();

            // é‡æ–°åŠ è½½æ—¥å¿—ï¼ˆæ¸…ç©ºåé‡æ–°åŠ è½½ï¼Œä¸ä½¿ç”¨ç´¯åŠ é€»è¾‘ï¼‰
            await this.loadElectronLogsInitial();

          } catch (error) {
            console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
            alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message);
          }
        }
      }

      async exportLogs() {
        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰electronAPIå¯ç”¨
          if (!naimo || !naimo.router) {
            throw new Error('Electron API ä¸å¯ç”¨');
          }

          // è·å–è¦å¯¼å‡ºçš„å†…å®¹
          const data = this.filteredContent || this.originalContent;
          if (!data) {
            alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—å†…å®¹");
            return;
          }

          // åˆ›å»ºä¸‹è½½
          const blob = new Blob([data], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `electron-logs-${new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/:/g, "-")}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

        } catch (error) {
          console.error('å¯¼å‡ºæ—¥å¿—å¤±è´¥:', error);
          alert('å¯¼å‡ºæ—¥å¿—å¤±è´¥: ' + error.message);
        }
      }

      async refreshLogs() {
        try {
          // å¦‚æœå½“å‰æœ‰é€‰æ‹©çš„æ–‡ä»¶ï¼Œé‡æ–°åŠ è½½æ–‡ä»¶
          if (this.file) {
            await this.loadFile(this.file);
          } else {
            // å¦åˆ™é‡æ–°åŠ è½½Electronæ—¥å¿—
            await this.loadElectronLogs();
          }

        } catch (error) {
          console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥:', error);
          alert('åˆ·æ–°æ—¥å¿—å¤±è´¥: ' + error.message);
        }
      }

      startAutoRefresh() {
        if (this.autoRefreshInterval) {
          clearInterval(this.autoRefreshInterval);
        }

        this.autoRefreshInterval = setInterval(async () => {
          await this.refreshLogs();
        }, this.refreshIntervalSeconds * 1000);
      }

      stopAutoRefresh() {
        if (this.autoRefreshInterval) {
          clearInterval(this.autoRefreshInterval);
          this.autoRefreshInterval = null;
        }
      }

      toggleAutoRefresh() {
        // å¦‚æœå½“å‰æ˜¯æ–‡ä»¶æ¨¡å¼ï¼Œæç¤ºç”¨æˆ·
        if (this.file) {
          alert('å½“å‰æ­£åœ¨æŸ¥çœ‹æœ¬åœ°æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ä»…åœ¨Electronæ—¥å¿—æ¨¡å¼ä¸‹å¯ç”¨ã€‚');
          return;
        }

        this.autoRefreshEnabled = !this.autoRefreshEnabled;
        const btn = document.getElementById("autoRefreshBtn");

        if (this.autoRefreshEnabled) {
          btn.textContent = "åœæ­¢è‡ªåŠ¨åˆ·æ–°";
          btn.classList.add("active");
          this.startAutoRefresh();
        } else {
          btn.textContent = "è‡ªåŠ¨åˆ·æ–°";
          btn.classList.remove("active");
          this.stopAutoRefresh();
        }
      }

      // çª—å£æ§åˆ¶æ–¹æ³•
      minimizeWindow() {
        if (naimo && naimo.router) {
          naimo.router.windowMinimize();
        }
      }

      maximizeWindow() {
        if (naimo && naimo.router) {
          naimo.router.windowMaximize();
        }
      }

      closeWindow() {
        if (naimo && naimo.router) {
          naimo.router.windowClose();
        }
      }

      // åˆ‡æ¢å›Electronæ—¥å¿—æ¨¡å¼
      async switchToElectronLogs() {
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';

        // é‡ç½®æ–‡ä»¶å¯¹è±¡
        this.file = null;

        // é‡æ–°åŠ è½½Electronæ—¥å¿—ï¼ˆä½¿ç”¨åˆå§‹åŠ è½½æ–¹æ³•ï¼‰
        await this.loadElectronLogsInitial();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      new MonacoLogViewer();
    });
  </script>
</body>

</html>