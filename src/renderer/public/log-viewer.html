<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Êó•ÂøóÈòÖËØªÂô®</title>

  <!-- Editor CDN -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Consolas", "Monaco", "Courier New", monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: #2d2d30;
      padding: 12px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      -webkit-app-region: drag;
      user-select: none;
    }

    .header h1 {
      color: #569cd6;
      font-size: 18px;
      margin: 0;
    }

    .upload-section {
      display: flex;
      align-items: center;
      gap: 15px;
      -webkit-app-region: no-drag;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .file-input-label {
      display: inline-block;
      padding: 8px 16px;
      background: #007acc;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .file-input-label:hover {
      background: #005a9e;
    }

    .file-info {
      color: #cccccc;
      font-size: 14px;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .window-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    .window-btn.close:hover {
      background: #e81123;
      box-shadow: 0 4px 8px rgba(232, 17, 35, 0.4);
    }

    .window-btn svg {
      width: 18px;
      height: 18px;
      fill: #ffffff;
      opacity: 1;
      filter: brightness(1.2) contrast(1.2);
    }

    .window-btn:hover svg {
      filter: brightness(1.4) contrast(1.4);
    }

    .window-btn.close:hover svg {
      fill: white;
      filter: brightness(1.4) contrast(1.4);
    }

    .controls {
      background: #252526;
      padding: 10px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .controls-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      flex: 1;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      width: 250px;
    }

    .search-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .search-input:disabled {
      background: #2d2d30;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .date-range-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      color: #cccccc;
      font-size: 12px;
      white-space: nowrap;
    }

    .date-range-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .date-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      width: 140px;
    }

    .date-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .date-input:disabled {
      background: #2d2d30;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .date-separator {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
    }

    .log-level-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-level-filters {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .search-stats {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
      margin-left: auto;
    }

    .view-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }


    .level-filter-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      background: #3c3c3c;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .level-filter-tag:hover {
      background: #4a4a4a;
    }

    .level-filter-tag.active {
      background: #007acc;
      border-color: #007acc;
      color: white;
    }

    .level-filter-tag.active.error {
      background: #f44747;
      border-color: #f44747;
      color: white;
    }

    .level-filter-tag.active.warn {
      background: #ffcc02;
      border-color: #ffcc02;
      color: #1e1e1e;
    }

    .level-filter-tag.active.info {
      background: #75beff;
      border-color: #75beff;
      color: white;
    }

    .level-filter-tag.active.debug {
      background: #4ec9b0;
      border-color: #4ec9b0;
      color: white;
    }

    .level-filter-tag.active.trace {
      background: #9cdcfe;
      border-color: #9cdcfe;
      color: #1e1e1e;
    }

    .level-filter-tag.error {
      border-color: #f44747;
    }

    .level-filter-tag.warn {
      border-color: #ffcc02;
    }

    .level-filter-tag.info {
      border-color: #75beff;
    }

    .level-filter-tag.debug {
      border-color: #4ec9b0;
    }

    .level-filter-tag.trace {
      border-color: #9cdcfe;
    }

    .level-filter-tag.all {
      border-color: #9cdcfe;
      font-weight: bold;
    }

    .level-filter-tag.active.all {
      background: #9cdcfe;
      border-color: #9cdcfe;
      color: #1e1e1e;
    }

    .search-stats {
      color: #808080;
      font-size: 12px;
      white-space: nowrap;
    }

    .view-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .btn {
      padding: 6px 12px;
      border: 1px solid #555;
      background: #3c3c3c;
      color: #d4d4d4;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #4a4a4a;
    }

    .btn.active {
      background: #007acc;
      border-color: #007acc;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.primary {
      background: #007acc;
      border-color: #007acc;
      color: white;
    }

    .btn.primary:hover {
      background: #005a9e;
    }

    .btn.active {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }

    .btn.active:hover {
      background: #45a049;
    }

    .filter-input {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #007acc;
    }

    .editor-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .loading-spinner {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #3c3c3c;
      border-top: 3px solid #007acc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #808080;
      font-size: 16px;
    }

    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: #007acc;
      transition: width 0.3s ease;
      z-index: 1000;
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 1200px) {
      .controls-left {
        gap: 15px;
      }

      .search-input {
        width: 200px;
      }

      .date-input {
        width: 120px;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .upload-section {
        justify-content: center;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .controls-left {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .search-box,
      .date-range-box,
      .log-level-box {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .search-input {
        width: 100%;
      }

      .date-range-container {
        justify-content: center;
      }

      .date-input {
        width: 100%;
      }

      .log-level-filters {
        justify-content: center;
      }

      .search-stats {
        margin-left: 0;
        text-align: center;
      }

      .view-controls {
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üìÑ Êó•ÂøóÈòÖËØªÂô®</h1>
    <div class="h-upload-section" style="display: none;">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" class="file-input" accept=".log,.txt,.json,.csv">
        <label for="fileInput" class="file-input-label">ÈÄâÊã©Êó•ÂøóÊñá‰ª∂</label>
      </div>
      <div class="file-info" id="fileInfo">Êú™ÈÄâÊã©Êñá‰ª∂</div>
    </div>
    <div class="window-controls">
      <button class="window-btn minimize" id="minimizeBtn" title="ÊúÄÂ∞èÂåñ">
        <svg viewBox="0 0 12 12">
          <rect x="2" y="5.5" width="8" height="1" fill="currentColor" />
        </svg>
      </button>
      <button class="window-btn maximize" id="maximizeBtn" title="ÊúÄÂ§ßÂåñ">
        <svg viewBox="0 0 12 12">
          <rect x="2" y="2" width="8" height="8" fill="none" stroke="currentColor" stroke-width="1" />
        </svg>
      </button>
      <button class="window-btn close" id="closeBtn" title="ÂÖ≥Èó≠">
        <svg viewBox="0 0 12 12">
          <path d="M3 3l6 6M9 3l-6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
      </button>
    </div>
  </div>

  <div class="controls">
    <div class="controls-left">
      <div class="search-box">
        <label class="control-label">ÊêúÁ¥¢:</label>
        <input type="text" id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢Êó•ÂøóÂÜÖÂÆπ..." disabled>
        <button class="btn" id="regexToggleBtn" disabled title="ÂàáÊç¢Ê≠£ÂàôË°®ËææÂºèÊ®°Âºè">.*</button>
      </div>

      <div class="date-range-box">
        <label class="control-label">Êó∂Èó¥ËåÉÂõ¥:</label>
        <div class="date-range-container">
          <input type="datetime-local" id="startTime" class="date-input" disabled>
          <span class="date-separator">Ëá≥</span>
          <input type="datetime-local" id="endTime" class="date-input" disabled>
        </div>
      </div>

      <div class="log-level-box">
        <label class="control-label">Êó•ÂøóÁ∫ßÂà´:</label>
        <div class="log-level-filters">
          <div class="level-filter-tag error" data-level="error">ERROR</div>
          <div class="level-filter-tag warn" data-level="warn">WARN</div>
          <div class="level-filter-tag info" data-level="info">INFO</div>
          <div class="level-filter-tag debug" data-level="debug">DEBUG</div>
          <div class="level-filter-tag trace" data-level="trace">TRACE</div>
          <div class="level-filter-tag all" data-level="all" title="ÊòæÁ§∫ÊâÄÊúâÊó•Âøó">*</div>
        </div>
      </div>

      <div class="search-stats" id="searchStats"></div>
    </div>
    <div class="view-controls">
      <button class="btn" id="clearLogs">Ê∏ÖÁ©∫Êó•Âøó</button>
      <button class="btn" id="exportLogs">ÂØºÂá∫Êó•Âøó</button>
      <button class="btn primary" id="refreshLogs">Âà∑Êñ∞</button>
      <button class="btn" id="autoRefreshBtn">Ëá™Âä®Âà∑Êñ∞</button>
      <select id="refreshInterval" class="filter-input">
        <option value="1" selected>1Áßí</option>
        <option value="2">2Áßí</option>
        <option value="3">3Áßí</option>
        <option value="4">4Áßí</option>
        <option value="5">5Áßí</option>
        <option value="10">10Áßí</option>
        <option value="30">30Áßí</option>
      </select>
    </div>
  </div>

  <div class="editor-container">
    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
    <div id="monaco-editor" style="width: 100%; height: 100%;"></div>
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
      <div class="spinner"></div>
    </div>
    <div class="empty-state" id="emptyState">
      <p>Ê≠£Âú®Âä†ËΩΩElectronÂ∫îÁî®Êó•Âøó...</p>
      <p style="font-size: 12px; margin-top: 10px; color: #666;">
        Â¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂìçÂ∫îÔºåËØ∑Ê£ÄÊü•Electron APIÊòØÂê¶ÂèØÁî®
      </p>
      <p style="font-size: 11px; margin-top: 8px; color: #555;">
        ÊÇ®‰πüÂèØ‰ª•ÈÄâÊã©Êú¨Âú∞Êó•ÂøóÊñá‰ª∂ËøõË°åÊü•Áúã
      </p>
    </div>
  </div>

  <script>
    class MonacoLogViewer {
      constructor() {
        this.editor = null;
        this.file = null;
        this.fileContent = '';
        this.searchResults = [];
        this.currentSearchIndex = -1;
        this.isLoading = false;
        this.useRegex = false;
        this.selectedLevels = new Set();
        this.originalContent = '';
        this.filteredContent = '';
        this.previousOriginalContent = ''; // Â≠òÂÇ®‰∏ä‰∏ÄÊ¨°ÁöÑÂéüÂßãÂÜÖÂÆπÁî®‰∫éÂØπÊØî

        // Êó•ÂøóË°åÊï∞ÁªÑ
        this.logLines = [];
        this.currentSearchQuery = '';

        // Êó•ÊúüËøáÊª§
        this.startDate = null;
        this.endDate = null;

        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥
        this.autoRefreshEnabled = false;
        this.autoRefreshInterval = null;
        this.refreshIntervalSeconds = 1;

        // ÊªöÂä®Âê∏ÈôÑÁõ∏ÂÖ≥
        this.scrollSnapEnabled = true; // ÈªòËÆ§ÂêØÁî®ÊªöÂä®Âê∏ÈôÑ
        this.scrollSnapThreshold = 120; // Ë∑ùÁ¶ªÂ∫ïÈÉ®80pxÂÜÖËÆ§‰∏∫ÊòØ"Â∫ïÈÉ®ÈôÑËøë"

        this.init();
      }

      async init() {
        await this.initializeMonaco();
        this.bindEvents();
        // ÂàùÂßãÂåñÊó∂Ëá™Âä®Âä†ËΩΩElectronÊó•ÂøóÔºà‰ΩøÁî®ÂàùÂßãÂä†ËΩΩÊñπÊ≥ïÔºâ
        await this.loadElectronLogsInitial();
      }

      async initializeMonaco() {
        return new Promise((resolve) => {
          require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
          require(['vs/editor/editor.main'], () => {
            this.registerLogLanguage();
            this.setupMonacoEditor();
            resolve();
          });
        });
      }

      setupMonacoEditor() {
        this.editor = monaco.editor.create(document.getElementById('monaco-editor'), {
          value: '',
          language: 'log',
          theme: 'log-theme',
          readOnly: true,
          wordWrap: 'on',
          lineNumbers: 'on',
          minimap: { enabled: true },
          scrollBeyondLastLine: false,
          automaticLayout: true,
          fontSize: 13,
          fontFamily: 'Consolas, Monaco, "Courier New", monospace',
          lineHeight: 20,
          cursorBlinking: 'blink',
          cursorStyle: 'line',
          selectOnLineNumbers: true,
          roundedSelection: false,
          contextmenu: true,
          mouseWheelZoom: true,
          smoothScrolling: true,
          renderWhitespace: 'selection',
          renderControlCharacters: true,
          renderIndentGuides: true,
          highlightActiveIndentGuide: true,
          bracketPairColorization: { enabled: true },
          guides: {
            bracketPairs: true,
            indentation: true
          }
        });

        // ÈöêËóèÁ©∫Áä∂ÊÄÅ
        document.getElementById('emptyState').style.display = 'none';
      }

      registerLogLanguage() {
        // Ê≥®ÂÜåÊó•ÂøóËØ≠Ë®Ä
        monaco.languages.register({ id: 'log' });

        // ÂÆö‰πâÊó•ÂøóËØ≠Ê≥ïÈ´ò‰∫ÆËßÑÂàô - ‰øÆÂ§çÁâàÊú¨
        monaco.languages.setMonarchTokensProvider('log', {
          tokenizer: {
            root: [
              // Êó∂Èó¥Êà≥Ê†ºÂºè [YYYY-MM-DD HH:mm:ss.sss]
              [/\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:\.\d{3})?/, 'timestamp-token'],

              // Êó•ÂøóÁ∫ßÂà´ - [info], [debug], [error] Á≠âÊ†ºÂºè
              [/(\[)(info)(\])/i, ['bracket', 'info-token', 'bracket']],
              [/(\[)(debug)(\])/i, ['bracket', 'debug-token', 'bracket']],
              [/(\[)(warn)(\])/i, ['bracket', 'warn-token', 'bracket']],
              [/(\[)(warning)(\])/i, ['bracket', 'warn-token', 'bracket']],
              [/(\[)(error)(\])/i, ['bracket', 'error-token', 'bracket']],
              [/(\[)(fatal)(\])/i, ['bracket', 'fatal-token', 'bracket']],
              [/(\[)(trace)(\])/i, ['bracket', 'trace-token', 'bracket']],

              // Êó•ÂøóÁ∫ßÂà´ - <info>, <debug>, <error> Á≠âÊ†ºÂºè
              [/(<)(info)(>)/i, ['delimiter', 'info-token', 'delimiter']],
              [/(<)(debug)(>)/i, ['delimiter', 'debug-token', 'delimiter']],
              [/(<)(warn)(>)/i, ['delimiter', 'warn-token', 'delimiter']],
              [/(<)(warning)(>)/i, ['delimiter', 'warn-token', 'delimiter']],
              [/(<)(error)(>)/i, ['delimiter', 'error-token', 'delimiter']],
              [/(<)(fatal)(>)/i, ['delimiter', 'fatal-token', 'delimiter']],
              [/(<)(trace)(>)/i, ['delimiter', 'trace-token', 'delimiter']],

              // Êó•ÂøóÁ∫ßÂà´ - Á∫ØÊñáÊú¨Ê†ºÂºè
              [/\b(info|debug|warn|warning|error|fatal|trace)\b/i, {
                cases: {
                  "info": "info-token",
                  "debug": "debug-token",
                  "warn": "warn-token",
                  "warning": "warn-token",
                  "error": "error-token",
                  "fatal": "fatal-token",
                  "trace": "trace-token"
                }
              }],

              // IPÂú∞ÂùÄ
              [/\b(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\b/, 'ip-address'],

              // URL
              [/(https?:\/\/[^\s]+)/, 'url'],

              // Êñá‰ª∂Ë∑ØÂæÑ (WindowsÂíåUnixÊ†ºÂºè)
              [/([A-Za-z]:\\[^\s]+|[\/][^\s]+)/, 'file-path'],

              // ÁâàÊú¨Âè∑ v1.2.3 Ê†ºÂºè
              [/\bv\d+\.\d+\.\d+\b/, 'version'],

              // JSONÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤
              [/"[^"]*"/, 'string'],
              [/'[^']*'/, 'string'],

              // Êï∞Â≠ó
              [/\b\d+(\.\d+)?\b/, 'number'],

              // HTTPÁä∂ÊÄÅÁ†Å
              [/\b(1\d{2}|2\d{2}|3\d{2}|4\d{2}|5\d{2})\b/, 'http-status'],

              // HTTPÊñπÊ≥ï
              [/\b(GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)\b/i, 'http-method'],

              // Â∏ÉÂ∞îÂÄºÂíånull
              [/\b(true|false|null|undefined)\b/i, 'keyword'],

              // ÂºÇÂ∏∏Â†ÜÊ†àÊ†áËØÜ
              [/^\s*at\s/, 'stack-trace'],
              [/^\s*Caused by:/, 'stack-trace'],

              // ÂÖ∂‰ªñÊñáÊú¨
              [/./, 'text']
            ]
          }
        });

        // ÂÆö‰πâ‰∏ªÈ¢òÈ¢úËâ≤ - ‰øÆÂ§çÁâàÊú¨
        monaco.editor.defineTheme('log-theme', {
          base: 'vs-dark',
          inherit: true,
          rules: [
            // Êó∂Èó¥Êà≥Ê†∑Âºè
            { token: 'timestamp-token', foreground: '808080' },

            // Êó•ÂøóÁ∫ßÂà´Ê†∑Âºè - ‰∏çÂêåÈ¢úËâ≤
            { token: 'error-token', foreground: 'f44747', fontStyle: 'bold' },
            { token: 'fatal-token', foreground: 'f44747', fontStyle: 'bold' },
            { token: 'warn-token', foreground: 'ffcc02', fontStyle: 'bold' },
            { token: 'warning-token', foreground: 'ffcc02', fontStyle: 'bold' },
            { token: 'info-token', foreground: '75beff', fontStyle: 'bold' },
            { token: 'debug-token', foreground: '4ec9b0', fontStyle: 'bold' },
            { token: 'trace-token', foreground: '9cdcfe', fontStyle: 'bold' },

            // ÁΩëÁªúÁõ∏ÂÖ≥
            { token: 'ip-address', foreground: 'ce9178' },
            { token: 'url', foreground: '9cdcfe', fontStyle: 'underline' },
            { token: 'http-method', foreground: '569cd6', fontStyle: 'bold' },
            { token: 'http-status', foreground: 'b5cea8', fontStyle: 'bold' },

            // Êñá‰ª∂Ë∑ØÂæÑ
            { token: 'file-path', foreground: 'ce9178' },

            // ÁâàÊú¨Âè∑
            { token: 'version', foreground: 'b5cea8', fontStyle: 'bold' },

            // Êï∞ÊçÆÁ±ªÂûã
            { token: 'string', foreground: 'ce9178' },
            { token: 'number', foreground: 'b5cea8' },
            { token: 'keyword', foreground: '569cd6', fontStyle: 'bold' },

            // ÂºÇÂ∏∏Â†ÜÊ†à
            { token: 'stack-trace', foreground: 'ff6b6b', fontStyle: 'italic' },

            // Êã¨Âè∑ÂíåÂàÜÈöîÁ¨¶ - ‰øùÊåÅÈªòËÆ§È¢úËâ≤
            { token: 'bracket', foreground: 'd4d4d4' },
            { token: 'delimiter', foreground: 'd4d4d4' },

            // ÈªòËÆ§ÊñáÊú¨
            { token: 'text', foreground: 'd4d4d4' }
          ],
          colors: {
            'editor.background': '#1e1e1e',
            'editor.foreground': '#d4d4d4',
            'editorLineNumber.foreground': '#858585',
            'editorLineNumber.activeForeground': '#c6c6c6',
            'editor.selectionBackground': '#264f78',
            'editor.selectionHighlightBackground': '#add6ff26',
            'editor.findMatchBackground': '#515c6a',
            'editor.findMatchHighlightBackground': '#ea5c0055',
            'editor.hoverHighlightBackground': '#264f7840',
            'editor.lineHighlightBackground': '#2d2d30',
            'editorCursor.foreground': '#aeafad',
            'editorWhitespace.foreground': '#3e4042'
          }
        });

        // Â∫îÁî®‰∏ªÈ¢ò
        monaco.editor.setTheme('log-theme');
      }

      bindEvents() {
        // Êñá‰ª∂ÈÄâÊã© - ‰Ωú‰∏∫Â§áÁî®ÈÄâÈ°π
        document.getElementById('fileInput').addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
            this.stopAutoRefresh();
            this.autoRefreshEnabled = false;
            const autoRefreshBtn = document.getElementById('autoRefreshBtn');
            if (autoRefreshBtn) {
              autoRefreshBtn.textContent = "Ëá™Âä®Âà∑Êñ∞";
              autoRefreshBtn.classList.remove("active");
            }

            // Âä†ËΩΩÈÄâÊã©ÁöÑÊñá‰ª∂
            this.loadFile(e.target.files[0]);
          }
        });

        // ÊêúÁ¥¢
        document.getElementById('searchInput').addEventListener('input', (e) => {
          this.search(e.target.value);
        });

        // ÊéßÂà∂ÊåâÈíÆ
        document.getElementById('clearLogs').addEventListener('click', () => {
          this.clearLogs();
        });

        document.getElementById('exportLogs').addEventListener('click', () => {
          this.exportLogs();
        });

        document.getElementById('refreshLogs').addEventListener('click', () => {
          this.refreshLogs();
        });

        document.getElementById('autoRefreshBtn').addEventListener('click', () => {
          this.toggleAutoRefresh();
        });

        document.getElementById('refreshInterval').addEventListener('change', (e) => {
          this.refreshIntervalSeconds = parseInt(e.target.value);
          if (this.autoRefreshEnabled) {
            this.stopAutoRefresh();
            this.startAutoRefresh();
          }
        });

        // Á™óÂè£ÊéßÂà∂ÊåâÈíÆ
        document.getElementById('minimizeBtn').addEventListener('click', () => {
          this.minimizeWindow();
        });

        document.getElementById('maximizeBtn').addEventListener('click', () => {
          this.maximizeWindow();
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
          this.closeWindow();
        });

        // Ê≠£ÂàôË°®ËææÂºèÂàáÊç¢ÊåâÈíÆ
        document.getElementById('regexToggleBtn').addEventListener('click', () => {
          this.toggleRegex();
        });

        // Êó•ÂøóÁ≠âÁ∫ßËøáÊª§Ê†áÁ≠æ
        document.querySelectorAll('.level-filter-tag').forEach(tag => {
          tag.addEventListener('click', () => {
            this.toggleLevelFilter(tag.dataset.level);
          });
        });

        // Êó•ÊúüËøáÊª§
        document.getElementById('startTime').addEventListener('change', (e) => {
          this.startDate = e.target.value ? new Date(e.target.value) : null;
          this.applyAllFilters(true); // Áî®Êà∑‰∏ªÂä®ÊîπÂèòÊó•ÊúüÊó∂Âº∫Âà∂Êõ¥Êñ∞
        });

        document.getElementById('endTime').addEventListener('change', (e) => {
          this.endDate = e.target.value ? new Date(e.target.value) : null;
          this.applyAllFilters(true); // Áî®Êà∑‰∏ªÂä®ÊîπÂèòÊó•ÊúüÊó∂Âº∫Âà∂Êõ¥Êñ∞
        });

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
              case 'f':
                e.preventDefault();
                document.getElementById('searchInput').focus();
                break;
              case 'Home':
                e.preventDefault();
                this.gotoTop();
                break;
              case 'End':
                e.preventDefault();
                this.gotoBottom();
                break;
              case 'r':
                e.preventDefault();
                this.refreshLogs();
                break;
            }
          } else if (e.key === 'Escape') {
            document.getElementById('searchInput').blur();
            this.clearSearch();
          }
        });
      }

      // ÂàùÂßãÂä†ËΩΩElectronÊó•ÂøóÔºà‰∏ç‰ΩøÁî®Á¥ØÂä†ÈÄªËæëÔºâ
      async loadElectronLogsInitial() {
        this.isLoading = true;
        this.updateFileInfo('ElectronÂ∫îÁî®Êó•Âøó');
        this.showLoading();

        try {
          // Ê£ÄÊü•ÊòØÂê¶ÊúâelectronAPIÂèØÁî®
          if (!window.electronAPI || !window.electronAPI.ipcRouter) {
            throw new Error('Electron API ‰∏çÂèØÁî®');
          }

          // Ëé∑ÂèñÂéüÂßãÊó•ÂøóÂÜÖÂÆπ
          const logContent = await window.electronAPI.ipcRouter.logGetRawLogContent();

          this.originalContent = logContent;
          this.previousOriginalContent = logContent;

          // Â∞ÜÂÜÖÂÆπÊåâË°åÂàÜÂâ≤
          this.logLines = logContent.split('\n').filter(line => line.trim() !== '');
          console.log(`ÂàùÂßãÂä†ËΩΩ ${this.logLines.length} ‰∏™Êó•ÂøóÊù°ÁõÆ`);

          // Â∫îÁî®ÂΩìÂâçËøáÊª§Âô®ÊòæÁ§∫ÂÜÖÂÆπ
          this.updateEditorContent(true, true);
          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('ÂàùÂßãÂä†ËΩΩElectronÊó•ÂøóÂ§±Ë¥•:', error);
          this.showError('ÂàùÂßãÂä†ËΩΩElectronÊó•ÂøóÂ§±Ë¥•: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      // Âà∑Êñ∞Âä†ËΩΩElectronÊó•ÂøóÔºà‰ΩøÁî®Á¥ØÂä†ÈÄªËæëÔºâ
      async loadElectronLogs() {
        this.isLoading = true;
        this.updateFileInfo('ElectronÂ∫îÁî®Êó•Âøó');
        this.showLoading();

        try {
          // Ê£ÄÊü•ÊòØÂê¶ÊúâelectronAPIÂèØÁî®
          if (!window.electronAPI || !window.electronAPI.ipcRouter) {
            throw new Error('Electron API ‰∏çÂèØÁî®');
          }

          // ‰øùÂ≠òÁî®Êà∑ÂΩìÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÂíåÊªöÂä®‰ΩçÁΩÆ
          const currentSelection = this.editor.getSelection();
          const currentScrollTop = this.editor.getScrollTop();
          const currentScrollLeft = this.editor.getScrollLeft();

          // Ëé∑ÂèñÂéüÂßãÊó•ÂøóÂÜÖÂÆπ
          const logContent = await window.electronAPI.ipcRouter.logGetRawLogContent();

          // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÂÜÖÂÆπ
          const hasNewContent = this.previousOriginalContent !== logContent;
          console.log(`ÊúâÊñ∞ÂÜÖÂÆπ: ${hasNewContent}`);

          if (hasNewContent) {
            // ËÆ°ÁÆóÊñ∞Â¢ûÁöÑÊó•ÂøóË°å
            const newLogLines = logContent.split('\n').filter(line => line.trim() !== '');
            const previousLogLines = this.previousOriginalContent ?
              this.previousOriginalContent.split('\n').filter(line => line.trim() !== '') : [];

            // ÊâæÂá∫Êñ∞Â¢ûÁöÑË°å
            const newLines = newLogLines.slice(previousLogLines.length);
            console.log(`Êñ∞Â¢û ${newLines.length} Ë°åÊó•Âøó`);

            if (newLines.length > 0) {
              // Á¥ØÂä†Êñ∞Êó•ÂøóË°å
              this.logLines = this.logLines.concat(newLines);
              this.originalContent = logContent;
              this.previousOriginalContent = logContent;

              // Â∫îÁî®ËøáÊª§Âô®Âπ∂ËøΩÂä†Êñ∞ÂÜÖÂÆπ
              this.appendNewContent(newLines);

              // ÊÅ¢Â§çÁî®Êà∑ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÂíåÊªöÂä®‰ΩçÁΩÆ
              if (currentSelection) {
                this.editor.setSelection(currentSelection);
              }
              this.editor.setScrollTop(currentScrollTop);
              this.editor.setScrollLeft(currentScrollLeft);
            }
          }

          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('Âä†ËΩΩElectronÊó•ÂøóÂ§±Ë¥•:', error);
          this.showError('Âä†ËΩΩElectronÊó•ÂøóÂ§±Ë¥•: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      async loadFile(file) {
        this.file = file;
        this.isLoading = true;
        this.updateFileInfo();
        this.showLoading();

        try {
          const fileContent = await this.readFileAsText(file);

          // Êñá‰ª∂Ê®°ÂºèÁõ¥Êé•ÊõøÊç¢ÊâÄÊúâÂÜÖÂÆπÔºå‰∏çËøõË°åÁ¥ØÂä†
          this.originalContent = fileContent;
          this.previousOriginalContent = fileContent;

          // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂàÜÂâ≤Êó•ÂøóÊù°ÁõÆÔºåÊ≠£Á°ÆÂ§ÑÁêÜÂ§öË°åÈîôËØØÂ†ÜÊ†à
          // ÂåπÈÖç‰ª•Êó∂Èó¥Êà≥ÂºÄÂ§¥ÁöÑË°å‰Ωú‰∏∫Êñ∞Êó•ÂøóÊù°ÁõÆÁöÑÂºÄÂßã
          const logEntryRegex = /(?=^\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}\])/gm;
          const logEntries = fileContent.split(logEntryRegex).filter(entry => entry.trim() !== '');

          // Ê∏ÖÁêÜÊØè‰∏™Êó•ÂøóÊù°ÁõÆÔºåÁßªÈô§ÂºÄÂ§¥ÁöÑÊç¢Ë°åÁ¨¶
          this.logLines = logEntries.map(entry => entry.trim());
          console.log(`Ëß£ÊûêÂà∞ ${this.logLines.length} ‰∏™Êó•ÂøóÊù°ÁõÆ`);
          console.log(this.logLines);

          // Â∫îÁî®ÂΩìÂâçËøáÊª§Âô®ÊòæÁ§∫ÂÜÖÂÆπ
          this.updateEditorContent(true, true); // Êñá‰ª∂Âä†ËΩΩÊó∂ÊÄªÊòØÂº∫Âà∂Êõ¥Êñ∞
          this.hideLoading();
          this.enableControls();

        } catch (error) {
          console.error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•:', error);
          this.showError('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ' + error.message);
        } finally {
          this.isLoading = false;
        }
      }

      readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
          reader.readAsText(file, 'utf-8');
        });
      }

      // Êõ¥Êñ∞ÁºñËæëÂô®ÂÜÖÂÆπÁöÑÊñπÊ≥ï
      updateEditorContent(applyFilters = false, forceUpdate = false) {
        if (applyFilters) {
          // Â¶ÇÊûúÊåáÂÆöÂ∫îÁî®ËøáÊª§Âô®ÔºåÂàô‰ΩøÁî®applyAllFiltersÊñπÊ≥ï
          this.applyAllFilters(forceUpdate);
        } else {
          // Âê¶ÂàôÁõ¥Êé•ÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπ
          const content = this.logLines.join('\n');

          // Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶ÊúâÂèòÂåñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂèòÂåñ‰∏î‰∏çÂº∫Âà∂Êõ¥Êñ∞ÔºåÂàôË∑≥Ëøá
          if (!forceUpdate && this.filteredContent === content) {
            console.log('ÂÜÖÂÆπÊó†ÂèòÂåñÔºåË∑≥ËøáÁºñËæëÂô®Êõ¥Êñ∞');
            return;
          }

          this.editor.setValue(content);
          this.filteredContent = content;
        }
      }

      // Ê£ÄÊµãÁî®Êà∑ÊòØÂê¶Âú®ÁºñËæëÂô®Â∫ïÈÉ®ÈôÑËøë
      isNearBottom() {
        if (!this.scrollSnapEnabled) {
          return false;
        }

        const scrollTop = this.editor.getScrollTop();
        const scrollHeight = this.editor.getScrollHeight();
        const clientHeight = this.editor.getLayoutInfo().height;

        // ËÆ°ÁÆóË∑ùÁ¶ªÂ∫ïÈÉ®ÁöÑË∑ùÁ¶ª
        const distanceFromBottom = scrollHeight - scrollTop - clientHeight;

        return distanceFromBottom <= this.scrollSnapThreshold;
      }

      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      scrollToBottom() {
        // ‰ΩøÁî®setTimeoutÁ°Æ‰øùÂú®DOMÊõ¥Êñ∞ÂêéÊâßË°åÊªöÂä®
        setTimeout(() => {
          const scrollHeight = this.editor.getScrollHeight();
          const clientHeight = this.editor.getLayoutInfo().height;
          const maxScrollTop = scrollHeight - clientHeight;

          console.log(`ÊªöÂä®Âà∞Â∫ïÈÉ® - scrollHeight: ${scrollHeight}, clientHeight: ${clientHeight}, maxScrollTop: ${maxScrollTop}`);

          this.editor.setScrollTop(maxScrollTop);

          // È™åËØÅÊªöÂä®ÊòØÂê¶ÊàêÂäüÔºåÂ¶ÇÊûú‰∏çÊàêÂäüÂàôÂ∞ùËØïÂ§áÁî®ÊñπÊ≥ï
          setTimeout(() => {
            const actualScrollTop = this.editor.getScrollTop();
            console.log(`ÊªöÂä®ÂêéÂÆûÈôÖ‰ΩçÁΩÆ: ${actualScrollTop}, ÁõÆÊ†á‰ΩçÁΩÆ: ${maxScrollTop}`);

            // Â¶ÇÊûúÊªöÂä®Ê≤°ÊúâÊàêÂäüÔºåÂ∞ùËØïÂ§áÁî®ÊñπÊ≥ï
            if (Math.abs(actualScrollTop - maxScrollTop) > 10) {
              console.log('‰∏ªË¶ÅÊªöÂä®ÊñπÊ≥ïÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®ÊñπÊ≥ï');
              this.scrollToBottomAlternative();
            }
          }, 50);
        }, 10);
      }

      // Â§áÁî®ÊªöÂä®Âà∞Â∫ïÈÉ®ÊñπÊ≥ï
      scrollToBottomAlternative() {
        try {
          // ÊñπÊ≥ï1Ôºö‰ΩøÁî®revealLineInCenterÊªöÂä®Âà∞ÊúÄÂêé‰∏ÄË°å
          const lineCount = this.editor.getModel().getLineCount();
          this.editor.revealLineInCenter(lineCount);
          console.log(`Â§áÁî®ÊñπÊ≥ï1ÔºöÊªöÂä®Âà∞Á¨¨${lineCount}Ë°å`);

          // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúÊñπÊ≥ï1‰∏çÂ∑•‰ΩúÔºå‰ΩøÁî®setScrollTopÁöÑÊûÅÂ§ßÂÄº
          setTimeout(() => {
            this.editor.setScrollTop(Number.MAX_SAFE_INTEGER);
            console.log('Â§áÁî®ÊñπÊ≥ï2Ôºö‰ΩøÁî®ÊûÅÂ§ßÂÄºÊªöÂä®');
          }, 100);
        } catch (error) {
          console.error('Â§áÁî®ÊªöÂä®ÊñπÊ≥ïÂ§±Ë¥•:', error);
        }
      }

      // ËøΩÂä†Êñ∞ÂÜÖÂÆπÂà∞ÁºñËæëÂô®
      appendNewContent(newLines) {
        // ÂØπÊñ∞Ë°åÂ∫îÁî®ÂΩìÂâçËøáÊª§Âô®
        let filteredNewLines = newLines;

        // Â∫îÁî®ÊêúÁ¥¢ËøáÊª§
        if (this.currentSearchQuery && this.currentSearchQuery.trim()) {
          try {
            let searchPattern;
            if (this.useRegex) {
              searchPattern = new RegExp(this.currentSearchQuery, 'gi');
            } else {
              searchPattern = new RegExp(this.currentSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            }

            filteredNewLines = filteredNewLines.filter(line => {
              return searchPattern.test(line);
            });
          } catch (error) {
            console.error('ÊêúÁ¥¢Ê≠£ÂàôË°®ËææÂºèÈîôËØØ:', error);
            const searchTerm = this.currentSearchQuery.toLowerCase();
            filteredNewLines = filteredNewLines.filter(line => {
              return line.toLowerCase().includes(searchTerm);
            });
          }
        }

        // Â∫îÁî®Êó•ÊúüËøáÊª§
        if (this.startDate || this.endDate) {
          filteredNewLines = filteredNewLines.filter(line => {
            const timestamp = this.extractTimestamp(line);
            if (!timestamp) return true;

            const logTime = new Date(timestamp);

            if (this.startDate && logTime < this.startDate) {
              return false;
            }

            if (this.endDate && logTime > this.endDate) {
              return false;
            }

            return true;
          });
        }

        // Â∫îÁî®Á∫ßÂà´ËøáÊª§
        if (this.selectedLevels.size > 0) {
          filteredNewLines = filteredNewLines.filter(line => {
            for (const level of this.selectedLevels) {
              const levelUpper = level.toUpperCase();
              const levelLower = level.toLowerCase();

              const bracketPattern = new RegExp(`\\[${levelUpper}\\]`, 'i');
              const anglePattern = new RegExp(`<${levelUpper}>`, 'i');
              const textPattern = new RegExp(`\\b${levelUpper}\\b`, 'i');
              const lowerPattern = new RegExp(`\\b${levelLower}\\b`, 'i');

              if (bracketPattern.test(line) ||
                anglePattern.test(line) ||
                textPattern.test(line) ||
                lowerPattern.test(line)) {
                return true;
              }
            }
            return false;
          });
        }

        // Â¶ÇÊûúÊúâËøáÊª§ÂêéÁöÑÊñ∞ÂÜÖÂÆπÔºåËøΩÂä†Âà∞ÁºñËæëÂô®
        if (filteredNewLines.length > 0) {
          const newContent = filteredNewLines.join('\n');
          console.log(`ÂáÜÂ§áËøΩÂä†ÂÜÖÂÆπ: ${newContent.substring(0, 100)}...`);

          // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®Â∫ïÈÉ®ÈôÑËøëÔºàÂú®Êõ¥Êñ∞ÂÜÖÂÆπÂâçÊ£ÄÊü•Ôºâ
          const wasNearBottom = this.isNearBottom();
          console.log(`Áî®Êà∑ÊòØÂê¶Âú®Â∫ïÈÉ®ÈôÑËøë: ${wasNearBottom}`);

          // Ëé∑ÂèñÂΩìÂâçÂÖâÊ†á‰ΩçÁΩÆÂíåÈÄâ‰∏≠Áä∂ÊÄÅ
          const currentSelection = this.editor.getSelection();
          const currentScrollTop = this.editor.getScrollTop();
          const currentScrollLeft = this.editor.getScrollLeft();

          // Ëé∑ÂèñÂΩìÂâçÂÜÖÂÆπÂπ∂ËøΩÂä†Êñ∞ÂÜÖÂÆπ
          const currentContent = this.editor.getValue();
          const separator = currentContent ? '\n' : '';
          const updatedContent = currentContent + separator + newContent;

          console.log(`ÂΩìÂâçÂÜÖÂÆπÈïøÂ∫¶: ${currentContent.length}, Êñ∞ÂÜÖÂÆπÈïøÂ∫¶: ${newContent.length}`);

          // ËÆæÁΩÆÊõ¥Êñ∞ÂêéÁöÑÂÜÖÂÆπ
          this.editor.setValue(updatedContent);

          // Êõ¥Êñ∞ËøáÊª§ÂêéÁöÑÂÜÖÂÆπ
          this.filteredContent = updatedContent;

          // Â∫îÁî®ÊªöÂä®Âê∏ÈôÑÈÄªËæë
          if (wasNearBottom) {
            // Â¶ÇÊûúÁî®Êà∑‰πãÂâçÂú®Â∫ïÈÉ®ÈôÑËøëÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®ÊòæÁ§∫Êñ∞ÂÜÖÂÆπ
            console.log('Â∫îÁî®ÊªöÂä®Âê∏ÈôÑÔºöÊªöÂä®Âà∞Â∫ïÈÉ®');
            this.scrollToBottom();
          } else {
            // Â¶ÇÊûúÁî®Êà∑‰∏çÂú®Â∫ïÈÉ®ÈôÑËøëÔºå‰øùÊåÅÂéüÊù•ÁöÑÊªöÂä®‰ΩçÁΩÆ
            console.log('‰øùÊåÅÁî®Êà∑ÊªöÂä®‰ΩçÁΩÆ');
            // ‰ΩøÁî®setTimeoutÁ°Æ‰øùÂú®DOMÊõ¥Êñ∞ÂêéÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
              this.editor.setScrollTop(currentScrollTop);
              this.editor.setScrollLeft(currentScrollLeft);
            }, 10);
          }

          // ÊÅ¢Â§çÁî®Êà∑ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºà‰ΩÜ‰∏çÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆÔºåÂõ†‰∏∫Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÊªöÂä®Âê∏ÈôÑÔºâ
          if (currentSelection) {
            this.editor.setSelection(currentSelection);
          }

          console.log(`ËøΩÂä†‰∫Ü ${filteredNewLines.length} Ë°åËøáÊª§ÂêéÁöÑÂÜÖÂÆπ`);
        } else {
          console.log('Ê≤°ÊúâËøáÊª§ÂêéÁöÑÊñ∞ÂÜÖÂÆπÈúÄË¶ÅËøΩÂä†');
        }
      }

      search(query) {
        this.currentSearchQuery = query;
        this.applyAllFilters(true); // Áî®Êà∑‰∏ªÂä®ÊêúÁ¥¢Êó∂Âº∫Âà∂Êõ¥Êñ∞
      }

      // Â∫îÁî®ÊâÄÊúâËøáÊª§Âô®
      applyAllFilters(forceUpdate = false) {
        let filteredLines = this.logLines;

        // ÊêúÁ¥¢ËøáÊª§
        if (this.currentSearchQuery && this.currentSearchQuery.trim()) {
          try {
            let searchPattern;
            if (this.useRegex) {
              searchPattern = new RegExp(this.currentSearchQuery, 'gi');
            } else {
              searchPattern = new RegExp(this.currentSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            }

            filteredLines = filteredLines.filter(line => {
              return searchPattern.test(line);
            });

          } catch (error) {
            console.error('ÊêúÁ¥¢Ê≠£ÂàôË°®ËææÂºèÈîôËØØ:', error);
            // Ê≠£ÂàôË°®ËææÂºèÈîôËØØÔºåÂõûÈÄÄÂà∞ÊôÆÈÄöÊêúÁ¥¢
            const searchTerm = this.currentSearchQuery.toLowerCase();
            filteredLines = filteredLines.filter(line => {
              return line.toLowerCase().includes(searchTerm);
            });
          }
        }

        // Êó•ÊúüËøáÊª§
        if (this.startDate || this.endDate) {
          filteredLines = filteredLines.filter(line => {
            const timestamp = this.extractTimestamp(line);
            if (!timestamp) return true; // Â¶ÇÊûúÊ≤°ÊúâÊó∂Èó¥Êà≥Ôºå‰øùÁïôËØ•Ë°å

            const logTime = new Date(timestamp);

            if (this.startDate && logTime < this.startDate) {
              return false;
            }

            if (this.endDate && logTime > this.endDate) {
              return false;
            }

            return true;
          });
        }

        // Á∫ßÂà´ËøáÊª§
        if (this.selectedLevels.size > 0) {
          filteredLines = filteredLines.filter(line => {
            for (const level of this.selectedLevels) {
              const levelUpper = level.toUpperCase();
              const levelLower = level.toLowerCase();

              // ÊîØÊåÅÂ§öÁßçÊó•ÂøóÊ†ºÂºè
              const bracketPattern = new RegExp(`\\[${levelUpper}\\]`, 'i');
              const anglePattern = new RegExp(`<${levelUpper}>`, 'i');
              const textPattern = new RegExp(`\\b${levelUpper}\\b`, 'i');
              const lowerPattern = new RegExp(`\\b${levelLower}\\b`, 'i');

              if (bracketPattern.test(line) ||
                anglePattern.test(line) ||
                textPattern.test(line) ||
                lowerPattern.test(line)) {
                return true;
              }
            }
            return false;
          });
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ªª‰ΩïÁ∫ßÂà´ÔºåÁ°Æ‰øù"all"ÊåâÈíÆË¢´ÈÄâ‰∏≠
          const allTag = document.querySelector(`[data-level="all"]`);
          if (allTag && !allTag.classList.contains('active')) {
            allTag.classList.add('active');
          }
        }

        // Êõ¥Êñ∞ÁºñËæëÂô®ÂÜÖÂÆπ
        const content = filteredLines.join('\n');

        // Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶ÊúâÂèòÂåñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂèòÂåñ‰∏î‰∏çÂº∫Âà∂Êõ¥Êñ∞ÔºåÂàôË∑≥Ëøá
        if (!forceUpdate && this.filteredContent === content) {
          console.log('ËøáÊª§ÂêéÂÜÖÂÆπÊó†ÂèòÂåñÔºåË∑≥ËøáÁºñËæëÂô®Êõ¥Êñ∞');
          return;
        }

        this.editor.setValue(content);
        this.filteredContent = content;

        // ‰ΩøÁî®Monaco EditorÁöÑÊêúÁ¥¢ÂäüËÉΩËøõË°åÈ´ò‰∫Æ
        if (this.currentSearchQuery) {
          this.highlightSearchInEditor(this.currentSearchQuery);
        }

        // Êõ¥Êñ∞ÊêúÁ¥¢ÁªüËÆ°
        this.updateSearchStats(filteredLines.length);
      }

      // ÊèêÂèñÊó∂Èó¥Êà≥
      extractTimestamp(line) {
        // ÂåπÈÖç [YYYY-MM-DD HH:mm:ss.sss] Ê†ºÂºè
        const timestampMatch = line.match(/\[(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:\.\d{3})?)\]/);
        if (timestampMatch) {
          return timestampMatch[1];
        }

        // ÂåπÈÖçÂÖ∂‰ªñÂ∏∏ËßÅÁöÑÊó∂Èó¥Êà≥Ê†ºÂºè
        const otherFormats = [
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?Z?)/, // ISOÊ†ºÂºè
          /(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}:\d{2})/, // YYYY/MM/DD HH:mm:ss
          /(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2})/, // MM/DD/YYYY HH:mm:ss
        ];

        for (const format of otherFormats) {
          const match = line.match(format);
          if (match) {
            return match[1];
          }
        }

        return null;
      }

      // Âú®ÁºñËæëÂô®‰∏≠È´ò‰∫ÆÊêúÁ¥¢ÂÜÖÂÆπ
      highlightSearchInEditor(query) {
        try {
          // Ê∏ÖÈô§‰πãÂâçÁöÑÊêúÁ¥¢È´ò‰∫Æ
          this.editor.getModel().findMatches('', false, true, true, null, true);

          // ÊâßË°åÊêúÁ¥¢Âπ∂È´ò‰∫ÆÊòæÁ§∫
          const matches = this.editor.getModel().findMatches(
            query,
            this.useRegex, // isRegex
            false,         // matchCase
            false,         // wholeWord
            null,          // wordSeparators
            true           // captureMatches
          );

          // Ë∑≥ËΩ¨Âà∞Á¨¨‰∏Ä‰∏™ÂåπÈÖçÈ°π
          if (matches.length > 0) {
            this.editor.setPosition(matches[0].range.getStartPosition());
            this.editor.revealLineInCenter(matches[0].range.startLineNumber);
            this.editor.setSelection(matches[0].range);
          }

        } catch (error) {
          console.error('ÁºñËæëÂô®ÊêúÁ¥¢È´ò‰∫ÆÈîôËØØ:', error);
        }
      }

      clearSearch() {
        this.currentSearchQuery = '';
        this.editor.getModel().findMatches('', false, true, true, null, true);
        this.applyAllFilters(true); // Áî®Êà∑‰∏ªÂä®Ê∏ÖÈô§ÊêúÁ¥¢Êó∂Âº∫Âà∂Êõ¥Êñ∞
      }


      updateSearchStats(count) {
        const stats = document.getElementById('searchStats');
        if (count > 0) {
          stats.textContent = `ÊâæÂà∞ ${count} ‰∏™ÂåπÈÖçÈ°π`;
        } else {
          stats.textContent = '';
        }
      }


      toggleRegex() {
        this.useRegex = !this.useRegex;
        const btn = document.getElementById('regexToggleBtn');
        if (this.useRegex) {
          btn.classList.add('active');
          btn.textContent = '.*';
          btn.title = 'Ê≠£ÂàôË°®ËææÂºèÊ®°Âºè (Â∑≤ÂêØÁî®)';
        } else {
          btn.classList.remove('active');
          btn.textContent = '.*';
          btn.title = 'ÂàáÊç¢Ê≠£ÂàôË°®ËææÂºèÊ®°Âºè';
        }

        // ÈáçÊñ∞ÊêúÁ¥¢ÂΩìÂâçÊü•ËØ¢
        const currentQuery = document.getElementById('searchInput').value;
        if (currentQuery) {
          this.search(currentQuery);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÊêúÁ¥¢Êü•ËØ¢Ôºå‰πüË¶ÅÈáçÊñ∞Â∫îÁî®ËøáÊª§Âô®
          this.applyAllFilters(true);
        }
      }


      gotoTop() {
        this.editor.setPosition({ lineNumber: 1, column: 1 });
        this.editor.revealLineInCenter(1);
      }

      gotoBottom() {
        const lineCount = this.editor.getModel().getLineCount();
        this.editor.setPosition({ lineNumber: lineCount, column: 1 });
        this.editor.revealLineInCenter(lineCount);
      }

      toggleLevelFilter(level) {
        const tag = document.querySelector(`[data-level="${level}"]`);

        if (level === 'all') {
          // ÈÄöÈÖçÁ¨¶ÊåâÈíÆÔºöÊ∏ÖÈô§ÊâÄÊúâÂÖ∂‰ªñÈÄâÊã©ÔºåÊòæÁ§∫ÊâÄÊúâÊó•Âøó
          this.selectedLevels.clear();
          document.querySelectorAll('.level-filter-tag').forEach(t => t.classList.remove('active'));
          tag.classList.add('active');
        } else {
          // ÊôÆÈÄöÁ∫ßÂà´ÊåâÈíÆ
          if (this.selectedLevels.has(level)) {
            this.selectedLevels.delete(level);
            tag.classList.remove('active');
          } else {
            this.selectedLevels.add(level);
            tag.classList.add('active');
          }

          // Â¶ÇÊûúÈÄâÊã©‰∫Ü‰ªª‰ΩïÁ∫ßÂà´ÔºåÂèñÊ∂àÈÄöÈÖçÁ¨¶ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
          if (this.selectedLevels.size > 0) {
            const allTag = document.querySelector(`[data-level="all"]`);
            allTag.classList.remove('active');
          }
        }

        this.applyLevelFilter();
      }

      applyLevelFilter() {
        this.applyAllFilters(true); // Áî®Êà∑‰∏ªÂä®ÊîπÂèòÁ∫ßÂà´ËøáÊª§Êó∂Âº∫Âà∂Êõ¥Êñ∞
      }


      updateFileInfo(customText = null) {
        const fileInfo = document.getElementById('fileInfo');
        if (customText) {
          fileInfo.textContent = customText;
        } else if (this.file) {
          const size = (this.file.size / 1024 / 1024).toFixed(2);
          fileInfo.textContent = `${this.file.name} (${size} MB)`;
        } else {
          fileInfo.textContent = 'ElectronÂ∫îÁî®Êó•Âøó';
        }
      }

      showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
      }

      hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
      }

      showError(message) {
        this.editor.setValue(`ÈîôËØØ: ${message}`);
        this.hideLoading();
      }

      enableControls() {
        const searchInput = document.getElementById('searchInput');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const regexToggleBtn = document.getElementById('regexToggleBtn');

        if (searchInput) searchInput.disabled = false;
        if (startTime) startTime.disabled = false;
        if (endTime) endTime.disabled = false;
        if (regexToggleBtn) regexToggleBtn.disabled = false;
      }

      clear() {
        this.file = null;
        this.originalContent = '';
        this.filteredContent = '';
        this.previousOriginalContent = ''; // ÈáçÁΩÆ‰∏ä‰∏ÄÊ¨°ÁöÑÂÜÖÂÆπ
        this.searchResults = [];
        this.currentSearchIndex = -1;
        this.selectedLevels.clear();

        // ÈáçÁΩÆÊó•ÂøóË°åÊï∞ÁªÑ
        this.logLines = [];
        this.currentSearchQuery = '';

        // ÈáçÁΩÆÊó•ÊúüËøáÊª§
        this.startDate = null;
        this.endDate = null;

        this.editor.setValue('');

        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('searchInput');
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const regexToggleBtn = document.getElementById('regexToggleBtn');

        if (fileInput) fileInput.value = '';
        if (searchInput) {
          searchInput.value = '';
          searchInput.disabled = true;
        }
        if (startTime) {
          startTime.value = '';
          startTime.disabled = true;
        }
        if (endTime) {
          endTime.value = '';
          endTime.disabled = true;
        }
        if (regexToggleBtn) regexToggleBtn.disabled = true;

        // ÈáçÁΩÆÊâÄÊúâÁ≠âÁ∫ßËøáÊª§Ê†áÁ≠æÔºåÈªòËÆ§ÈÄâ‰∏≠ÈÄöÈÖçÁ¨¶
        document.querySelectorAll('.level-filter-tag').forEach(tag => {
          tag.classList.remove('active');
        });
        const allTag = document.querySelector(`[data-level="all"]`);
        if (allTag) allTag.classList.add('active');

        this.updateFileInfo('ElectronÂ∫îÁî®Êó•Âøó');
        this.updateSearchStats(0);
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
          emptyState.innerHTML = `
            <p>ElectronÂ∫îÁî®Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫</p>
            <p style="font-size: 12px; margin-top: 10px; color: #666;">
              ÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÈáçÊñ∞Âä†ËΩΩÊó•Âøó
            </p>
          `;
          emptyState.style.display = 'block';
        }
      }

      // Êñ∞Â¢ûÁöÑÊñπÊ≥ï
      async clearLogs() {
        // Â¶ÇÊûúÂΩìÂâçÊòØÊñá‰ª∂Ê®°ÂºèÔºåÊèêÁ§∫Áî®Êà∑
        if (this.file) {
          alert('ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÊú¨Âú∞Êñá‰ª∂ÔºåÊó†Ê≥ïÊ∏ÖÁ©∫ElectronÊó•Âøó„ÄÇËØ∑ÂàáÊç¢Âà∞ElectronÊó•ÂøóÊ®°Âºè„ÄÇ');
          return;
        }

        if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâElectronÂ∫îÁî®Êó•ÂøóÂêóÔºü")) {
          try {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâelectronAPIÂèØÁî®
            if (!window.electronAPI || !window.electronAPI.ipcRouter) {
              throw new Error('Electron API ‰∏çÂèØÁî®');
            }

            // Ë∞ÉÁî®IPCÊ∏ÖÁ©∫Êó•Âøó
            await window.electronAPI.ipcRouter.logClearLogs();

            // Ê∏ÖÁ©∫Êú¨Âú∞Êï∞ÊçÆ
            this.clear();

            // ÈáçÊñ∞Âä†ËΩΩÊó•ÂøóÔºàÊ∏ÖÁ©∫ÂêéÈáçÊñ∞Âä†ËΩΩÔºå‰∏ç‰ΩøÁî®Á¥ØÂä†ÈÄªËæëÔºâ
            await this.loadElectronLogsInitial();

          } catch (error) {
            console.error('Ê∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•:', error);
            alert('Ê∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•: ' + error.message);
          }
        }
      }

      async exportLogs() {
        try {
          // Ê£ÄÊü•ÊòØÂê¶ÊúâelectronAPIÂèØÁî®
          if (!window.electronAPI || !window.electronAPI.ipcRouter) {
            throw new Error('Electron API ‰∏çÂèØÁî®');
          }

          // Ëé∑ÂèñË¶ÅÂØºÂá∫ÁöÑÂÜÖÂÆπ
          const data = this.filteredContent || this.originalContent;
          if (!data) {
            alert("Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊó•ÂøóÂÜÖÂÆπ");
            return;
          }

          // ÂàõÂª∫‰∏ãËΩΩ
          const blob = new Blob([data], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `electron-logs-${new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/:/g, "-")}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

        } catch (error) {
          console.error('ÂØºÂá∫Êó•ÂøóÂ§±Ë¥•:', error);
          alert('ÂØºÂá∫Êó•ÂøóÂ§±Ë¥•: ' + error.message);
        }
      }

      async refreshLogs() {
        try {
          // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâÊã©ÁöÑÊñá‰ª∂ÔºåÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂
          if (this.file) {
            await this.loadFile(this.file);
          } else {
            // Âê¶ÂàôÈáçÊñ∞Âä†ËΩΩElectronÊó•Âøó
            await this.loadElectronLogs();
          }

        } catch (error) {
          console.error('Âà∑Êñ∞Êó•ÂøóÂ§±Ë¥•:', error);
          alert('Âà∑Êñ∞Êó•ÂøóÂ§±Ë¥•: ' + error.message);
        }
      }

      startAutoRefresh() {
        if (this.autoRefreshInterval) {
          clearInterval(this.autoRefreshInterval);
        }

        this.autoRefreshInterval = setInterval(async () => {
          await this.refreshLogs();
        }, this.refreshIntervalSeconds * 1000);
      }

      stopAutoRefresh() {
        if (this.autoRefreshInterval) {
          clearInterval(this.autoRefreshInterval);
          this.autoRefreshInterval = null;
        }
      }

      toggleAutoRefresh() {
        // Â¶ÇÊûúÂΩìÂâçÊòØÊñá‰ª∂Ê®°ÂºèÔºåÊèêÁ§∫Áî®Êà∑
        if (this.file) {
          alert('ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÊú¨Âú∞Êñá‰ª∂ÔºåËá™Âä®Âà∑Êñ∞ÂäüËÉΩ‰ªÖÂú®ElectronÊó•ÂøóÊ®°Âºè‰∏ãÂèØÁî®„ÄÇ');
          return;
        }

        this.autoRefreshEnabled = !this.autoRefreshEnabled;
        const btn = document.getElementById("autoRefreshBtn");

        if (this.autoRefreshEnabled) {
          btn.textContent = "ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞";
          btn.classList.add("active");
          this.startAutoRefresh();
        } else {
          btn.textContent = "Ëá™Âä®Âà∑Êñ∞";
          btn.classList.remove("active");
          this.stopAutoRefresh();
        }
      }

      // Á™óÂè£ÊéßÂà∂ÊñπÊ≥ï
      minimizeWindow() {
        if (window.electronAPI && window.electronAPI.ipcRouter) {
          window.electronAPI.ipcRouter.windowMinimize();
        }
      }

      maximizeWindow() {
        if (window.electronAPI && window.electronAPI.ipcRouter) {
          window.electronAPI.ipcRouter.windowMaximize();
        }
      }

      closeWindow() {
        if (window.electronAPI && window.electronAPI.ipcRouter) {
          window.electronAPI.ipcRouter.windowClose();
        }
      }

      // ÂàáÊç¢ÂõûElectronÊó•ÂøóÊ®°Âºè
      async switchToElectronLogs() {
        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';

        // ÈáçÁΩÆÊñá‰ª∂ÂØπË±°
        this.file = null;

        // ÈáçÊñ∞Âä†ËΩΩElectronÊó•ÂøóÔºà‰ΩøÁî®ÂàùÂßãÂä†ËΩΩÊñπÊ≥ïÔºâ
        await this.loadElectronLogsInitial();
      }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
      new MonacoLogViewer();
    });
  </script>
</body>

</html>