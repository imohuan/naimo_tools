# 插件系统重构总结

## 重构概述

本次重构完全重新设计了插件存储系统，解决了原有 localStorage 存储的问题，并添加了完整的插件文件系统支持。

## 主要改进

### 1. 存储系统重构

**之前的问题：**

- 使用 localStorage 存储插件数据
- 存储结构复杂，包含大量冗余信息
- 插件配置和插件列表混合存储

**现在的解决方案：**

- 使用 electron-store IPC 进行存储
- 简化存储结构，只存储 `installedPlugins` 列表
- 插件配置从文件系统动态读取

### 2. 文件系统支持

**新增功能：**

- 支持从文件系统读取插件配置
- 自动扫描默认插件和用户插件目录
- 支持插件文件的动态加载

**目录结构：**

```
用户数据目录/
├── plugins/           # 用户安装的插件
│   └── plugin-name/
│       ├── config.js
│       ├── preload.js (可选)
│       └── index.html (可选)
└── app/plugins/       # 默认插件
    └── plugin-name/
        ├── config.js
        ├── preload.js (可选)
        └── index.html (可选)
```

### 3. ZIP 插件支持

**新增功能：**

- 支持从 ZIP 文件安装第三方插件
- 自动解压和验证插件
- 安全的插件安装流程

**安装流程：**

1. 用户选择 ZIP 文件
2. 系统解压到用户插件目录
3. 验证插件配置文件
4. 添加到已安装插件列表

### 4. IPC 路由扩展

**新增的 IPC 路由：**

- `filesystem-read-plugin-config` - 读取插件配置
- `filesystem-get-all-installed-plugins` - 获取所有已安装插件
- `filesystem-install-plugin-from-zip` - 从 ZIP 安装插件
- `filesystem-uninstall-plugin` - 卸载插件

## 技术实现

### 1. 主进程文件系统模块

```typescript
// src/main/ipc-router/modules/filesystem.ts
export async function getAllInstalledPlugins(): Promise<any[]>;
export async function readPluginConfig(pluginPath: string): Promise<any>;
export async function installPluginFromZip(zipPath: string): Promise<boolean>;
export async function uninstallPlugin(pluginId: string): Promise<boolean>;
```

### 2. 插件管理器重构

```typescript
// src/renderer/src/modules/plugins/config/plugin-manager.ts
export class PluginManagerImpl implements PluginManager {
  // 使用 electron-store IPC 存储
  private async getInstalledPlugins(): Promise<string[]>;
  private async saveInstalledPlugins(pluginIds: string[]): Promise<void>;

  // 从文件系统加载插件
  async loadAllPlugins(): Promise<PluginConfig[]>;
  async loadPlugin(pluginId: string): Promise<PluginConfig | null>;

  // 支持 ZIP 安装
  async installPluginFromZip(zipPath: string): Promise<boolean>;
}
```

### 3. 类型系统更新

```typescript
// src/shared/types.ts
export interface AppConfig {
  // ... 其他字段
  installedPlugins?: string[]; // 新增：已安装插件列表
}
```

## 插件开发

### 1. 插件结构

每个插件包含：

- `config.js` - 插件配置文件（必需）
- `preload.js` - 预加载脚本（可选）
- `index.html` - 自定义页面（可选）

### 2. 配置文件格式

```javascript
// config.js
module.exports = {
  id: "plugin-id",
  name: "插件名称",
  description: "插件描述",
  version: "1.0.0",
  author: "作者",
  icon: "🔌",
  category: "other",
  enabled: true,
  items: [
    {
      pluginId: "plugin-id",
      name: "项目名称",
      path: "项目路径",
      executeType: 1,
      executeParams: {},
    },
  ],
};
```

### 3. 示例插件

创建了完整的示例插件：

- `plugins/example-plugin/config.js` - 配置文件
- `plugins/example-plugin/preload.js` - 预加载脚本
- `plugins/example-plugin/index.html` - 自定义页面
- `plugins/README.md` - 使用指南

## 依赖更新

**新增依赖：**

- `yauzl` - ZIP 文件解压库
- `@types/yauzl` - TypeScript 类型定义

## 向后兼容性

**保持兼容：**

- 插件接口保持不变
- 插件执行逻辑保持不变
- 现有插件可以无缝迁移

**迁移说明：**

- 现有插件的配置格式保持不变
- 只需要将插件文件放到正确的目录结构
- 系统会自动识别和加载

## 安全考虑

**安全措施：**

- 插件代码在安全沙箱中执行
- 配置文件验证和类型检查
- 文件系统访问权限控制
- ZIP 文件解压安全检查

## 性能优化

**优化措施：**

- 插件配置按需加载
- 文件系统缓存机制
- 并行插件加载
- 减少存储数据量

## 测试建议

**测试要点：**

1. 插件安装和卸载
2. ZIP 文件安装流程
3. 插件配置验证
4. 文件系统权限
5. 错误处理和恢复

## 未来扩展

**可能的改进：**

1. 插件依赖管理
2. 插件版本控制
3. 插件市场集成
4. 插件热重载
5. 插件性能监控

## 总结

本次重构成功解决了插件存储的问题，提供了更灵活、更安全的插件系统。新的架构支持：

- ✅ 使用 electron-store IPC 存储
- ✅ 简化的存储结构
- ✅ 文件系统插件支持
- ✅ ZIP 插件安装
- ✅ 完整的示例和文档
- ✅ 向后兼容性
- ✅ 安全性保障

插件系统现在更加健壮、可扩展，为未来的功能扩展奠定了良好的基础。
